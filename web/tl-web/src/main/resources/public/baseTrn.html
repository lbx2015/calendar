<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<title>baseTrn</title>
	<link type="include" href="/common/depcss.html" />
</head>

<body class="iframeBody">
	<div class="content">
		<div class="layui-elem-field">
			<div class="group-button FL">
				<button class="layui-btn layui-btn-small layui-btn-danger ajax-all fun_ del_" id="deleteBtn" onclick="del()">
			<i class="layui-icon">&#xe640;</i> 删除
			</button>
				<button class="layui-btn layui-btn-normal layui-btn-small modal-full fun_ add_" id="add-data">
			<i class="layui-icon">&#xe608;</i> 新增
			</button>
			</div>
			<div class="_tmpl" data-url="filterCriteria.html" data-attr="baseTrn.json"  data-bind="filterCriteriaOnBind" data-param=""></div>
			<div class="clear">
			</div>
		</div>
		<div class="clear">
		</div>
		<div class="contentLeft layui-form">
			<div class="_tmpl" data-url="table.html" id="table" data-attr="baseTrn.json"  data-bind="tbOnBind" data-param="pindex=0&pcount=10"></div>
		</div>
		<div class="contentRight">
			<div class="_tmpl" data-url="preview.html" data-attr="baseTrn.json"  data-bind="previewOnBind" data-param=""></div>
		</div>
		<div style="clear: both">
		</div>
		<div class="_tmpl" data-url="pages.html" data-depend="table" data-attr="" data-bind="TmplUtils.pagesOnBind" data-param=""></div>
	</div>
</body>
<link type="include" href="/common/depjs.html" />
<script>
$(function () {
    $("#add-data").click(function () {
        layer.open({
            type: 2,
            title: '新增数据',
            shadeClose: true,
            shade: false,
            maxmin: false, //开启最大化最小化按钮
            area: ['100%', 'auto'],
            offset: '0px',
            move: false,
            content: 'baseTrnEdit.html' //iframe的url
        });
        parent.startInit(document.getElementsByTagName("iframe")[0], 560);
    });

    var form = layui.form();
    //监听提交
    form.on('submit', function (data) {
        return false;
    });
});

</script>
<script>
	var form = layui.form(), layer = layui.layer;
	//全选
	form.on('checkbox(allChoose)', function (data) {
		var child = $(data.elem).parents('table').find(
			'tbody input[type="checkbox"]');
		child.each(function (index, item) {
			item.checked = data.elem.checked;
		});
		form.render('checkbox');
	});
</script>
<script>

	Work.onSendEventBefore(function(jobEvent, job) {
		return jobEvent;
	});
	
	Work.onSendEventAfter(function(result, job) {
		View.info("job :{jobId} result：{success} ".format(result));
		View.info(result.data);
		View.fireEvent("TB_DATA_CHANGE", {});
	});
	
	Work.onDoAction(function(action, job) {
		var tar = job.getTarget();
		if("EDIT"==action){
			edit(tar.id,1);
		}else if("UPDATE"==action){
			var url = Const.apiUrl + "/baseTrns/getOther";
			View.get(url,"id=" + tar.id,function(resp) {
				if(resp){
					edit(tar.id,1);
				}else{
					TmplUtils.showMsgFail('操作失败,该数据已变更');
				}
			}, function(code) {
				TmplUtils.showMsgFail('操作失败');
			});
			
		}else if("APPROVE"==action){
			edit(tar.id,2);
		}
		
	});
	
	
	/**
	 * 对外提供事件监听
	 */
	View.setEvent("TB_DATA_CHANGE", function(arg) {
		tbTmpl.refresh("pindex=" + (TmplUtils.currPage - 1) + "&pcount="
				+ TmplUtils.pageSize + TmplUtils.searchParam);
		previewTmpl.refresh();
		if (!!arg && arg.window) {
			var index = layer.getFrameIndex(arg.window); //获取窗口索引
			layer.close(index);
		}
	});

    var item;
    var tbTmpl;
    function forbbit(id) {

    }
    function tbOnBind(attrs,param){
    	tmpl = this;
    	tbTmpl = tmpl;
    	var data = {};
    	if (param.listType == '2') {
    		if (attrs.attrs.length >= 3) {
    			attrs.attrs.splice(1, 1);
    		}
    		data.attrs = attrs.attrs;
    	}
    	tmpl.bind(function(callback) {
    		var url = Const.apiUrl + "/baseTrns/getMore";
    		var _this = this;

    		View.get(url, param, function(resp) {
    			if (resp) {
    				data.data = resp;
    				TmplUtils.totalPages = data.data.totalPages;
    				if(data.data.totalElements){
                        TmplUtils.totalCount = data.data.totalElements;
    				}else{
                        TmplUtils.totalCount = 0;
    				}
    			}
    			//是否需要全选checkbox
    			data.hasCheckbox = true;
    			data.hasOperation = true;
    			data.cellLeftCount=5
    			data.cellRightCount=3
    			data.operationWidth = 6;
				data.tdLeftWidth = [ 8, 13, 8,20,20];
				data.tdRightWidth = [8,15,15];
    			//tr的点击事件绑定，该方法会传入id 参数
    			data.trClick = "bindPro";
    			data.tdBeforeFill = function(obj) {
					
					if (obj.row > 1 && obj.col == 2) {
						var job = Work.getJob(obj.item);
						if(job){
                            var html = job.getActionsHtml();
                            return html;
						}
					}
					return obj.html;
				}
    			callback.call(_this, data);
    			if(TmplUtils.pageTmpl){
                	TmplUtils.pageTmpl.refresh();
    			}
    			TmplUtils.tableOnLoad();
    		}, function(code) {
    			TmplUtils.showMsgFail('查询出错');
    		});
    	});
    }
    //表格单元格点击事件
    function bindPro(item){
        if(!TmplUtils.isEditing){
            this.item = item;
            previewTmpl.refresh();
        }
    }

    //预览绑定
    var previewTmpl;
    function previewOnBind(attrs,param) {
        tmpl = this;
        previewTmpl = tmpl;
        if(!item){
            return;
        }
        tmpl.bind(function(callback) {
            var url = Const.apiUrl+"/baseTrns/get";
			var data={};
			//是否可编辑
			data.canEdit = true;
			data.data = item;
			if (data.data.job && data.data.job.curJobState) {
				var confirmStatus = data.data.job.curJobState;
			}
			if (confirmStatus == 'PRE_RECROD') {
				data.canEdit = true;
			} else {
				data.canEdit = false;
			}
			//绑定点击事件
			data.checkClick = "check";
			data.saveClick = "save";
			callback.call(this, data);
			TmplUtils.previewOnLoad();
        });
    }

    //查询条件绑定
    function filterCriteriaOnBind(attrs,param){
        tmpl = this;
        var _this = this;
        tmpl.bind(function (callback) {
            var data={};
            data.searchClick = "search";
            callback.call(_this, data);
            TmplUtils.filterCriteriaOnLoad();
        });
    }
    //查询
    function search(){
        TmplUtils.searchParam = Utils.formToStr("filterCriteria");
        tbTmpl.refresh("pindex=0"+"&pcount="+ TmplUtils.pageSize +TmplUtils.searchParam);
        TmplUtils.currPage = 1;
        TmplUtils.closePreview();
    }
	//弹出添加iframe
     function edit(id,state){
		var url ='baseTrnEdit.html?state='+state+'&id='+id;
   	 	var title =  "数据处理";
   	 	View.openDialog(url, title);
    }
	
   
	

	//自定义前段校验规则，可以多个
    TmplUtils.verify.desc=function(value){
        if(value.length < 5){
            return '描述至少得5个字符啊';
        }
    };
    //预览校验
    function check() {
    }

	//保存
    function save() {
        var url = Const.apiUrl + "/baseTrns/addOrUpdate";
        var baseTrn = Utils.formToObj("preview");
        View.post(url,baseTrn,function(resp){
            TmplUtils.showMsgSuccess('编辑成功');
            tbTmpl.refresh("pindex=" + (TmplUtils.currPage - 1) + "&pcount=" +  TmplUtils.pageSize + TmplUtils.searchParam);
            TmplUtils.closePreview();
        },function (){
        	TmplUtils.showMsgFail('编辑失败');
        })
        
    }

    //删除
   	function del(){
   	 var arrChk=$("input[name='tdCheckbox']");
     var ids = [];
     $(arrChk).each(function(){
         if($(this).next('div').hasClass("layui-form-checked")){
             ids.push($(this).data("id"));
         }
     });
     if (ids == "") {
		TmplUtils.showMsgFail('请选择一条或多条数据');
		return;
	 }
        TmplUtils.showConfirm('您确定删除该数据吗？','确定','取消',function () {
            var url = Const.apiUrl + "/baseTrns/delMore"
            View.post(url,ids,function(resp){
            	if(resp<=0){
            		TmplUtils.showMsgSuccess("删除成功");
            	}else{
            		TmplUtils.showMsgSuccess("有"+resp+"条数据已审核不能删除");
            	}
                tbTmpl.refresh("pindex=" + (TmplUtils.currPage - 1) + "&pcount=" +  TmplUtils.pageSize + TmplUtils.searchParam);
            },function () {
                TmplUtils.showMsgFail('删除失败');
            });
        },function(){

		});
    }
</script>
</html>