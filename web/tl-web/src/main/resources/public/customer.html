<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>客户评级</title>
<link type="include" href="/common/depcss.html" />
</head>

<body class="iframeBody">
	<div class="content">
		<div class="layui-elem-field">
			<div class="group-button FL">
				<button class="layui-btn layui-btn-small layui-btn-danger ajax-all"
					id="rate" onclick="riskRate()">开始评级</button>
				<button
					class="layui-btn layui-btn-normal layui-btn-small modal-full rateall"
					id="rateall" onclick="riskRateAll()">全部评级</button>
				&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;时间：<span id="rateTime"></span>&nbsp;&nbsp;&nbsp;状态：<span
					id="rateStatus" style='color: red'></span>
			</div>
			<div class="_tmpl" data-url="filterCriteria.html"
				data-attr="customer.json" data-bind="filterCriteriaOnBind"
				data-param=""></div>
			<div class="clear"></div>
		</div>
		<div class="clear"></div>
		<div class="contentLeft layui-form">
			<div class="_tmpl" id="table" data-url="table.html"
				data-attr="customer.json" data-bind="tbOnBind"
				data-param="pindex=0&pcount=10"></div>
		</div>
		<div class="contentRight">
			<div class="_tmpl" data-url="preview.html" data-attr="customer.json"
				data-bind="previewOnBind" data-param=""></div>
		</div>
		<div style="clear: both"></div>
		<div class="_tmpl" data-depend="table" data-url="pages.html"
			data-attr="customer.json" data-bind="TmplUtils.pagesOnBind"
			data-param=""></div>
	</div>
</body>
<link type="include" href="/common/depjs.html" />
<script>
	 var batchId = "";
	$(function() {
		var url = Const.apiUrl + "/customer/getLast";
		View.get(url, {"batchId":batchId}, function(resp) {
			$("#rateTime").html(new Date(resp.dateCreate).format("yyyy-MM-dd"));
			batchId = resp.batchId;
			var sta = resp.status;
			if (sta == 1) {
				sta = "未开始";
			} else if (sta == 2) {
				$("#rateall").addClass("layui-btn-disabled");
				$("#rate").addClass("layui-btn-disabled");
				$("#rateall").removeClass("layui-btn-normal");
				$("#rate").removeClass("layui-btn-normal");
				sta = "评级中";
				polling(1000);
			} else if (sta == 3) {
				sta = "已完成";
			} else if (sta == 4) {
				sta = "失败中止";
			} else if (sta == 5) {
				sta = "异常中止";
			}
			$("#rateStatus").html(sta);
			$("#rateStatus").html(sta);
		}, function() {
			TmplUtils.showMsgFail("加载上一次评级结果失败");
		}); 

		
		
		
		Date.prototype.format = function(fmt) { 
		     var o = { 
		        "M+" : this.getMonth()+1,                 //月份 
		        "d+" : this.getDate(),                    //日 
		        "h+" : this.getHours(),                   //小时 
		        "m+" : this.getMinutes(),                 //分 
		        "s+" : this.getSeconds(),                 //秒 
		        "q+" : Math.floor((this.getMonth()+3)/3), //季度 
		        "S"  : this.getMilliseconds()             //毫秒 
		    }; 
		    if(/(y+)/.test(fmt)) {
		            fmt=fmt.replace(RegExp.$1, (this.getFullYear()+"").substr(4 - RegExp.$1.length)); 
		    }
		     for(var k in o) {
		        if(new RegExp("("+ k +")").test(fmt)){
		             fmt = fmt.replace(RegExp.$1, (RegExp.$1.length==1) ? (o[k]) : (("00"+ o[k]).substr((""+ o[k]).length)));
		         }
		     }
		    return fmt; 
		}        
		
		
		
		
		$("#add-data").click(function() {
			layer.open({
				type : 2,
				title : '添加数据',
				shadeClose : true,
				shade : false,
				maxmin : false, //开启最大化最小化按钮
				area : [ '100%', 'auto' ],
				offset : '0px',
				move : false,
				content : 'customerEdit.html' //iframe的url
			});
			parent.startInit(document.getElementsByTagName("iframe")[0], 560);
		});

		var form = layui.form();
		//监听提交
		form.on('submit', function(data) {
			return false;
		});

	});

	function polling(t) {
		window.setTimeout(function() {
			var url = Const.apiUrl + "/customer/getLast";
			View.get(url, {"batchId":batchId}, function(resp) {
				if (resp.status == 2) {
					polling(t);
				} else {
					var sta = resp.status;
					if (sta == 1) {
						sta = "未开始";
					} else if (sta == 3) {
						sta = "评级成功";
					} else if (sta == 4) {
						sta = "评级失败";
					} else if (sta == 5) {
						sta = "评级异常，已中止";
					}
					$("#rateStatus").html(sta);
					$("#rateall").removeClass("layui-btn-disabled");
					$("#rateall").addClass("layui-btn-normal");
					$("#rate").removeClass("layui-btn-disabled");
					$("#rate").addClass("layui-btn-normal");
					TmplUtils.showMsgSuccess("全部评级完毕");
					tbTmpl.refresh();
					TmplUtils.tableOnLoad();
				}
			}, function() {
			});
		}, t)
	}
</script>
<script>
	var form = layui.form(), layer = layui.layer;
	//全选
	form.on('checkbox(allChoose)', function(data) {
		var child = $(data.elem).parents('table').find(
				'tbody input[type="checkbox"]');
		child.each(function(index, item) {
			item.checked = data.elem.checked;
		});
		form.render('checkbox');
	});

	//开始评级按钮
	function riskRate() {
		if ($("#rate").hasClass("layui-btn-disabled")) {
			return;
		}
		var arrChk = $("input[name='tdCheckbox']");
		var ids = [];
		$(arrChk).each(function() {
			if ($(this).next('div').hasClass("layui-form-checked")) {
				ids.push($(this).data("id"));
			}
		});
		var url = Const.apiUrl + "/customer/riskRate";
		View.post(url, ids, function(resp) {
			TmplUtils.showMsgSuccess('评级成功');
			tbTmpl.refresh("pindex=" + (TmplUtils.currPage - 1) + "&pcount="
					+ TmplUtils.pageSize + TmplUtils.searchParam);
		}, function(code) {
			TmplUtils.showMsgFail('评级失败');
		});
	}

	//全部评级按钮
	function riskRateAll() {
		if ($("#rateall").hasClass("layui-btn-disabled")) {
			return;
		}
		TmplUtils.showConfirm('您确定要对所有客户进行评级操作吗？', '确定', '取消', function() {
			$("#rateall").addClass("layui-btn-disabled");
			$("#rate").addClass("layui-btn-disabled");
			$("#rateall").removeClass("layui-btn-normal");
			$("#rate").removeClass("layui-btn-normal");
			var url = Const.apiUrl + "/customer/riskRateAll";
			View.post(url, "", function(resp) {
				$("#rateStatus").html("评级中");
				polling(1000);
				//doRefresh(0, resp);
				TmplUtils.showMsgSuccess("开始全部评级")
			}, function(code) {
				$("#rateall").romoveClass("layui-btn-disabled");
				$("#rateall").addClass("layui-btn-normal");
				TmplUtils.showMsgFail('评级失败');
			});
		});
	}
</script>
<script>
	var item = {};
	var tbTmpl;
	function forbbit(id) {

	}
	function tbOnBind(attrs, param) {
		tmpl = this;
		tbTmpl = tmpl;
		tmpl.bind(function(callback) {
			var url = Const.apiUrl + "/customer/getMore";
			var _this = this;
			if(param.name){
				param.enName=param.name;
				param.englishName=param.name;
			}
			View.get(url, param, function(resp) {
				var data = {};
				if (resp) {
					data.data = resp;
					TmplUtils.totalPages = data.data.totalPages;
				}
				//是否需要全选checkbox
				data.hasCheckbox = true;
				//tr的点击事件绑定，该方法会传入id 参数
				data.trClick = "bindPro";
				//是否有操作列
				data.hasOperation = true;
				//操作按钮
				data.operationWidth = 9;
				data.operations = [ {
					value : "修改",
					onclick : "edit",
					'class' : "layui-btn layui-btn-mini layui-btn-normal"
				} ];
				data.tdBeforeFill = function(obj) {
					//obj = {item,prop,html,row,col};
					//item 当前行数据
					//prop 当前单元格属性
					//html 当前单元格html内容
					//row 当前行数
					//col 当前列数
					if (obj.row >= 2) {
						if (obj.item.riskRank == '00') {
							return "<span style='color:red;'>" + obj.html
									+ "</span>";
						}
					}
					return obj.html;
				}
				callback.call(_this, data);
				if(TmplUtils.pageTmpl.refresh){
                    TmplUtils.pageTmpl.refresh();
				}
				TmplUtils.tableOnLoad();
			}, function(code) {
				TmplUtils.showMsgFail('查询出错');
			});
		});
	}
	//表格单元格点击事件
	function bindPro(item) {
		if (!TmplUtils.isEditing) {
			this.item = item;
			previewTmpl.refresh();
		}
	}

	//预览绑定
	var previewTmpl;
	function previewOnBind(attrs, param) {
		tmpl = this;
		previewTmpl = tmpl;
		if (!item) {
			return;
		}
		tmpl.bind(function(callback) {
			var data = {};
			//是否可编辑
			data.canEdit = true;
			data.data = item;
			//绑定点击事件
			data.checkClick = "check";
			data.saveClick = "save";
			if(item.id){
				var url=Const.apiUrl+"/customer/getRisk";
				View.get(url,"id="+item.id,function(resp){  
	             	for(var i=0;i<resp.length;i++){
	                   	data.enums[attrs.table].push(resp[i]);
	                } 
	             	data.checkClick = "check";
	                data.saveClick = "edit";
	                },function(code){
	                      TmplUtils.showMsgFail('查询出错');
	               }); 
			}
			
			
			callback.call(this, data);
			TmplUtils.previewOnLoad();
		});
	}

	//查询条件绑定
	function filterCriteriaOnBind(attrs, param) {
		tmpl = this;
		var _this = this;
		tmpl.bind(function(callback) {
			var data = {};
			data.searchClick = "search";
			callback.call(_this, data);
			TmplUtils.filterCriteriaOnLoad();
		});
	}
	//查询
	function search() {
		TmplUtils.searchParam = Utils.formToStr("filterCriteria");
		tbTmpl.refresh("pindex=0" + "&pcount=" + TmplUtils.pageSize
				+ TmplUtils.searchParam);
		TmplUtils.closePreview();
	}

	//翻页绑定
	/* var pageTmpl;
	function pagesOnBind(attrs, param) {
		tmpl = this;
		pageTmpl = tmpl;
		var _this = this;
		if (!TmplUtils.totalPages) {
			return;
		}
		tmpl.bind(function(callback) {
			callback.call(_this, {});
			var laypage = layui.laypage;
			laypage({
				cont : 'laypage',
				pages : TmplUtils.totalPages,
				skip : true,
				curr : TmplUtils.currPage,
				jump : function(obj, first) {
					if (!first) {
						TmplUtils.currPage = obj.curr;
						tbTmpl.refresh("pindex=" + (obj.curr - 1) + "&pcount="
								+ TmplUtils.pageSize + TmplUtils.searchParam);
						TmplUtils.closePreview();
					}
				}
			});
			TmplUtils.pagesOnload(tbTmpl);
		})
	} */
	//弹出添加iframe
	function edit(id) {
		layer.open({
			type : 2,
			title : '添加数据',
			shadeClose : true,
			shade : false,
			maxmin : false, //开启最大化最小化按钮
			area : [ '100%', 'auto' ],
			offset : '0px',
			move : false,
			content : 'customerEdit.html#' + id //iframe的url
		});
		parent.startInit(document.getElementsByTagName("iframe")[0], 560);
	}
</script>
</html>