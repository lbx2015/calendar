<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>规则引擎配置</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link href="css/frame.css" rel="stylesheet"/>
    <link rel="stylesheet" href="layui/css/layui.css" media="all">
    <link href="css/demo.css" rel="stylesheet"/>
    <link href="css/dialog.css" rel="stylesheet"/>
    <link href="css/aml.css" rel="stylesheet"/>
</head>
<style>
	.ruleEngineBox .layui-input-rel{
		display: inline-block;
	    position: relative;
	    width:150px;
	}
	.ruleEngineBox .layui-form .layui-input-rel input{
		width:100%;
		padding-right:10px;
	}
</style>
<body>
<div class="formbox ruleEngineBox">
    <div class="layui-collapse">
        <div class="layui-colla-item">
            <h2 class="layui-colla-title">规则选择</h2>
            <div class="layui-colla-content layui-show">
                <div class="layui-input-inline layui-w1" id="ruleSelect">
                </div>

                <div class="layui-input-inline layui-w2">
                    <button class="layui-btn layui-btn-small layui-btn-disabled fCondition nfCondition" data-val=">">大于</button>
                    <button class="layui-btn layui-btn-small layui-btn-disabled fCondition nfCondition" data-val="<">小于</button>
                    <button class="layui-btn layui-btn-small layui-btn-disabled fCondition nfCondition sfCondition efCondition" data-val="=">等于</button>
                    <button class="layui-btn layui-btn-small layui-btn-disabled fCondition sfCondition" data-val="like">包含</button>
					<button class="layui-btn layui-btn-small layui-btn-disabled fCondition sfCondition" data-val="like">开头</button>
                    <button class="layui-btn layui-btn-small layui-btn-disabled fConditionCon" data-val="and">并且</button>
                    <br>
                    <button class="layui-btn layui-btn-small layui-btn-disabled fCondition nfCondition" data-val=">=">大于等于</button>
                    <button class="layui-btn layui-btn-small layui-btn-disabled fCondition nfCondition" data-val="<=">小于等于</button>
                    <button class="layui-btn layui-btn-small layui-btn-disabled fCondition nfCondition sfCondition efCondition" data-val="<>">不等于</button>
                    <button class="layui-btn layui-btn-small layui-btn-disabled fCondition sfCondition" data-val="not like">不包含</button>
					<button class="layui-btn layui-btn-small layui-btn-disabled fCondition sfCondition" data-val="like">结尾</button>
                    <button class="layui-btn layui-btn-small layui-btn-disabled fConditionCon" data-val="or">或者</button>
                </div>
                <div class="layui-input-inline layui-w1">
                    <textarea name="desc" placeholder="人工输入数据" maxlength="1000" class="layui-textarea" disabled="disabled" id="dataTextarea"></textarea>
                    <div id="enumSelectDiv" style="display: none;">
                    </div>
                </div>
                <button class="layui-btn layui-btn-disabled apply_create" id="generate">生成</button>
                <button class="layui-btn layui-btn-disabled apply_create" id="cback">后退</button>
            </div>
        </div>
        <div class="layui-colla-item">
            <h2 class="layui-colla-title">规则分支</h2>
            <div class="layui-colla-content layui-show">
                <div class="layui-input-inline  layui-w3">
                    <textarea name="desc" placeholder="" class="layui-textarea" id="crTextarea" readonly></textarea>
                </div>
                <div class="layui-input-inline layui-w2">
                    <button class="layui-btn layui-btn-small layui-btn-disabled sConditionCon" data-val="and">并且</button>
                    <br>
                    <button class="layui-btn layui-btn-small layui-btn-disabled sConditionCon" data-val="or">或者</button>
                </div>
                <button id="add" class="layui-btn layui-btn-disabled apply_add">添加</button>
            </div>
        </div>
        <div class="layui-colla-item">
            <h2 class="layui-colla-title">最终规则</h2>
            <div class="layui-colla-content layui-show">
                <div class="layui-form formb2">
                	<div class="layui-inline">
						<label class="layui-form-label">规则编号：</label>
	                    <div class="layui-input-inline">
	                        <input type="text" name="title" lay-verify="title" autocomplete="off" placeholder="规则编号" id="ruleNo" class="layui-input">
	                    </div>
	                </div>
	                <div class="layui-inline">
						<label class="layui-form-label">规则名称：</label>
	                    <div class="layui-input-inline">
	                        <input type="text" name="title" lay-verify="title" autocomplete="off" placeholder="规则名称" id="ruleName" class="layui-input">
	                    </div>
	                </div>
	                <div class="layui-inline">
						<label class="layui-form-label">采集类型：</label>
	                    <div class="layui-input-inline">
	                        <select name="quiz1" id="type">
	                            <option value="">采集类型</option>
	                            <option value="1" >大额</option>
	                            <option value="2">可疑</option>
	                        </select>
	                    </div>
	                </div>
	                <div class="layui-inline">
						<label class="layui-form-label">使用状态：</label>
	                    <div class="layui-input-inline">
	                        <select name="quiz1" id="enabled">
	                            <option value="">使用状态</option>
	                            <option value="1" >可用</option>
	                            <option value="2">不可用</option>
	                        </select>
	                    </div>
	                </div>
	                <div class="layui-inline">
						<label class="layui-form-label">创建人：</label>
	                    <div class="layui-input-inline">
	                        <input type="text" name="title" lay-verify="title" id="personCreate" autocomplete="off" placeholder="创建人" class="layui-input">
	                    </div>
	                </div>
	                <div class="layui-inline">
						<label class="layui-form-label">修改人：</label>
	                    <div class="layui-input-inline">
	                        <input type="text" name="title" lay-verify="title" id="personModify" autocomplete="off" placeholder="修改人"  class="layui-input">
	                    </div>
	                </div>
					<div class="layui-inline">
						<label class="layui-form-label">对公/对私：</label>
						<div class="layui-input-inline">
							<select name="khlx" id="khlx">
								<option value="">对公/对私</option>
								<option value="1">对公</option>
								<option value="2">对私</option>
								<option value="3">全部</option>
							</select>
						</div>
					</div>
                </div>
                <textarea name="desc" placeholder="" class="layui-textarea" id="finalRuleTextarea" readonly></textarea>
                 <form class="layui-form layui-form-style add-formbox" style="padding-bottom:0px">
                <div id="sqlName" class="sqlName">
						 <div class="layui-form-item">

						 </div>
				    </div>
				  </form>
            </div>
        </div>
        <div class="layui-colla-item">
            <h2 class="layui-colla-title">总规则</h2>
            <div class="layui-colla-content layui-show">
                 <form id='diy' name='diy' class="layui-form layui-form-style add-formbox">
                 	<div class="layui-form-item layui-checkbox-all">
                 		<input type="checkbox" name="sameCounterparties" lay-skin="primary"  title="包含相同交易对手">
                 	</div>
		        	<div class="layui-form-item">
					    <div class="layui-inline">
					      <label class="layui-form-label">交易区间：</label>
					      <div class="layui-input-inline">
					        T - <div class="layui-input-rel"><input type="text" name='dateRange' placeholder="请输入天数" class="layui-input" /></div>  ~ T 
					      </div>
					    </div>
					    <div class="layui-inline layui-inline-w">
					    	 
					    </div>
					     <div class="layui-inline">
					      <label class="layui-form-label">连续天数：</label>
					      <div class="layui-input-inline">
					      	 <input type="text" name='continuousDays' placeholder="请输入连续交易的天数"  class="layui-input"/>
					      </div>
					    </div>
						
					 </div>
					 <div class="layui-form-item">
						 <div class="layui-inline">
							 <label class="layui-form-label">总交易笔数：</label>
							 <div class="layui-input-inline">
								 <select name="totalCountCondition"> <option value="="> = </option><option value=">"> > </option> <option value=">="> >= </option> <option value="<"> < </option><option value="<="> <= </option></select>
								 <div class="layui-input-rel"><input type="text" name='totalCount' placeholder="请输入收入的笔数"  class="layui-input" /></div>
							 </div>
						 </div>
						 <div class="layui-inline layui-inline-w">
						 </div>
						 <div class="layui-inline">
							 <label class="layui-form-label">间隔天数：</label>
							 <div class="layui-input-inline">
								 <select name="intervalDaysCondition"> <option value="="> = </option><option value=">"> > </option> <option value=">="> >= </option> <option value="<"> < </option><option value="<="> <= </option></select>
								 <div class="layui-input-rel"><input type="text" name='intervalDays' placeholder="请输入支出的笔数"  class="layui-input"/></div>
							 </div>
						 </div>
					 </div>
					 <div class="layui-form-item">
					 	<div class="layui-inline">
					      <label class="layui-form-label">收入笔数：</label>
					      <div class="layui-input-inline">
					        <select name="creditCountCondition"> <option value="="> = </option><option value=">"> > </option> <option value=">="> >= </option> <option value="<"> < </option><option value="<="> <= </option></select>
					        <div class="layui-input-rel"><input type="text" name='creditCount' placeholder="请输入收入的笔数"  class="layui-input" /></div>
					      </div>
					    </div>
					    <div class="layui-inline layui-inline-w">
					    	<select name="debitCreditCountAndor"><option value="and"> 并且 </option><option value="or"> 或者 </option></select>
					    </div>
					    <div class="layui-inline">
					      <label class="layui-form-label">支出笔数：</label>
					      <div class="layui-input-inline">
					        <select name="debitCountCondition"> <option value="="> = </option><option value=">"> > </option> <option value=">="> >= </option> <option value="<"> < </option><option value="<="> <= </option></select>
					        <div class="layui-input-rel"><input type="text" name='debitCount' placeholder="请输入支出的笔数"  class="layui-input"/></div>
					      </div>
					    </div>
					 </div>
					 <div class="layui-form-item">
					 	<div class="layui-inline">
					      <label class="layui-form-label">人民币收入限额：</label>
					      <div class="layui-input-inline">
					        <select name="creditAmountCondition"> <option value="="> = </option><option value=">"> > </option> <option value=">="> >= </option> <option value="<"> < </option><option value="<="> <= </option></select>
					        <div class="layui-input-rel"><input type="text" name='creditAmount' placeholder="请输入人民币收入限额"  class="layui-input"/></div>
					      </div>
					    </div>
					    <div class="layui-inline layui-inline-w">
					    	<select name="debitCreditAmountAndor"> <option value="and"> 并且 </option><option value="or"> 或者 </option></select>
					    </div>
					    <div class="layui-inline">
					      <label class="layui-form-label">人民币支出限额：</label>
					      <div class="layui-input-inline">
					        <select name="debitAmountCondition"> <option value="="> = </option><option value=">"> > </option> <option value=">="> >= </option> <option value="<"> < </option><option value="<="> <= </option></select>
					        <div class="layui-input-rel"><input type="text" name='debitAmount' placeholder="请输入人民币支出限额"  class="layui-input"/></div>
					      </div>
					    </div>
					 </div>
					 <div class="layui-form-item">
						 <div class="layui-inline">
							 <label class="layui-form-label">美元收入限额：</label>
							 <div class="layui-input-inline">
								 <select name="dollarCreditAmountCondition"> <option value="="> = </option><option value=">"> > </option> <option value=">="> >= </option> <option value="<"> < </option><option value="<="> <= </option></select>
								 <div class="layui-input-rel"><input type="text" name='dollarCreditAmount' placeholder="请输入美元收入限额"  class="layui-input"/></div>
							 </div>
						 </div>
						 <div class="layui-inline layui-inline-w">
							 <select name="dollarDebitCreditAmountAndor"> <option value="and"> 并且 </option><option value="or"> 或者 </option></select>
						 </div>
						 <div class="layui-inline">
							 <label class="layui-form-label">美元支出限额：</label>
							 <div class="layui-input-inline">
								 <select name="dollarDebitAmountCondition"> <option value="="> = </option><option value=">"> > </option> <option value=">="> >= </option> <option value="<"> < </option><option value="<="> <= </option></select>
								 <div class="layui-input-rel"><input type="text" name='dollarDebitAmount' placeholder="请输入美元支出限额"  class="layui-input"/></div>
							 </div>
						 </div>
					 </div>
					 <div class="layui-form-item">
					 	<div class="layui-inline">
					      <label class="layui-form-label">收入/支出：</label>
					      <div class="layui-input-inline">
					        <select name="creditDebitPercentCondition"> <option value="="> = </option><option value=">"> > </option> <option value=">="> >= </option> <option value="<"> < </option><option value="<="> <= </option></select>
					        <div class="layui-input-rel"><input type="text" name='creditDebitPercent' placeholder="请输入收入支出比"  class="layui-input" /></div>
					      </div>
					    </div>
					    <div class="layui-inline layui-inline-w">
					    	<select name="debitCreditPercentAndor"> <option value="and"> 并且 </option><option value="or"> 或者 </option></select>
					    </div>
					    <div class="layui-inline">
					      <label class="layui-form-label">支出/收入：</label>
					      <div class="layui-input-inline">
					        <select name="debitCreditPercentCondition"> <option value="="> = </option><option value=">"> > </option> <option value=">="> >= </option> <option value="<"> < </option><option value="<="> <= </option></select>
					        <div class="layui-input-rel"><input type="text" name='debitCreditPercent' placeholder="请输入支出收入比"  class="layui-input" /></div>
					      </div>
					    </div>
					 </div>
		        </form>
            </div>
        </div>
        
    </div>
</div>
<link type="include" href="/common/depjs.html" />
<script>
    layui.use(['element', 'layer'], function(){
        var element = layui.element();
        var layer = layui.layer;
        //监听折叠
        element.on('collapse(test)', function(data){
        });
    });

    layui.use(['form', 'layedit', 'laydate'], function(){
        var form = layui.form()
            ,layer = layui.layer
            ,layedit = layui.layedit
            ,laydate = layui.laydate;
    });

</script>
</body>
</html>
<script type="text/tmpl" id="select">
        <select size="4" class="select-control" id="propSelect">
{{# layui.each(d.list, function(index, item){ }}
     <option value="{{ item.coder }}" data-type="{{ item.propType }}" data-code="{{ item.rulePropCode }}">{{ item.rulePropName }}</option>
{{# }); }}
        </select>
</script>
<script type="text/tmpl" id="enumSelectTmpl">
        <select size="4" class="select-control" id="enumSelect">
{{# layui.each(d.list, function(index, item){ }}
<option value="{{ item.ke }}">{{ item.valu }}</option>
{{# }); }}
</select>
</script>

<script>
	var hash = window.location.hash.replace("#","");
    var id;
    var isShow;
    if(hash){
        id = window.location.hash.replace("#","").split("_")[0];
        isShow = window.location.hash.replace("#","").split("_")[1];
	}
    $(document).ready(function() {
        var tp = new View.Tmpl({
            "container" : $("#ruleSelect"),
            "tmpl" : $("#select").html(),
            "attr" : ""
        });
        tp.onload(function(attrs, param) {
            tp.bind(function(callback) {
                var url = Const.apiUrl + "/amlRuleEngine/getAllPropCodeList";
                var _this = this;
                View.get(url,"",function (resp) {
                    var data = {};
                    data.list = resp;
                    callback.call(_this, data);
                    selectOnload();
                },function () {
                     TmplUtils.showMsgFail("规则参数加载失败");
                });
            });
        }, "");

        if(id){
            var url = Const.apiUrl + "/amlRuleEngine/get";
            View.get(url,"id="+id,function(resp){
                $("#ruleNo").val(resp.ruleNo);
                $("#ruleName").val(resp.ruleName);
                $("#type").val(resp.type)
				$("#enabled").val(resp.enabled);
                $("#personCreate").val(resp.personCreate);
                $("#personModify").val(resp.personModify);
                $("#fz").val(resp.fz);
                $("#khlx").val(resp.khlx);
                sqlName = resp.ruleExpressName;
                setfinalRuleTextarea();
                $("#diy").find("input,select").each(function () {
                    if($(this).attr("name") != "sameCounterparties"){
                        $(this).val(resp[$(this).attr("name")]);
					}
                });
                if(resp["sameCounterparties"] == "01"){
                    $("input[name=sameCounterparties]").attr("checked",true);
				}
				if(resp["blackProps"]){
                    var blackProps = resp["blackProps"].split(",");
                    for(var i=0; i<blackProps.length; i++){
                        if(!blackProps[i]){
                            continue;
						}
                        $("input[name="+blackProps[i]+"]").attr("checked",true);
					}
				}
                var getAllStcrCrcdUrl = Const.apiUrl + "/amlRuleEngine/getAllStcrCrcd";
                View.get(getAllStcrCrcdUrl,"",function(respData){
                    for(var i=0; i<respData.length; i++){
                        $("#stcrCrcd").append("<option value='"+respData[i].ke+"'>"+respData[i].valu+"</option>");
					}
                    $("#stcrCrcd").val(resp.stcrCrcd);
                    if(isShow&& isShow =="1"){
                        $("button").addClass("layui-btn-disabled");
                        $("button").removeClass("layui-btn-normal");
                        $("input").attr("readonly",true);
                        $("textarea").attr("readonly",true);
                        $("select").attr("disable",true);
					}
                    selectLoad();
                    layui.form().render();
				},function () {
                });
            },function () {
                TmplUtils.showMsgFail("规则加载失败");
            });
        }else{
            var getAllStcrCrcdUrl = Const.apiUrl + "/amlRuleEngine/getAllStcrCrcd";
            View.get(getAllStcrCrcdUrl,"",function(respData){
                for(var i=0; i<respData.length; i++){
                    $("#stcrCrcd").append("<option value='"+respData[i].ke+"'>"+respData[i].valu+"</option>");
                }
                layui.form().render();
                selectLoad();
            },function () {
            });
		}
    });
</script>

<script>
    var propName = "";//属性中文名
    var conditionName = "";//条件中文名
    var sconditionName =""; //二级条件中文名

    var csqlName = ""//子条件查询中文
    var sqlName=""//条件查询中文

    var type = "";

    var copList = [];

    function showOrHideConditionButtonByType(status){
        if(type){
            if(status == 2){
                $(".fCondition").removeClass("layui-btn-disabled");
                $(".fCondition").addClass("layui-btn-normal");
                if(type == "string"){
                    $(".sfCondition").addClass("layui-btn-disabled");
                    $(".sfCondition").removeClass("layui-btn-normal");
                }
                if(type == "number"){
                    $(".nfCondition").addClass("layui-btn-disabled");
                    $(".nfCondition").removeClass("layui-btn-normal");
                }
                if(type == "enum"){
                    $(".efCondition").addClass("layui-btn-disabled");
                    $(".efCondition").removeClass("layui-btn-normal");
                }
            }else if(status == 1){
                $(".fCondition").addClass("layui-btn-disabled");
                $(".fCondition").removeClass("layui-btn-normal");
                if(type == "string"){
                    $(".sfCondition").removeClass("layui-btn-disabled");
                    $(".sfCondition").addClass("layui-btn-normal");
                }
                if(type == "number"){
                    $(".nfCondition").removeClass("layui-btn-disabled");
                    $(".nfCondition").addClass("layui-btn-normal");
                }
                if(type == "enum"){
                    $(".efCondition").removeClass("layui-btn-disabled");
                    $(".efCondition").addClass("layui-btn-normal");
                }
            }
        }
    }

    function selectOnload() {
        $("#propSelect").change(function () {
            var optionSelected = $(this).find('option:selected');
            propName = optionSelected.text();
            type = optionSelected.data("type");
            showOrHideConditionButtonByType(1);
            if(type != "enum"){
                $("#enumSelectDiv").hide();
                $("#dataTextarea").show();
            }else{
                showEnumSelect(optionSelected.data("code").toUpperCase());
            }
        });
    }

    $(".fCondition").click(function(){
        if($(this).hasClass("layui-btn-disabled")){
            return;
        }
        conditionName = $(this).text();
        if(type == "string"){
            $(".sfCondition").addClass("layui-btn-normal");
        }
        if(type == "number"){
            $(".nfCondition").addClass("layui-btn-normal");
        }
        if(type == "enum"){
            $(".efCondition").addClass("layui-btn-normal");
        }
        $(this).removeClass("layui-btn-normal");
        $("#dataTextarea").attr("disabled",false);
        $("#enumSelect").attr("disabled",false);
    });
     var tempfConditionConName = "";
    $(".fConditionCon").click(function(){
        if($(this).hasClass("layui-btn-disabled")){
            return;
        }
        if(tempfConditionConName != ""){
            csqlName = csqlName.substring(0,csqlName.lastIndexOf("*"+tempfConditionConName+"*"));
        }
        tempfConditionConName= $(this).text();
        csqlName = csqlName + "*" + tempfConditionConName+ "*" + " ";
        $("#crTextarea").val(csqlName.replace(/@/g,"").replace(/\*/g,"").replace(/#/g,"").replace(/\$/g,"").replace(/,/g,""));
        $(".fConditionCon").addClass("layui-btn-normal");
        $(this).removeClass("layui-btn-normal");
        $(".sConditionCon").addClass("layui-btn-disabled");
        $(".sConditionCon").removeClass("layui-btn-normal");
        $("#add").addClass("layui-btn-disabled");
        $("#add").removeClass("layui-btn-normal");
        $("#propSelect").attr("disabled",false);
        $("#cback").addClass("layui-btn-disabled");
        $("#cback").removeClass("layui-btn-normal");
    });

    $(".sConditionCon").click(function(){
        if($(this).hasClass("layui-btn-disabled")){
            return;
        }
        if(sconditionName !=""){
            sqlName = sqlName.substring(0,sqlName.lastIndexOf("*"+sconditionName+"*"));
        }
        sconditionName = $(this).text();
        sqlName = sqlName + "*" +sconditionName + "*" + " ";
        setfinalRuleTextarea();
        $("#add").removeClass("layui-btn-disabled");
        $("#add").addClass("layui-btn-normal");
    });

    $("#generate").click(function(){
        if($(this).hasClass("layui-btn-disabled")){
            return;
        }
        var name;
        if(type == "enum"){
            name = "'#" + $("#enumSelect option:selected").text() + "#'";
        }else if(type == "string"){
            if(conditionName=="包含"||conditionName=="不包含"){
                name = "'%" + $("#dataTextarea").val() + "%'"
            }else if(conditionName=="开头"){
                name = "'" +$("#dataTextarea").val() +"%'";
            }else if(conditionName=="结尾"){
                name = "'%" +$("#dataTextarea").val() +"'";
			}else{
                name = "'" +$("#dataTextarea").val() +"'";
			}
        }else if(type="number"){
            name = $("#dataTextarea").val();
        }
        var cop = {};
        if(tempfConditionConName !=""){
            cop.name = "*" + tempfConditionConName +"* "+ " $" + propName + "$ @" +  conditionName + "@ " + name + " ";
        }else{
            cop.name = " $" + propName + "$ @" +  conditionName + "@ " + name + " ";
        }
        copList.push(cop);
        csqlName = csqlName + " $" + propName + "$ @" +  conditionName + "@ " + name + " ";
        $("#crTextarea").val(csqlName.replace(/@/g,"").replace(/\*/g,"").replace(/#/g,"").replace(/\$/g,"").replace(/,/g,""));
        $("#dataTextarea").val("");
        propName = "";
        conditionName = "";
        tempfConditionConName = "";
        $(".fCondition").addClass("layui-btn-disabled");
        $(".fConditionCon").removeClass("layui-btn-disabled");
        $(".fConditionCon").addClass("layui-btn-normal");
        $("#generate").addClass("layui-btn-disabled");
        $("#generate").removeClass("layui-btn-normal");
        if($("#finalRuleTextarea").val().trim() != ""){
            $(".sConditionCon").removeClass("layui-btn-disabled");
            $(".sConditionCon").addClass("layui-btn-normal");
        }else{
            $("#add").removeClass("layui-btn-disabled");
            $("#add").addClass("layui-btn-normal");
        }
        $("#propSelect").attr("disabled",true);
        $("#dataTextarea").attr("disabled",true);
        $("#enumSelect").attr("disabled","disabled");

        $("#cback").removeClass("layui-btn-disabled");
        $("#cback").addClass("layui-btn-normal");
    });

    $("#dataTextarea").bind("input propertychange",function(){
        if($(this).val().trim() != ""){
            $(".layui-btn-normal").addClass("layui-btn-disabled");
            $(".layui-btn-normal").removeClass("layui-btn-normal");
            $("#generate").removeClass("layui-btn-disabled");
            $("#generate").addClass("layui-btn-normal");
            $(".fConditionCon").addClass("layui-btn-disabled");
            $(".fConditionCon").removeClass("layui-btn-normal");
            $("#propSelect").attr("disabled","disabled");
        }else{
            $("#generate").addClass("layui-btn-disabled");
            $("#generate").removeClass("layui-btn-normal");
            $("#propSelect").attr("disabled",false);
            if(type == "string"){
                $(".sfCondition").each(function(){
                    if($(this).hasClass("layui-btn-disabled")){
                        $(this).addClass("layui-btn-normal");
                        $(this).removeClass("layui-btn-disabled");
                    }
                });
            }
            if(type == "number"){
                $(".nfCondition").each(function(){
                    if($(this).hasClass("layui-btn-disabled")){
                        $(this).addClass("layui-btn-normal");
                        $(this).removeClass("layui-btn-disabled");
                    }
                });
            }
        }
    });
    $("#add").click(function(){
        if($(this).hasClass("layui-btn-disabled")){
            return;
        }
        sqlName = sqlName + "(" +csqlName + ") " +",";
        csqlName = "";
        sconditionName = "";
        $("#crTextarea").val("");
        setfinalRuleTextarea();
        $("#add").addClass("layui-btn-disabled");
        $("#add").removeClass("layui-btn-normal");
        $(".sConditionCon").addClass("layui-btn-disabled");
        $(".sConditionCon").removeClass("layui-btn-normal");

        $(".fConditionCon").addClass("layui-btn-disabled");
        $(".fConditionCon").removeClass("layui-btn-normal");

        $("#propSelect").attr("disabled",false);
    });
    function save(){
        var amlRuleEngine = {};
        amlRuleEngine.ruleName = $("#ruleName").val();
        amlRuleEngine.ruleNo = $("#ruleNo").val();
        amlRuleEngine.type = $("#type").val();
        amlRuleEngine.enabled=$("#enabled").val();
        for(var prop in amlRuleEngine){
            if(!amlRuleEngine[prop]){
                TmplUtils.showMsgFail("规则配置不能为空");
                return;
            }
        }
        amlRuleEngine.ruleExpressName = sqlName;
        amlRuleEngine.stcrCrcd = $("#stcrCrcd").val();
        amlRuleEngine.personCreate = $("#personCreate").val();
        amlRuleEngine.personModify = $("#personModify").val();
        amlRuleEngine.fz = $("#fz").val();
        amlRuleEngine.khlx = $("#khlx").val();
        var editForms = $("form[name=diy]");
        editForms.each(function() {
            $.extend(amlRuleEngine, Utils.formToObj($(this).attr('id')));
        });
        amlRuleEngine.crimeTypeId = parent.crimeTypeId;
        if($("input[name=sameCounterparties]").is(':checked')){
            amlRuleEngine.sameCounterparties = "01";
		}else{
            amlRuleEngine.sameCounterparties = "02";
		}
        if(1==amlRuleEngine.type){
			if(amlRuleEngine.creditCount && !amlRuleEngine.debitCount){
			    if(!amlRuleEngine.creditAmount && amlRuleEngine.debitAmount){
                    TmplUtils.showMsgFail("可疑规则配置支出收入不匹配");
                    return;
				}
                if(!amlRuleEngine.creditDebitPercent && amlRuleEngine.debitCreditPercent){
                    TmplUtils.showMsgFail("可疑规则配置支出收入不匹配");
                    return;
                }
                if(!amlRuleEngine.dollarCreditAmount && amlRuleEngine.dollarDebitAmount){
                    TmplUtils.showMsgFail("可疑规则配置支出收入不匹配");
                    return;
                }
			}
            if(!amlRuleEngine.creditCount && amlRuleEngine.debitCount){
                if(amlRuleEngine.creditAmount && !amlRuleEngine.debitAmount){
                    TmplUtils.showMsgFail("可疑规则配置支出收入不匹配");
                    return;
                }
                if(amlRuleEngine.creditDebitPercent && !amlRuleEngine.debitCreditPercent){
                    TmplUtils.showMsgFail("可疑规则配置支出收入不匹配");
                    return;
                }
                if(amlRuleEngine.dollarCreditAmount && !amlRuleEngine.dollarDebitAmount){
                    TmplUtils.showMsgFail("可疑规则配置支出收入不匹配");
                    return;
                }
            }
            if(amlRuleEngine.creditAmount && !amlRuleEngine.debitAmount){
                if(amlRuleEngine.creditDebitPercent && !amlRuleEngine.debitCreditPercent){
                    TmplUtils.showMsgFail("可疑规则配置支出收入不匹配");
                    return;
                }
                if(amlRuleEngine.dollarCreditAmount && !amlRuleEngine.dollarDebitAmount){
                    TmplUtils.showMsgFail("可疑规则配置支出收入不匹配");
                    return;
                }
            }
            if(!amlRuleEngine.creditAmount && amlRuleEngine.debitAmount){
                if(!amlRuleEngine.creditDebitPercent && amlRuleEngine.debitCreditPercent){
                    TmplUtils.showMsgFail("可疑规则配置支出收入不匹配");
                    return;
                }
                if(amlRuleEngine.dollarCreditAmount && !amlRuleEngine.dollarDebitAmount){
                    TmplUtils.showMsgFail("可疑规则配置支出收入不匹配");
                    return;
                }
            }
            if(amlRuleEngine.creditDebitPercent && !amlRuleEngine.debitCreditPercent){
                TmplUtils.showMsgFail("可疑规则配置支出收入不匹配");
                if(!amlRuleEngine.dollarCreditAmount && amlRuleEngine.dollarDebitAmount){
                    TmplUtils.showMsgFail("可疑规则配置支出收入不匹配");
                    return;
                }
                return;
            }
            if(!amlRuleEngine.creditDebitPercent && amlRuleEngine.debitCreditPercent){
                TmplUtils.showMsgFail("可疑规则配置支出收入不匹配");
                if(amlRuleEngine.dollarCreditAmount && !amlRuleEngine.dollarDebitAmount){
                    TmplUtils.showMsgFail("可疑规则配置支出收入不匹配");
                    return;
                }
                return;
            }
		}
        if(id){
            amlRuleEngine.id = id;
        }else{
            amlRuleEngine.enabled = 1;
        }
        var url = Const.apiUrl + "/amlRuleEngine/addOrUpdate";
        View.post(url,amlRuleEngine,function () {
            TmplUtils.showMsgSuccess("保存成功");
            parent.tbTmpl.refresh("pindex="+(parent.TmplUtils.currPage-1)+"&pcount="+parent.TmplUtils.pageSize+parent.TmplUtils.searchParam);
            parent.previewTmpl.refresh();
            parent.TmplUtils.closePreview();
            var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
            parent.layer.close(index);
        },function () {
            TmplUtils.showMsgFail("保存失败");
        });
    }

    var tpenum;
    function showEnumSelect(ke){
        $("#enumSelectDiv").html("");
        tpenum = new View.Tmpl({
            "container" : $("#enumSelectDiv"),
            "tmpl" : $("#enumSelectTmpl").html(),
            "attr" : ""
        });
        tpenum.onload(function(attrs, param) {
            tpenum.bind(function(callback) {
                var url = Const.apiUrl + "/modelPropdict/T_MODEL_AML_CORPTRN";
                var _this = this;
                View.post(url,[ke],function (resp) {
                    var data = {};
                    data.list = resp;
                    callback.call(_this, data);
                    $("#enumSelectDiv").show();
                    $("#dataTextarea").hide();
                    enumSelectLoad();
                },function () {
                    TmplUtils.showMsgFail("规则参数加载失败");
                });
            });
        }, "");
    }
    function enumSelectLoad(){
        $("#enumSelect").attr("disabled","disabled");
        $("#enumSelect").change(function () {
            $(".layui-btn-normal").addClass("layui-btn-disabled");
            $(".layui-btn-normal").removeClass("layui-btn-normal");
            $(".fConditionCon").addClass("layui-btn-disabled");
            $(".fConditionCon").removeClass("layui-btn-normal");
            $("#generate").removeClass("layui-btn-disabled");
            $("#generate").addClass("layui-btn-normal");
            $("#propSelect").attr("disabled","disabled");
        });
    }
    $("#cback").click(function(){
        if($(this).hasClass("layui-btn-disabled")){
            return;
        }
        if(copList.length > 0){
            var cop = copList[copList.length-1];
            csqlName = csqlName.substring(0,csqlName.lastIndexOf(cop.name));
            $("#crTextarea").val(csqlName.replace(/@/g,"").replace(/\*/g,"").replace(/#/g,"").replace(/\$/g,"").replace(/,/g,""));
            var cop = copList.splice(copList.length-1,1);
            if(csqlName.trim().length == 0){
                $("#add").addClass("layui-btn-disabled");
                $("#add").removeClass("layui-btn-normal");
            }
            $(".sConditionCon").addClass("layui-btn-disabled");
            $(".sConditionCon").removeClass("layui-btn-normal");
            $(".fConditionCon").addClass("layui-btn-disabled");
            $(".fConditionCon").removeClass("layui-btn-normal");
            $("#propSelect").attr("disabled",false);
        }
    });

    function setfinalRuleTextarea(){
        $("#sqlName").html("");
        var sqlNameList = [];
        try{
            sqlNameList = sqlName.split(",");
        }catch (e){

		}
        var htmlStr = "";

        for(var i=0; i< sqlNameList.length; i++){
            if(sqlNameList[i].trim() != ""){
                //htmlStr += '<div><span>'+ sqlNameList[i].replace(/@/g,"").replace(/\*/g,"").replace(/#/g,"").replace(/\$/g,"").replace(/,/g,"") + '</span><button onclick="delSql(this);" data-sql="'+sqlNameList[i]+',">'+'移除</button></div>';
                htmlStr += '<div class="layui-inline"> <div class="layui-input-inline"> <input type="text" value="'+ sqlNameList[i].replace(/@/g,"").replace(/\*/g,"").replace(/#/g,"").replace(/\$/g,"").replace(/,/g,"") + '" class="layui-input" /> <button class="layui-btn  layui-btn-normal layui-btn-mini" onclick="delSql(this);" data-sql="'+sqlNameList[i]+',">移除</button> </div> </div>';
            }
        }
        $("#sqlName").html(htmlStr);
        $("#finalRuleTextarea").val(sqlName.replace(/@/g,"").replace(/\*/g,"").replace(/#/g,"").replace(/\$/g,"").replace(/,/g,""));
    }
    function delSql(_this){
        if($(_this).hasClass("layui-btn-disabled")){
            return;
        }
        if($(_this).data("sql").indexOf("并且")>-1 || $(_this).data("sql").indexOf("或者") >-1){
            sqlName = sqlName.replace($(_this).data("sql"),"");
        }else{
            if(sqlName.indexOf("并且")>-1||sqlName.indexOf("或者")>-1){
                sqlName = sqlName.replace($(_this).data("sql") + "*并且* ","");
                sqlName = sqlName.replace($(_this).data("sql") + "*或者* ","");
            }else{
                sqlName = sqlName.replace($(_this).data("sql"),"");
            }
        }
        setfinalRuleTextarea();
    }

    function selectLoad() {
        $(".layui-form-select dd").mouseover(function() {
            if($(this).html().length > 15){
                layer.tips($(this).html(), $(this), {
                    tips : [ 1, '#08c' ],// 还可配置颜色
                    time : 1000
                });
            }
        });
    }
</script>