<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>大额数据批量导入</title>
<meta name="renderer" content="webkit">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport"
	content="width=device-width, initial-scale=1, maximum-scale=1">
<link type="include" href="/common/depcss.html" />
</head>
<body>
	<div class="formbox layui-form " style="padding: 50px 0 20px;">
		<div id="tb2"></div>
		<div class="layui-btn-div">
			<a class="layui-btn bgc1 layui-btn-mini" lay-submit lay-filter="edit"
				href="javascript:javascript:importData()">上传</a>
			<a class="layui-btn layui-btn-primary layui-btn-mini"
				onclick="parent.layer.close(parent.layer.getFrameIndex(window.name));">返回</a>
		</div>
	</div>
	<script id="lab2" type="text/tmpl">
<form class="layui-input-inline" id="addMore" enctype="multipart/form-data"  action="">
	<div class="layui-form-item">
		<label class="layui-form-label">文件路径：</label>
		<div class="layui-input-inline">
			<input type="text" name="upfile" id="upfile" autocomplete="off" class="layui-input">
            <div class="layui-box layui-upload-button" style="margin-top:15px;"><form target="layui-upload-iframe" method="post" key="set-mine" enctype="multipart/form-data" action=""><input type="file" name="bw" id="bw" lay-type="file" class="layui-upload-file" 
onchange="upfile.value=this.value"></form><span class="layui-upload-icon"><i class="layui-icon"></i>上传文件</span></div>
		<input type="hidden" name="user" value="{{ View.getRes().getUser().userName }}" />
		</div>
    </div>
</form>
</script>
</body>
<link type="include" href="/common/depjs.html" />
<script type="text/javascript" src="{=ctx}/js/jquery/jquery.min.js"></script>
<script type="text/javascript" src="{=ctx}/js/jquery/jquery.form.js"></script>
<script type="text/javascript">
	var tmpl = null;
	$(document).ready(function() {
		var tp = new View.Tmpl({
			"container" : $("#tb2"),
			"tmpl" : $("#lab2").html(),
			"attr" : "bigamount.json" //注意, json文件中不能有任何注解之类的，否则加载失败
		});
		tp.onload(function(attrs, param) {
			View.info(attrs); //blackWhiteList.json 中的属性对象
			View.info(param); //param 参数转的json对象
			var data = {};
			tp.bind(function(callback) {
				callback.call(this, data);
			});
		}, "index=1");
		tp.refresh("index=2");
	});

	function checkData() {
		var fileDir = $("#bw").val();
		var suffix = fileDir.substr(fileDir.lastIndexOf("."));
		if ("" == fileDir) {
			alert("选择需要导入的Excel文件！");
			return false;
		}
		if (".xls" != suffix && ".xlsx" != suffix) {
			alert("选择Excel格式的文件导入！");
			return false;
		}
		return true;
	}

	function importData() {
		if (!checkData()) {
			return;
		}
		View.info($("#user").val());
		$('#addMore')
				.ajaxSubmit(
						{
							type : 'post',
							url : Const.apiUrl + "/Receipt/receiptImport",
							dataType : 'json',
							data:$("#addMore").serialize(),
							success : function(resp) {
								if (resp._data == '0') {
									TmplUtils.showMsgFail("该回执已导入，请不要重复导入");
								} else {
									TmplUtils.showMsgSuccess('导入成功');
									parent.tbTmpl.refresh("pindex="
											+ (parent.TmplUtils.currPage - 1)
											+ "&pcount=" + TmplUtils.pageSize
											+ TmplUtils.searchParam);
									parent.previewTmpl.refresh();
									var index = parent.layer
											.getFrameIndex(window.name); //获取窗口索引
									parent.layer.close(index);
								}
							},
							error : function(code) {
								TmplUtils.showMsgFail('导入失败');
							}
						});
	}
</script>
</html>
