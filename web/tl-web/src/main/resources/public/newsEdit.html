<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <title>资讯详情</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link type="include" href="/common/depcss.html" />
</head>

<body class="iframeBody">
<div class="scrollbar">
	<div class="content">
    <div class="formbox layui-form add-formbox">
        <div class="_tmpl" data-url="edit.html" data-attr="news.json" data-bind="editOnBind" data-param=""></div>
        <div class="layui-btn-div" id="layui-btn-fixed">
            <button class="layui-btn bgc1 layui-btn-small" lay-submit lay-filter="edit" id="submit">确定</button>
            <button class="layui-btn layui-btn-primary layui-btn-small" onclick="parent.layer.close(parent.layer.getFrameIndex(window.name));">取消</button>
        </div>
    </div>
   </div>
   </div>
</body>
<link type="include" href="/common/depjs.html" />
<script type="text/javascript" src="{=ctx}/js/util/ystep.js"></script>
<script>
    $(document).ready(function() {
        $("#submit").click(function() {
            if (TmplUtils.check('edit')) {
                edit();
            }
        });
    });

    //var id = window.location.hash.replace("#", "");
    var id = View.getQStr('id');
    var flag= View.getQStr('flag');
	var topicContent;
    function editOnBind(attrs, param) {
        tmpl = this;
        tmpl.bind(function(callback) {
            var _this = this;
            if (id) {
                var url = Const.apiUrl + "/newsController/get";
                var _this = this;
                View.get(url, "id=" + id, function(resp) {
                    var data = {};
                    if (resp) {
                        data.data = resp;
                    }
                    //默认展开分组 ，不配置默认展开第一个分组
                    data.showGroup = "base";
                    if(flag=="view"){
                    	data.editable = 2;
                    	$("#submit").hide();
                    };
                    
                    callback.call(_this, data);
                    TmplUtils.editOnLoad();
                    loadRichText();
                  	//加载封面图片
                    loadCoverImage();
                }, function() {
                    TmplUtils.showMsgFail('信息获取失败');
                });
            } else {
                var data = {};
                data.showGroup = "base,submit";
                callback.call(_this, data);
                TmplUtils.editOnLoad();
                loadRichText();
                //加载封面图片
                loadCoverImage();
            }
        });
    }
    
    function loadRichText(){
	 	$("textarea[name='content']").attr('id','content');
         layui.use('layedit', function(){
     	  var layedit = layui.layedit;
     	  layedit.set({
      		 uploadImage: {
  				url: Const.apiUrl + '/commonController/upLoad'
   				,type: 'post'
 			}	
     		  ,tool: ['strong' //加粗
							  ,'italic' //斜体
							  ,'underline' //下划线
							  ,'del' //删除线
							  ,'|' //分割线
							  ,'left' //左对齐
							  ,'center' //居中对齐
							  ,'right' //右对齐
							  ,'|' 
							  ,'link' //超链接
							  ,'unlink' //清除链接
							  ,'face' //表情
							  ,'image' //插入图片
							  //,'help' //帮助
								],height: 500});
     	 topicContent = layedit.build('content'); //建立编辑器
     	});
    }
    //加载图片
    function loadCoverImage(){
    	//保存封面地址
    	var coverUrl = $(".layui-input-inline input[name='coverUrls']").val();
    	var parent = $(".layui-input-inline input[name='coverUrls']").parent();
    	parent.html("");
    	var htmlInfo="<img style='width:10%' onerror="+defaultUrl+" /> ";
    	//加上上传按钮
    	htmlInfo+="<button type='button'  id='loadImg' > 上传图片 </button>";
    	//加上存储input图片地址
    	htmlInfo+="<input type='hidden' name='coverUrls' value='"+coverUrl+"'/>";
    	parent.html(htmlInfo);
    	//使用layui自带的组件进行上传
    	layui.use('upload', function(){
    		  var upload = layui.upload;
    		  //执行实例
    		  var uploadInst = upload.render({
    		    elem: '#loadImg' //绑定元素
    		    ,url: Const.apiUrl + '/commonController/upLoad' //上传接口
    		    ,done: function(res){
    		      //上传完毕回调
    		      //设置图片信息
    		      $(".layui-input-inline img").attr("src",res.data.src);
    		      $(".layui-input-inline img").attr("alt",res.data.title);
    		      //设置图片名称
    		      $("input[type='hidden']").val(res.data.title);
    		      $(".layui-input-inline img").show();
    		    }
    		    ,error: function(){
    		      //请求异常回调
    		    	TmplUtils.showMsgFail("上传图片失败");
    		    }
    		  });
    		 if(!id){
    			 if($("input[type='hidden']").val()==""){
    				 $(".layui-input-inline img").hide();
    			 }
    		 }else{
    			 $(".layui-input-inline img").attr("src",Const.apiUrl+"/images/news/cover/"+coverUrl);
    			 $(".layui-input-inline img").attr("alt",coverUrl);
    		 }
    		});
    }
    
    //参数说明：str表示原字符串变量，flg表示要插入的字符串，sn表示要插入的位置
    function insert_flg(str,flg,sn){
        var newstr="";
        for(var i=0;i<str.length;i+=sn){
            var tmp=str.substring(i, i+sn);
            newstr+=tmp+flg;
        }
        return newstr;
    }
    
    //编辑保存
    function edit() {
        layui.use('layedit', function(){
     	  	var layedit = layui.layedit;
     	  	$("#content").val(layedit.getContent(topicContent));
     	});
        var reportList = Utils.formToObj("edit");
        if(id){
			reportList.newsId=id;
		}
        var url = Const.apiUrl + "/newsController/save";
        View.post(url, reportList, function(resp) {
            TmplUtils.showMsgSuccess('编辑成功');
            parent.tbTmpl.refresh("pindex=" + (parent.TmplUtils.currPage - 1) 
        	    + "&pcount=" + parent.TmplUtils.pageSize 
                + parent.TmplUtils.searchParam);
            
            var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
            parent.layer.close(index);
        }, function(code) {
            TmplUtils.showMsgFail('编辑失败');
        });
    }
</script>

</html>