<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>可疑交易分析处理</title>
<link type="include" href="/common/depcss.html" />
</head>
<body class="iframeBody">
	<div class="content">

		<div class="main-panel layui-clear">

			<div class="_tmpl" data-url="user.html" data-attr="suspicious.json"
				data-bind="userOnBind" data-param=""></div>
			<div class="main-panel-right">
				<div class="layui-elem-field">
					<div class="group-button FL">
						<button
							class="layui-btn layui-btn-disabled layui-btn-small modal-full"
							id="edits-data">批量操作</button>
					</div>
					<div class="_tmpl" data-url="filterCriteria.html"
						data-attr="suspiciousTrans_filter.json" data-bind="filterOnBind"
						data-param=""></div>

					<div class="clear"></div>
				</div>

				<div class="clear"></div>

				<div class="contentLeft layui-form">
					<div class="_tmpl" data-url="table.html" id="table"
						data-attr="suspicious.json" data-bind="tbOnBind"
						data-param="pindex=0&pcount=10"></div>
				</div>
				<div class="contentRight">
					<div class="_tmpl" data-url="preview.html"
						data-attr="suspicious.json" data-bind="previewOnBind"
						data-param=""></div>
				</div>
				<div style="clear: both"></div>
				<div class="_tmpl" data-url="pages.html" data-attr=""
					data-depend="table" data-bind="TmplUtils.pagesOnBind" data-param=""></div>
			</div>
		</div>
	</div>
</body>
<link type="include" href="/common/depjs.html" />
<script>
	$(function() {
		$("#edits-data").click(function() {
			var title_;
			var content_;
			if (searchParam1.indexOf('SISP_PRE_') < 0) {
				layer.msg('请选择数据处理状态', {
					icon : 5
				});
				return;
			} else if (searchParam1.indexOf('SISP_PRE_DEAL') > 0) {
				title_ = "批量处理";
				content_ = 'suspiciousTransEditMore.html?state=' + 1;
			} else if (searchParam1.indexOf('SISP_PRE_VERIFY') > 0) {
				title_ = "批量审核";
				content_ = 'suspiciousTransEditMore.html?state=' + 2;
			} else {
				layer.msg('已终止数据不能再处理', {icon : 5});
				return;
			}
			var title = title_;
			var url = content_;
			View.openDialog(url, title);
		});
		var form = layui.form();
		//监听提交
		form.on('submit', function(data) {
			return false;
		});

	});
</script>
<script>
	function closePreview() {
		$(".contentLeft").removeClass("w1");
		$(".contentRight").removeClass("w2");
		$(".lay-tab-right").removeClass("w3");
	}
</script>
<script>
	var item;
	var tbTmpl;
	var firstLoad = true;
	var date = Utils.getDate(new Date().getTime() - 86400000);
	var tempdate;
	Work.onSendEventBefore(function(jobEvent, job) {
		var susp = job.getTarget();
		jobEvent.targetJson = JSON.stringify(susp);
		return jobEvent;
	});

	Work.onSendEventAfter(function(result, job) {
		View.info("job :{jobId} result：{success} ".format(result));
		if(!!result.data){
			openReason(result.data);
			return ;
		}
		View.fireEvent("TB_DATA_CHANGE", {});
	});
	View.setEvent("TB_DATA_CHANGE", function(arg) {
		tbTmpl.refresh("pindex=" + (TmplUtils.currPage - 1) + "&pcount="
				+ TmplUtils.pageSize + TmplUtils.searchParam);
		previewTmpl.refresh();
		if (!!arg && arg.window) {
			var index = layer.getFrameIndex(arg.window); //获取窗口索引
			layer.close(index);
		}
	});
	Work.onDoAction(function(action, job) {
		var tar = job.getTarget();
		edit(tar.id);
	});
	function tbOnBind(attrs, param) {
		tmpl = this;
		tbTmpl = tmpl;
		var _bind = function(callback) {
			var url = Const.apiUrl + "/suspiciousTrans/getMore";
			var _this = this;
			var _succ = function(resp) {
				var data = {};
				if (resp) {
					data.data = resp;
					TmplUtils.totalPages = data.data.totalPages;
					TmplUtils.totalCount = data.data.totalElements;
				}
				//操作按钮
				data.hasOperation = true;
				data.tdBeforeFill = function(obj) {
					if (obj.row > 1) {
						if (obj.col == 1) {
							var job = Work.getJob($.extend(true, {}, obj.item));
							var html = job.getActionsHtml();
							return html;
						}
					}
					if (obj.col == 2 && obj.row >= 2) {
						if (obj.item.aptp == "02") {
							return "<span style='color:red;'>" + obj.html
									+ "</span>";
						}
					}
					return obj.html;
				}
				//data.trClick = "bindPro";
				data.operationWidth = 10;
				//表格显示列数
				data.cellLeftCount = 6;
				data.cellRightCount = 3;
				data.tdLeftWidth = [ 10, 7, 9, 10, 10, 20 ];
				data.tdRightWidth = [ 8, 8, 14 ];
				callback.call(_this, data);
				TmplUtils.pageTmpl.refresh();
				TmplUtils.tableOnLoad();
			};
			if(firstLoad){
				var paramData = param;
				var _url = "/businessDay/get";
				View.get(_url, "date=" + date + "&count=1", function(data) {
					if (data && data.length > 0) {
						tempdate = Utils.getDate(data[0]);
						$("input[name=starts]").val(tempdate);
						$("input[name=ends]").val(tempdate);
						paramData.starts = tempdate;
						paramData.ends = tempdate;
						TmplUtils.searchParam = "&starts=" + tempdate
								+ "&ends=" + tempdate;
						param = "";
						for ( var key in paramData) {
							param = param + "&" + key + "="
									+ paramData[key];
						}
						param = param.substr(1, param.length);
						View.get(url, param, _succ, function(code) {
							layer.msg('查询出错', {icon : 5});
						});
					}
				}, function() {
					TmplUtils.showMsgFail("时间获取失败");
				});
				firstLoad =false;
			}else{
				View.get(url, param, _succ, function(code) {
					layer.msg('查询出错', {icon : 5});
				});
			}
		}
		tmpl.bind(_bind);
	}

	/* //表格单元格点击事件
	function bindPro(item) {
		if (!TmplUtils.isEditing) {
			this.item = item;
			previewTmpl.refresh();
		}
	}
	//预览绑定
	var previewTmpl;
	function previewOnBind(attrs, param) {
		tmpl = this;
		previewTmpl = tmpl;
		if (!item) {
			return;
		}
		tmpl.bind(function(callback) {
			var url = Const.apiUrl + "/suspiciousTrans/get";
			var data = {};
			//是否可编辑
			//data.canEdit = true;
			data.data = item;
			//绑定点击事件
			//data.checkClick = "check";
			//data.saveClick = "save";
			callback.call(this, data);
			TmplUtils.previewOnLoad();
		});
	} */
	//客户名称导航加载
	function userOnBind() {
		tmpl = this;
		tmpl.bind(function(callback) {
			var url = Const.apiUrl + "/suspiciousTrans/getNames";
			var _this = this;
			View.get(url, "", function(resp) {
				var data = {};
				if (resp) {
					data.data = resp;
				}
				callback.call(_this, data);
				layui.use('element', function() {
					var element = layui.element();
					element.init();
				});
				$(".layui-nav-item a").mouseover(function() {
					if ($(this).html().length > 15) {
						layer.tips($(this).html(), $(this), {
							tips : [ 1, '#08c' ],// 还可配置颜色
							time : 3000
						});
					}
				});
			}, function() {
				//layer.msg('查询出错', {icon: 5});
				TmplUtils.showMsgFail('查询出错');
			});

		});

	}
	//根据客户名查询
	function findByName(ctid) {
		searchParam = "&ctid=" + ctid;
		searchParam1 = '';
		$("input[name=starts]").val(tempdate);
		$("input[name=ends]").val(tempdate);
		layui.form().render();
		searchParam1 = Utils.formToStr("filterCriteria");
		TmplUtils.searchParam = searchParam + searchParam1;
		tbTmpl.refresh("pindex=0" + "&pcount=" + TmplUtils.pageSize
				+ TmplUtils.searchParam);
		closePreview();
		$("#edits-data").attr("class",
				"layui-btn layui-btn-disabled layui-btn-small modal-full");
		$("#edits-data").html("批量操作");

	}
	//查询条件绑定
	function filterOnBind(attrs, param) {
		tmpl = this;
		var _this = this;
		tmpl.bind(function(callback) {
			var data = {};
			data.searchClick = "search";
			callback.call(_this, data);
			TmplUtils.filterCriteriaOnLoad();
			$("select[name='job.curJobState']")
					.find("option[value^='PRE']").remove();
			layui.form().render();
		});
	}

	//查询
	//客户编号-csnm
	var searchParam = "";
	//处理状态-job.curJobState，
	var searchParam1 = "";
	function search() {
		searchParam1 = Utils.formToStr("filterCriteria");
		TmplUtils.searchParam = searchParam + searchParam1;
		if (searchParam1.indexOf('SISP_PRE_DEAL') > -1) {
			$("#edits-data").attr("class","layui-btn layui-btn-normal layui-btn-small modal-full fun_ dealmore_");
			$("#edits-data").html("批量处理");
		} else if (searchParam1.indexOf('SISP_PRE_VERIFY') > -1) {
			$("#edits-data").attr("class","layui-btn layui-btn-danger layui-btn-small modal-full fun_ verifymore_");
			$("#edits-data").html("批量审核");
		} else {
			$("#edits-data").attr("class","layui-btn layui-btn-disabled layui-btn-small modal-full");
			$("#edits-data").html("批量操作");
		}
		var paramObj = View.kv2json(TmplUtils.searchParam);
		tbTmpl.refresh("pindex=0" + "&pcount=" + TmplUtils.pageSize
				+ TmplUtils.searchParam);
		closePreview();
	}

	//弹出添加iframe
	function edit(id) {
		var title = '数据处理';
		var url = 'suspiciousTransEdit.html?id=' + id;
		View.openDialog(url, title);
	}
	
	function openReason(resp) {
		var ht = '';
		var data = resp.split(",");
		var count = 0;
		for ( var i in data) {
			var name = data[i].split(":")[0];
			var need = data[i].split(":")[1];
			if(!!need){
				count++;
				ht += "<p>" + count + "、" + need + "</p>";
			}
		}
		if(resp.indexOf("State has changed")>-1){
			TmplUtils.showMsgFail("状态已经发生改变，操作失败");
		}else if(resp.indexOf(":")>-1){
			top.layer.open({
				content : ht,
				btn : [ '关闭' ],
				yes : function(index, layero) {
					top.layer.closeAll();
				},
				cancel : function() {
				}
			});
		}else{
			TmplUtils.showMsgFail(resp);
		}
	}
</script>
</html>