<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>可以交易分析修改</title>
<meta name="renderer" content="webkit">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport"
	content="width=device-width, initial-scale=1, maximum-scale=1">
<link type="include" href="/common/depcss.html" />
<link rel="stylesheet" type="text/css" href="{=ctx}/css/ystep.css" />
</head>
<body class="iframeBody">
	<div class="formbox layui-form add-formbox">
		<div class="_tmpl" data-url="edit.html" 
			data-attr="suspiciousTrans_susp.json" data-bind="editOnBind" 
			data-param="editable=1"></div>
		<div class="_tmpl" data-url="edit.html"
			data-attr="suspiciousTrans_base.json" data-bind="editOnBind"
			data-param="editable=2"></div>
		<div class="layui-btn-div" id="layui-btn-fixed">
			<div class="ystep4" id="flowsheet"></div>
			<div id="commounts" class="txt-c" style="display:none;">
				不通过理由：<span id = "commount" style="color:red"></span>
			</div>
			<div class="txt-c">
				<span id="wf_btns">
					<button class="layui-btn bgc1 layui-btn-mini" lay-submit
						lay-filter="edit" id="submit">确定</button>
				</span>
				<button class="layui-btn layui-btn-primary layui-btn-mini fun_ upload_"
						onclick="fileUpload()">上传附件</button>
				<button class="layui-btn layui-btn-primary layui-btn-mini"
					onclick="parent.layer.close(parent.layer.getFrameIndex(window.name));">取消</button>
			</div>
		</div>
	</div>
</body>
<link type="include" href="/common/depjs.html" />
<script type="text/javascript" src="{=ctx}/js/util/ystep.js"></script>
<script>
var suspicious = {};
Work.onSendEventBefore(function(jobEvent, job) {
	suspicious =  Utils.formToObj("edit");
	View.info("onSendEventBefore");
	jobEvent.targetJson = JSON.stringify(suspicious);
	var et = job.getEvent(jobEvent.event);
	if (et && et.commentsRequired === true) {
		var opts = {"title":"请填写不通过原因"}; 
		// opts 对象可以不传。有默认值
		FlowHelper.openCommentsBox(opts,function(comments) {
			jobEvent.comments = comments;
			jobEvent.targetJson = JSON.stringify(suspicious);
			Work.sendJobEvent(jobEvent); //触发事件
		});
		return null;//返回空,工作流事件不会触发
	}
	return jobEvent;
});

Work.onSendEventAfter(function(result, job) {
	View.info("job :{jobId} result：{success} ".format(result));
	//View.info(result.data);
	if (result.success) {
		TmplUtils.showMsgSuccess('编辑成功');
	}
	if(!!result.data){
		openReason(result.data);
		return;
	}
	parent.View.fireEvent("TB_DATA_CHANGE", {
		"window" : window.name
	});
});

	var id = View.getQStr('id');
	var editTmpl;
	var flag = true;
	function editOnBind(attrs, param) {
		tmpl = this;
		editTmpl = tmpl;
		tmpl.bind(function(callback) {
					var _this = this;
					if (id) {
						var url = Const.apiUrl + "/suspiciousTrans/get";
						View.get(url,"id=" + id,function(resp) {
											var data = {};
											data.attrs = attrs.attrs;
											data.groups = attrs.groups;
											data.enums = attrs.enums;
											if (resp) {
												data.data = resp;
											}
											data.editable = param.editable;
											data.checkClick = "check";
											data.saveClick = "edit";
											data.showGroup = "susp,transaction,trader";
											callback.call(_this, data);
											$($(".layui-colla-title")[1]).append("<span>报告机构编码: "
													+ data.data.ricd
													+ "</span><span>报告金融机构网点代码: "
													+ data.data.finc
													+ "</span>");
											$($(".layui-colla-title")[2]).append("<span>可疑主体姓名名称: "+ data.data.senm
													+ "</span><span>客户编号: "
													+ data.data.csnm1
													+ "</span>");
											TmplUtils.editOnLoad();
										}, function() {
											layer.msg('可疑交易信息获取失败', {
												icon : 5
											});
										});
					} else {
						var data = {};
						data.attrs = attrs.attrs;
						data.groups = attrs.groups;
						data.enmus = attrs.enmus;
						callback.call(_this, data);
						TmplUtils.editOnLoad();
					}
				});
		if (flag) {
			tmpl.onFinish(function(data) {
				var cls = [ "", "layui-btn-normal" ];
				var job = Work.getJob(data.data);
				var _html = job.getEventsHtml(cls);
				$("#wf_btns").html(_html);
				View.info(data);
				job.createFlowsheet($("#flowsheet"), function(job) {
					View.info("ok");
					if(data.data.aptp=="02"){
						$("#commounts").css('display','block');
					}
					var status=[];
					for(var i=0;i<job.jobStates.length;i++){
						if(job.jobStates[i].state==="SISP_PRE_VERIFY"){
							status.push(job.jobStates[i]);
						}
					}
					if(status.length>0){
						$("#commount").html(status[status.length-1].comments);
					}
				});
			});
			flag = false;
		}
	}

	var amlSuspicious = {};
	//编辑保存
	function edit() {
		var editForms = $("form[name=edit]");
		editForms.each(function() {
			$.extend(amlSuspicious, Utils.formToObj($(this).attr('id')))
		});
		var url = Const.apiUrl + "/workflow/events/send";
		var events = [];
		var jobEvent = {};
		jobEvent.jobId = amlSuspicious.job.jobId;
		if (amlSuspicious.ssdg != 6) {
			jobEvent.event = 'SISP_DEAL';
		} else {
			jobEvent.event = 'STOP';
		}
		jobEvent.worker = user.userName;
		jobEvent.targetJson = JSON.stringify(amlSuspicious);
		events.push(jobEvent);
		View.post(url, events, function(resp) {
			TmplUtils.showMsgSuccess('编辑成功');
			parent.tbTmpl.refresh("pindex=" + (parent.TmplUtils.currPage - 1)
					+ "&pcount=" + parent.TmplUtils.pageSize
					+ parent.TmplUtils.searchParam);
			parent.previewTmpl.refresh();
			var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
			parent.layer.close(index);
		}, function(code) {
			TmplUtils.showMsgFail('编辑失败');
		});
	}
	
	function resave() {
		var editForms = $("form[name=edit]");
		editForms.each(function() {
			$.extend(amlSuspicious, Utils.formToObj($(this).attr('id')))
		});
		if(amlSuspicious.ssdg==6){
			TmplUtils.showMsgFail('请选择一个可疑程度');
			return;
		}
		var url = Const.apiUrl + "/workflow/events/send";
		var events = [];
		var jobEvent = {};
		jobEvent.jobId = amlSuspicious.job.jobId;
		jobEvent.event = 'RESAVE';
		jobEvent.worker = user.userName;
		jobEvent.targetJson = JSON.stringify(amlSuspicious);
		events.push(jobEvent);
		View.post(url, events, function(resp) {
			TmplUtils.showMsgSuccess('编辑成功');
			parent.tbTmpl.refresh("pindex=" + (parent.TmplUtils.currPage - 1)
					+ "&pcount=" + parent.TmplUtils.pageSize
					+ parent.TmplUtils.searchParam);
			parent.previewTmpl.refresh();
			var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
			parent.layer.close(index);
		}, function(code) {
			TmplUtils.showMsgFail('编辑失败');
		});
	}
	
	 function approve() {
		 var editForms = $("form[name=edit]");
			editForms.each(function() {
				$.extend(amlSuspicious, Utils.formToObj($(this).attr('id')))
			});
	        var url = Const.apiUrl+"/workflow/events/send";
			var events =[];
			var jobEvent ={};
			jobEvent.jobId = amlSuspicious.job.jobId;
			
			if(amlSuspicious.ssdg!=6){
				jobEvent.event= 'SISP_VERIFY_PASS';
			}else{
				jobEvent.event= 'STOP';
			}
			amlSuspicious.aptp='01';
			jobEvent.worker = user.userName;
			jobEvent.targetJson = JSON.stringify(amlSuspicious);
			events.push(jobEvent);
	        View.post(url,events,function(resp){
	        	TmplUtils.showMsgSuccess('编辑成功');
				//layer.msg('编辑成功',{icon:6});
				parent.tbTmpl.refresh("pindex="+(parent.TmplUtils.currPage-1)+"&pcount="+parent.TmplUtils.pageSize+parent.TmplUtils.searchParam);
				parent.previewTmpl.refresh();
				var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
				parent.layer.close(index);
			},function(code){
				TmplUtils.showMsgFail('编辑失败');
	            //layer.msg('编辑失败',{icon:5});
			});
		}

		function fileUpload(){
			top.layer.open({
				type : 2,
				title : "附件信息",
				shade : 0.3,
				area : [ '80%', '80%' ],
				maxmin : false,
				content : 'suspiciousfileUpload.html#'+id,
				offset : '5%'
			});
		}
		
		function openReason(resp){
			var editForms = $("form[name=edit]");
			var ht ='';
			if(resp.indexOf(":")>-1){
				var data = resp.split(",");
				editForms.find(".yzts").removeClass("yzts");
				/* parent.tbTmpl.refresh("pindex="
						+ (parent.TmplUtils.currPage - 1) + "&pcount="
						+ parent.TmplUtils.pageSize
						+ parent.TmplUtils.searchParam);
				parent.previewTmpl.refresh(); */
				var count = 0;
				for ( var i in data) {
					var name = data[i].split(":")[0];
					var need = data[i].split(":")[1];
					if(!!need){
						count++;
						ht += "<p>" + count + "、" + need + "</p>";
					}
					var obj = document.getElementsByName(name);
					if(obj.length<=0){
						obj = $("input[name^='"+name+"']").parent();
						if(obj.length<=0){
							obj = $("select[name^='"+name+"']").parent();
						}
					}
					//group展开
					if($(obj)){
						$(obj).closest(".layui-colla-content").addClass("layui-show");
					}else{
						obj.closest(".layui-colla-content").addClass("layui-show");
					}
					//错误tips
					yzTips(data[i].split(":")[0], obj[0], need);
				}
			}
			if(resp.indexOf("State has changed")>-1){
				TmplUtils.showMsgFail("状态已经发生改变，操作失败");
			}else if(resp.indexOf(":")>-1){
				top.layer.open({
					content : ht,
					btn : [ '关闭' ],
					yes : function(index, layero) {
						top.layer.closeAll();
					},
					cancel : function() {
					}
				});
			}else{
				TmplUtils.showMsgFail(resp);
			}
		}
		
		function showTips(obj,need){
			obj.focus(function(){
				$(".layui-layer-tips").hide();
				layer.tips(need, this,{
					tips: [2, '#f00'],
					  time: 1000000
				});
			});
			obj.blur(function(){
				$(".layui-layer-tips").hide();
				$(".layui-layer-tips").attr("showtime",3000);
			});
		}
		function yzTips(name,obj,need){
			if(obj.tagName=="SELECT"){
				$(obj).parent().find("input").addClass('yzts');
				showTips($(obj).parent().find("input"),need);
			}else if(obj.tagName == "INPUT"){
				$(obj).addClass('yzts');
				showTips($(obj), need);
			}else if(obj.tagName == "TEXTAREA"){
				$(obj).addClass('yzts');
				showTips($(obj), need);
			}else{
				$(obj).addClass('yzts');
				showTips($(obj).find('input'), need);
			}
		}
</script>
</html>
