<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>横幅信息</title>
<meta name="renderer" content="webkit">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport"
	content="width=device-width, initial-scale=1, maximum-scale=1">
<link type="include" href="/common/depcss.html" />
</head>
<body class="iframeBody">
<div class="scrollbar">
	<div class="formbox layui-form add-formbox">
		<div class="_tmpl" data-url="edit.html" data-attr="banner.json"
			data-bind="editOnBind" data-param=""></div>
		<div class="layui-btn-div">
			<a class="layui-btn bgc1 layui-btn-small" lay-submit
				lay-filter="edit"
				href="javascript:edit();" id="submit">保存</a>
			<!-- 	<a class="layui-btn bgc1 layui-btn-small" lay-submit
				lay-filter="commit"
				href="javascript:commit();">保存并提交</a> -->
			<a class="layui-btn layui-btn-primary layui-btn-small"
				onclick="parent.layer.close(parent.layer.getFrameIndex(window.name));">取消</a>
		</div>
	</div>
</div>
</body>
<link type="include" href="/common/depjs.html" />
<script>
	/* var id = View.getQStr("id"); */
	var id = View.getQStr("id");
	var flag = View.getQStr("flag");
	var tmpl;
	
	function editOnBind(attrs, param) {
		tmpl = this;
		tmpl.onFinish(function(data) {
			/* var imgUrl = $(".layui-input-inline img").attr("src").replace("topic","banner").replace("photo/","");
			$(".layui-input-inline img").attr("src",imgUrl); */
			View.resetUi();
		});
		tmpl.bind(function(callback) {
            var _this = this;
            if (id) {
                var url = "/banner/get";
                var _this = this;
                View.get(url, "id=" + id, function(resp) {
                    var data = {};
                    if (resp) {
                        data.data = resp;
                    }
                    View.info(resp);
                    //默认展开分组 ，不配置默认展开第一个分组
                    data.showGroup = "base";
                    if(flag =="view"){
                    	data.editable = 2;//不可编辑
                    	$("#submit").hide();
                    }
                    callback.call(_this, data);
                    TmplUtils.editOnLoad();
                    loadImage();
                }, function() {
                    TmplUtils.showMsgFail('信息获取失败');
                });
            } else {
                var data = {};
                data.showGroup = "head,base";
                callback.call(_this, data);
                TmplUtils.editOnLoad();
                loadImage();
            }
        });
    }

	//自定义前段校验规则，可以多个
	TmplUtils.verify.desc = function(value) {
		if (value.length < 5) {
			return '描述至少得5个字符啊';
		}
	}


	//编辑保存
	function edit() {
		 if (TmplUtils.check('edit')) {
			var appVersion = Utils.formToObj("edit");
			var url = Const.apiUrl + "/banner/addOrUpdate";
				View.post(url, appVersion, function(resp) {
					TmplUtils.showMsgSuccess('编辑成功');
					var index = parent.layer.getFrameIndex(window.name);
					parent.tbTmpl.refresh("pindex="
							+ (parent.TmplUtils.currPage - 1) + "&pcount="
							+ parent.TmplUtils.pageSize
							+ parent.TmplUtils.searchParam);
					parent.layer.close(index);
				}, function(code,data) {
					//showError(data.data);
						TmplUtils.showMsgFail(data.data);
					
				});
         }
		
	}

	//保存并提交
	function commit() {
		var appVersion = Utils.formToObj("edit");
		var url = Const.apiUrl + "/banner/addOrUpdate";
		View.post(url, appVersion, function(resp) {
			TmplUtils.showMsgSuccess('提交成功');
			var index = parent.layer.getFrameIndex(window.name);
			parent.tbTmpl.refresh("pindex="
					+ (parent.TmplUtils.currPage - 1) + "&pcount="
					+ parent.TmplUtils.pageSize
					+ parent.TmplUtils.searchParam);
			parent.layer.close(index);
		},function(code,data) {
			TmplUtils.showMsgFail(data.data);
			//showError(data.data);
		});
	}
	
	 //自定义前段校验规则，可以多个
    TmplUtils.verify.desc = function(value) {
        if (value.length < 5) {
            return '描述至少得5个字符';
        }
    }
	
	 function check(){}
    
    function back() {
        parent.View.fireEvent("TB_DATA_CHANGE", {
            "window" : window.name
        });
    }
    
    //上传图片
    function loadImage(){
    	$(".layui-input-inline img").attr("id","bannerURL");
    	var htmlInfo = $(".layui-input-inline img").parent().html().replace(/;/ig,"");
    	//加上上传按钮
    	htmlInfo+="<button type='button'  id='loadImg' > 上传图片 </button>";
    	//加上存储input图片地址
    	htmlInfo+="<input type='hidden' name='bannerURL'/>";
    	$(".layui-input-inline img").parent().html(htmlInfo);
    	//使用layui自带的组件进行上传
    	layui.use('upload', function(){
    		  var upload = layui.upload;
    		  //执行实例
    		  var uploadInst = upload.render({
    		    elem: '#loadImg' //绑定元素
    		    ,url: Const.apiUrl + '/commonController/upLoad' //上传接口
    		    ,done: function(res){
    		      //上传完毕回调
    		      //设置图片信息
    		      $(".layui-input-inline img").attr("src",res.data.src);
    		      $(".layui-input-inline img").attr("alt",res.data.title);
    		      //设置图片名称
    		      $("input[type='hidden']").val(res.data.title);
    		      $(".layui-input-inline img").show();
    		    }
    		    ,error: function(){
    		      //请求异常回调
    		    	TmplUtils.showMsgFail("上传图片失败");
    		    }
    		  });
    		 if(!id){
    			 if($("input[type='hidden']").val()==""){
    				 $(".layui-input-inline img").hide();
    			 }
    		 }
    		});
    }
</script>
</html>