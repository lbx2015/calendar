<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <title>Z03-填报单位投资关系</title>
    <link type="include" href="/common/depcss.html" />
</head>

<body class="iframeBody">
    <div class="scrollbar">
        <div class="content">
            <div class="layui-elem-field actionBar">
                <div class="layui-btn-group absolute">
                    <button class="layui-btn  layui-btn-small layui-btn-primary" id="add-data">
					<i class="iconfont icon-tianjia"></i> 新建
				</button>
                    <button class="layui-btn layui-btn-small layui-btn-primary" id=verify onclick="commitMore()">
					<i class="layui-icon">&#xe608;</i> 批量提交
				</button>
                    <button class="layui-btn layui-btn-small layui-btn-primary" id=verify onclick="verifyMoreOpen()">
					<i class="layui-icon">&#xe608;</i> 批量审核
				</button>
                    <button class="layui-btn layui-btn-small layui-btn-primary" id=subMore onclick="resetMoreOpen()">
					<i class="layui-icon">&#xe608;</i> 批量重置
				</button>
                    <button class="layui-btn layui-btn-small layui-btn-primary" id=verify onclick="extractLastMonthData()">
					<i class="layui-icon">&#xe608;</i> 提取上月数据
				</button>
                </div>
                <div class="_tmpl" data-url="filterCriteria.html" data-attr="falz03.json" data-bind="filterCriteriaOnBind" data-param=""></div>
                <div class="clear"></div>
            </div>
            <div class="clear"></div>
            <div id="relationGraph" class="contentImg" style="height:450px; width:100%;"></div>
        </div>
    </div>
</body>
<link type="include" href="/common/depjs.html" />
<script type="text/javascript" src="{=ctx}/echarts/MyeChart.js"></script>
<script>
    $(function() {
        $("#add-data").click(function() {
            View.post(Const.apiUrl + "/falz03/isCanBuild", {
                "branchId": MyUtil.getBranchId(),
                "buocMonth": MyUtil.getBuocMonthInt()
            }, function(resp) {
        		View.openDialog('falz03Edit.html?state=edit', "添加数据");
            }, function(code, data) {
                MyUtil.errHandler(code, data);
            });
        });
        var form = layui.form;
        //监听提交
        form.on('submit', function(data) {
            return false;
        });
    });
</script>
<script>
    $(document).ready(function() {
        graphOnLoad({});
        $(document).bind("contextmenu", function(e) {
            return false;
        });
    });

    function graphOnLoad(param) {
        var url = Const.apiUrl + "/falz03/getAll";
        param['buocMonth'] = param['buocMonth'] || MyUtil.getBuocMonthInt();
         param['branchId'] = param['branchId'] || MyUtil.getBranchId();
        View.get(url, param, function(resp) {
            relationGraph("relationGraph", "填报单位投资关系图", dataHandler(resp), leftClickHandler, rightClickHandler, mouseoverHandler);
        }, function(code) {
            layer.msg('查询出错', {
                icon: 5
            });
        });
    }

    //数据处理
    function dataHandler(resp) {
        if (resp.length == 0) {
            return [{
                'title': "无结果",
                '_name': "",
                '_code': "",
                '_address': "",
                '_dept': ""
            }];
        }
        var prop = [];
        var data = [];
        for (var i = 0; i < resp.length; i++) {
            var item = resp[i];
            //投资者名称 和代码
            if (!prop.contains(item['z0302'])) {
                prop.push(item['z0302']);
                data.push({
                    'title': item['z0301'] + "\r\n" + item['z0302'],
                    '_name': item['z0301'],
                    '_code': item['z0302'],
                    '_address': item['z0303'],
                    '_dept': item['z0304']
                });
            }
            //被投资者   名称   和代码
            if (!prop.contains(item['z0307'])) {
                prop.push(item['z0307']);
                data.push({
                    'title': item['z0306'] + "\r\n" + item['z0307'],
                    '_name': item['z0306'],
                    '_code': item['z0307'],
                    '_address': item['z0308'],
                    '_dept': item['z0309']
                });
            }
        }
        //被投资者搜集 方法
        var _handler = function(d, arr) {
            //投资者代码
            var code = d['_code'];
            //被投资者名称集合
            var endpoint = [];
            for (var i = 0; i < arr.length; i++) {
                var item = arr[i];
                if (code == item['z0302']) {
                    endpoint.push({
                        'title': item['z0306'] + "\r\n" + item['z0307'],
                        '_id': item['id'],
                        '_link': item['z0305'],
                        '_content': item['z0301'] + " → " + item['z0306']
                    });
                }
            }
            d['endpoint'] = endpoint;
        }

        for (var i = 0; i < data.length; i++) {
            //被投资者搜集
            _handler(data[i], resp);
        }
        View.info(JSON.stringify(data));
        return data;
    }

    //鼠标悬浮事件代理
    function mouseoverHandler(params) {
        var tipStr = '';
        if (params.dataType == 'node') {
            tipStr = '名称：' + params.data['_name'] + "<br/>" + '代码：' + params.data['_code'] + "<br/>" +
                '地区：' + params.data['_address'] + "<br/>" + '部门:' + params.data['_dept'] + "<br/>";
        } else if (params.dataType == 'edge') {
            tipStr = '投资方向：' + params.data['_content'] + "<br/>" + '占比：' + params.data['_link'] + "<br/>";
        }
        return tipStr;
    }

    //机构鼠标左键双击事件代理
    function leftClickHandler(params) {
        if (params.dataType == "node") {
            View.openDialog("falz03List.html?z0302=" + params.data['_code'], "Z03-填报单位投资关系");
        } else if (params.dataType == "edge") {
            View.openDialog('falz03Edit.html?state=edit&id=' + params.data['_id'], "编辑数据");
        }
    }

    var z03;
    //机构鼠标右键事件代理
    function rightClickHandler(params) {
		
		
        layer.open({
            content: params.name,
            btn: ['新建投资者', '新建被投资者'],
            btnAlign: 'l',
            yes: function(index, layero) {
                z03 = {
                    z0306: params.data['_name'],
                    z0307: params.data['_code'],
                    z0308: params.data['_address'],
                    z0309: params.data['_dept']
                }
                View.post(Const.apiUrl + "/falz03/isCanBuild", {
                    "branchId": MyUtil.getBranchId(),
                    "buocMonth": MyUtil.getBuocMonthInt()
                }, function(resp) {
                    View.openDialog('falz03Edit.html?state=edit', "新建投资者");
                }, function(code, data) {
                    MyUtil.errHandler(code, data);
                });
                
            },
            btn2: function(index, layero) {
                z03 = {
                    z0301: params.data['_name'],
                    z0302: params.data['_code'],
                    z0303: params.data['_address'],
                    z0304: params.data['_dept']
                }
                View.post(Const.apiUrl + "/falz03/isCanBuild", {
                    "branchId": MyUtil.getBranchId(),
                    "buocMonth": MyUtil.getBuocMonthInt()
                }, function(resp) {
                    View.openDialog('falz03Edit.html?state=edit', "新建被投资者");
                }, function(code, data) {
                    MyUtil.errHandler(code, data);
                });
            },
            cancel: function() {
                //右上角关闭回调
                //return false 开启该代码可禁止点击该按钮关闭
            }
        });
    }

    //查询条件绑定
    function filterCriteriaOnBind(attrs, param) {
        tmpl = this;
        var _this = this;
        TmplUtils.onEunmChanged(function() {
            $('select[name="branchId"]').val(MyUtil.getBranchId());
            $('select[name="branchId"] option:first').remove();
            branchIdAddChangeListen();
        });
        tmpl.onFinish(function(data) {
            $('input[name="buocMonth"]').val(MyUtil.getBuocMonth());
        });
        tmpl.bind(function(callback) {
            var data = {};
            data.searchClick = "search";
            data.dateChangeCall = "MyUtil.buocMonthOnChange";
            callback.call(_this, data);
            TmplUtils.filterCriteriaOnLoad();
        });
    }
    //查询
    function search() {
        TmplUtils.searchParam = MyUtil.formToStr("filterCriteria");
        graphOnLoad(View.kv2json(TmplUtils.searchParam));
    }

    //批量提交
    function commitMore() {
        TmplUtils.showConfirm('您确定批量提交该数据吗？', '确定', '取消', function() {
            var falz03 = {
                    "branchId": MyUtil.getBranchId(),
                    "buocMonth": MyUtil.getBuocMonthInt()
                }
            check(Const.apiUrl + "/falz03/validateMore/1", falz03, function(){
                View.post(Const.apiUrl + "/falz03/commitMore", falz03, function(resp) {
                    TmplUtils.showMsgSuccess("批量提交已完成：" + "成功了" + resp + '条');
                    search();
                    TmplUtils.closePreview();
                }, function(code, data) {
                    MyUtil.errHandler(code, data);
                });
            });
        }, function() {});
    }

    //批量审核open
    function verifyMoreOpen() {
        View.openDialog("reasonEdit.html?opt=VERIFYPASS&url=/falz03/verifyMore", '审核（不通过必须填写原因）', {
            area: ['380px', '260px'],
            shade: [0.3, '#393D49']
        });
    }

    //审核
    function passOrNoPass(url, isPass, reason) {
        View.post(Const.apiUrl + url, {
            "isPass": isPass,
            "branchId": MyUtil.getBranchId(),
            "buocMonth": MyUtil.getBuocMonthInt(),
            "refuseReason": reason
        }, function(resp) {
            if (isPass) {
                TmplUtils.showMsgSuccess("批量审核已完成：" + "成功了" + resp + '条');
            } else {
                TmplUtils.showMsgSuccess("批量审核不通过已完成：" + "成功了" + resp + '条');
            }
            search();
            TmplUtils.closePreview();
        }, function(code, data) {
            MyUtil.errHandler(code, data);
        });
    }


    //批量重置open
    function resetMoreOpen() {
        View.openDialog("reasonEdit.html?opt=RESET", '重置（必须填写原因）', {
            area: ['380px', '260px'],
            shade: [0.3, '#393D49']
        });
    }

    //重置
    function reset(reason) {
        View.post(Const.apiUrl + "/falz03/resetMore", {
            "branchId": MyUtil.getBranchId(),
            "buocMonth": MyUtil.getBuocMonthInt(),
            "resetReason": reason
        }, function(resp) {
            TmplUtils.showMsgSuccess("批量重置已完成：" + "成功了" + resp + '条');
            search();
            TmplUtils.closePreview();
        }, function(code, data) {
            MyUtil.errHandler(code, data);
        });
    }


    //提取上月数据
    function extractLastMonthData() {
        TmplUtils.showConfirm('您确定提取上月数据吗？', '确定', '取消', function() {
            var fal = {
                    "branchId": MyUtil.getBranchId(),
                    "buocMonth": MyUtil.getBuocMonthInt()
                }
            View.post(Const.apiUrl + "/falz03/isCanBuild", fal, function(resp) {
                View.post(Const.apiUrl + "/falz03/extractLastMonthData", fal, function(resp) {
                    TmplUtils.showMsgSuccess(resp + '数据提取成功');
                    search();
                    TmplUtils.closePreview();
                }, function(code, data) {
                    MyUtil.errHandler(code, data);
                });
            }, function(code, data) {
                MyUtil.errHandler(code, data);
            });
        }, function() {});
    }
</script>

<script type="text/javascript">
    //关系图  折线图dom为div的Id,title 标题,  d是数据,fun是否鼠标事件 handler方法  
    function relationGraph(dom, title, d, leftClickFun, rightClickFun, mouseoverFun) {
        var data = d || [];

        function get_nodes(data) {
            var nodes = [];
            var tmp_nodes = [];
            for (var nodes_i in data) {
                if (typeof data[nodes_i] == "function") {
                    continue;
                }
                tmp_nodes.push(data[nodes_i].title);
                nodes.push({
                    'name': data[nodes_i].title,
                    '_name': data[nodes_i]['_name'],
                    '_code': data[nodes_i]['_code'],
                    '_address': data[nodes_i]['_address'],
                    '_dept': data[nodes_i]['_dept'],
                });
            }
            return nodes;
        }

        function get_links(data) {
            var links = [];
            for (var nodes_i in data) {
                var title = data[nodes_i].title;
                var endpoint = data[nodes_i].endpoint;
                var service = data[nodes_i].service;
                for (var service_i in endpoint) {
                    links.push({
                        'source': title,
                        'target': endpoint[service_i].title,
                        '_id': endpoint[service_i]['_id'],
                        '_link': endpoint[service_i]['_link'],
                        '_content': endpoint[service_i]['_content'],
                        'label': {
                            'normal': {
                                'show': false,
                                'textStyle': {
                                    'fontSize': 1
                                },
                                'formatter': service
                            }
                        },
                        'lineStyle': {
                            'normal': {
                                'curveness': 0.1
                            }
                        }
                    })
                }
            }
            for (var i = 0, len1 = links.length; i < len1; i++) {
                for (var j = i, len2 = len1 - 1; j < len2; j++) {
                    if (links[i].source == links[j].target) {
                        links[j].lineStyle.normal.curveness = -0.3;
                    }
                }
            }
            return links;
        }

        var option = {
            title: {
                text: title || '调用关系demo'
            },
            tooltip: {
                formatter: mouseoverFun
            },

            animationDurationUpdate: 1500,
            animationEasing: 'cubicOut',
            animationEasingUpdate: 'quinticInOut',
            series: [{
                type: 'graph',
                layout: 'circular',
                // layout:'none',
                circular: {
                    //initLayout: ...,
                    repulsion: 500,
                    gravity: 500,
                    edgeLength: 500,
                    layoutAnimation: true,
                },
                focusNodeAdjacency: true,
                legendHoverLink: true,
                hoverAnimation: true,
                symbolSize: 100,
                //edgeSymbolSize: 50,
                roam: true,
                label: {
                    normal: {
                        show: true,
                    }
                },
                edgeSymbol: ['circle', 'arrow'],
                edgeSymbolSize: [4, 15],
                edgeLabel: {
                    normal: {
                        textStyle: {
                            fontSize: 20
                        }
                    }
                },
                data: get_nodes(data),
                links: get_links(data),
                lineStyle: {
                    normal: {
                        opacity: 0.9,
                        width: 4,
                        curveness: 0
                    }
                }
            }, ]
        };
        var chart = echarts.init(document.getElementById(dom));
        //添加点击事件
        chart.on('dblclick', function(params) {
            leftClickFun(params);
        });
        chart.on('mouseup', function(params) {
            if (params.event.event.button == 2) {
                rightClickFun(params);
            }
        });
        chart.setOption(option);
    }
</script>

</html>