<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>犯罪类型管理</title>
    <link type="include" href="/common/depcss.html" />
</head>

<body class="iframeBody">
<div class="content">
    <div class="layui-elem-field">
        <div class="group-button FL">
            <button class="layui-btn layui-btn-small layui-btn-danger ajax-all fun_ del_"
                    id="deleteBtn" onclick="del()">
                <i class="layui-icon">&#xe640;</i> 删除
            </button>
            <button
                    class="layui-btn layui-btn-normal layui-btn-small modal-full fun_ add_"
                    id="add-data">
                <i class="layui-icon">&#xe608;</i> 添加
            </button>
            <button class="layui-btn layui-btn-normal layui-btn-small modal-full fun_ updaterule_"
                    id="updateRule" onclick="showRuleEngine();">
                <i class="layui-icon">&#xe608;</i> 规则维护
            </button>
        </div>
        <div class="_tmpl" data-url="filterCriteria.html" data-attr="TranFeatures.json"  data-bind="filterCriteriaOnBind" data-param=""></div>
        <div class="clear"></div>
    </div>
    <div class="clear"></div>
    <div class="contentLeft layui-form">
        <div class="_tmpl" id="table" data-url="table.html"
             data-attr="TranFeatures.json" data-bind="tbOnBind"
             data-param="pindex=0&pcount=10"></div>
    </div>
    <div class="contentRight"></div>
    <div style="clear: both"></div>
    <div class="_tmpl" data-url="pages.html" data-depend="table" data-attr="" data-bind="TmplUtils.pagesOnBind" data-param=""></div>
</div>
</body>
<link type="include" href="/common/depjs.html" />
<script>
    $(function() {
        $("#add-data").click(function() {
            layer.open({
                type : 2,
                title : '添加数据',
                shadeClose: true,
                shade: false,
                maxmin: false, //开启最大化最小化按钮
                area: ['100%', 'auto'],
                offset: '0px',
                move: false,
                content : 'tranFeaturesEdit.html' //iframe的url
            });
            parent.startInit(document.getElementsByTagName("iframe")[0], 560);
        });

        var form = layui.form();
        //监听提交
        form.on('submit', function(data) {
            return false;
        });
    });
</script>
<script>
    var item;
    //表格单元格点击事件
    function bindPro(item){
        this.item = item;
        previewTmpl.refresh();
    }
    
    var form = layui.form(), layer = layui.layer;
	//全选
	form.on('checkbox(allChoose)', function(data) {
		var child = $(data.elem).parents('table').find(
				'tbody input[type="checkbox"]');
		child.each(function(index, item) {
			item.checked = data.elem.checked;
		});
		form.render('checkbox');
	});

    /**
     * 对外提供事件监听
     */
    View.setEvent("TB_DATA_CHANGE", function(arg) {
        tbTmpl.refresh("pindex=" + (TmplUtils.currPage - 1) + "&pcount="
            + TmplUtils.pageSize + TmplUtils.searchParam);
        if (!!arg && arg.window) {
            var index = layer.getFrameIndex(arg.window); //获取窗口索引
            layer.close(index);
        }
    });
    //弹出添加iframe
    function edit(id,isShow){
       layer.open({
            type : 2,
            title : '修改数据',
            shadeClose: true,
            shade: false,
            maxmin: false, //开启最大化最小化按钮
            area: ['100%', 'auto'],
            offset: '0px',
            move: false,
            content: 'tranFeaturesEdit.html?id='+id+'&isShow='+ isShow
        }); 
        parent.startInit(document.getElementsByTagName("iframe")[0], 560);
    }

    var tbTmpl;
    function tbOnBind(attrs, param) {
        tmpl = this;
        tbTmpl = tmpl;
        var data = {};
        tmpl.bind(function(callback) {
            var url = Const.apiUrl + "/tranFeatures/getMore";
            var _this = this;
            View.get(url, param, function(resp) {
                if (resp) {
                    data.data = resp;
                    TmplUtils.totalPages = data.data.totalPages;
                }
                data.table = attrs.table;
                data.enums = attrs.enums;
                if (resp) {
                    data.data = resp;
                }
                //是否需要全选checkbox
                data.hasCheckbox = true;
                data.hasOperation = true;
                //操作按钮
                data.operationWidth = 15;
               /*  data.operations = [ {
                    value : "修改",
                    onclick : "edit",
                    'class' : "layui-btn layui-btn-mini layui-btn-normal fun_ update_"
                } ]; */
                data.tdLeftWidth = [ 8, 20, 20, 20, 10, 5];
                //如果要修改表格内容 ，无需修改的忽略此项
                data.tdBeforeFill = function(obj) {
					if (obj.row > 1 && obj.col == 2) {
						 if(!obj.item.approved || obj.item.approved != 1){
						     var html = '<a href="javascript:;" class="layui-btn layui-btn-mini layui-btn-normal fun_ update_" onclick="edit('+obj.item.id+',1)">修改</a>';
						     html += '<a href="javascript:;" class="layui-btn layui-btn-mini layui-btn-danger fun_ approve_" onclick="approve('+obj.item.id+')">审核</a>';
		         			 return obj.html+html;
						 }else{
					         var html = '<a href="javascript:;" class="layui-btn layui-btn-mini layui-btn-normal fun_ show_" onclick="edit('+obj.item.id+',2)">查看</a>';
					         html += '<a href="javascript:;" class="layui-btn layui-btn-mini layui-btn-danger fun_ cancelapprove_" onclick="cancelApprove('+obj.item.id+')">取消审核</a>';
					         return obj.html+html;
						 }
					}
					if(obj.prop && obj.prop == "tzdm" && obj.item){
			          	return "<a href='javascript:;' style='text-decoration:underline;' onclick='selectRule("+obj.item.id+','+obj.item.approved+");'>"+ obj.html+"</a>"
			        }
					return obj.html;
				}
                if(TmplUtils.pageTmpl.refresh){
                    TmplUtils.pageTmpl.refresh();
                }
                callback.call(_this, data);
                TmplUtils.tableOnLoad();
            }, function(code) {
                TmplUtils.showMsgFail("查询出错");
            });
        });
    }

    //查询条件绑定
    function filterCriteriaOnBind(attrs,param){
        tmpl = this;
        var _this = this;
        tmpl.bind(function (callback) {
            var data={};
            data.searchClick = "search";
            callback.call(_this, data);
            TmplUtils.filterCriteriaOnLoad();
        });
    }

    //查询
    function search(){
        TmplUtils.searchParam = Utils.formToStr("filterCriteria");
        tbTmpl.refresh("pindex=0"+"&pcount="+ TmplUtils.pageSize +TmplUtils.searchParam);
        TmplUtils.currPage = 1;
        TmplUtils.closePreview();
    }


    function showRuleEngine() {
 /*       layer.open({
            type : 2,
            title : '规则配置',
            shadeClose: true,
            shade: false,
            maxmin: false, //开启最大化最小化按钮
            area: ['100%', '100%'],
            offset: '0px',
            move: false,
            content: 'ruleEngine.html#'+id //iframe的url
        });*/
        View.openDialog('ruleEngine.html',"规则维护",{ area: ['100%', '100%']});
        //parent.startInit(document.getElementsByTagName("iframe")[0], 560);
    }
    //保存
    function save() {
        var url = Const.apiUrl + "/tranFeatures/addOrUpdate"
        var riskFactor = Utils.formToObj("preview");
        View.post(url, riskFactor, function(resp) {
            TmplUtils.showMsgSuccess("编辑成功");
            tbTmpl.refresh("pindex=" + (tbTmpl.currPage - 1) + "&pcount="
                + tbTmpl.pageSize + searchParam);
            closePreview();
        }, function() {
            TmplUtils.showMsgFail("编辑失败");
        })
    }
    
    //审核
    function approve(id) {
        TmplUtils.showConfirm('您确定审核吗？','确定','取消',function(){
            var url = Const.apiUrl + "/tranFeatures/approveMore";
            var ids = [];
            ids.push(id)
            View.post(url,ids,function(resp){
                TmplUtils.showMsgSuccess('审核成功');
                tbTmpl.refresh("pindex=" + (TmplUtils.currPage - 1) + "&pcount=" + TmplUtils.pageSize + TmplUtils.searchParam);
            },function () {
                TmplUtils.showMsgFail('审核失败');
            });
        },function () {
        });
    }

    //取消审核
    function cancelApprove(id) {
        TmplUtils.showConfirm('您确定取消审核吗？','确定','取消',function(){
            var url = Const.apiUrl + "/tranFeatures/cancelApproveMore";
            var ids = [];
            ids.push(id)
            View.post(url,ids,function(resp){
                TmplUtils.showMsgSuccess('取消审核成功');
                tbTmpl.refresh("pindex=" + (TmplUtils.currPage - 1) + "&pcount=" + TmplUtils.pageSize + TmplUtils.searchParam);
            },function () {
                TmplUtils.showMsgFail('取消审核失败');
            });
        },function () {
        });
    }
    
    
    
	function selectRule(id,approved){
		 View.openDialog('ruleEngineSelect.html?id='+id+"&approved="+approved,"规则配置",{ area: ['100%', '100%']});
	}
    //删除
    function del() {
        TmplUtils.showConfirm('您确定删除该数据吗？', '确定', '取消', function() {
            var arrChk = $("input[name='tdCheckbox']");
            var ids = [];
            $(arrChk).each(function() {
                if ($(this).next('div').hasClass("layui-form-checked")) {
                    ids.push($(this).data("id"));
                }
            });
            var url = Const.apiUrl + "/tranFeatures/delMore";
            View.post(url, ids, function(resp) {
		       	if(!resp){
		       	    TmplUtils.showMsgSuccess("删除成功");
		       	}else{
		       		TmplUtils.showMsgFail(resp+"条记录删除失败");
		       	}
		        tbTmpl.refresh("pindex=" + (TmplUtils.currPage - 1)+
					"&pcount=" + TmplUtils.pageSize+ TmplUtils.searchParam);
            }, function() {
                TmplUtils.showMsgFail("删除失败");
            });
        }, function() {
        });
    }
</script>
</html>