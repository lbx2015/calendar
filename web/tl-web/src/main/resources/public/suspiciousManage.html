<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>可疑交易处理</title>
<link type="include" href="/common/depcss.html" />
</head>
<body class="iframeBody">
	<div class="content">
		<div class="layui-elem-field">
			<div class="group-button FL">
				<button
					class="layui-btn layui-btn-small layui-btn-danger ajax-all fun_ del_"
					id="deleteBtn" onclick="del()">
					<i class="layui-icon">&#xe640;</i> 删除
				</button>
				<button
					class="layui-btn layui-btn-normal layui-btn-small modal-full fun_ add_"
					id="add-data">
					<i class="layui-icon">&#xe608;</i> 添加
				</button>
				<button
					class="layui-btn  layui-btn-small modal-full fun_ submitmore_"
					id="events-submit" onclick="sendEvents('SUBMIT')">批量提交</button>
				<button
					class="layui-btn layui-btn-danger layui-btn-small modal-full  fun_ approvemore_"
					id="events-verify" onclick="sendEvents('VERIFY_PASS')">
					批量审核</button>
				<button
					class="layui-btn layui-btn-normal layui-btn-small modal-full fun_ addmore_"
					id="addMore-data" onclick="addMore()">
					<i class="layui-icon">&#xe608;</i>批量导入
				</button>
				<!-- <button
					class="layui-btn layui-btn-normal layui-btn-small modal-full fun_ addstorage_" id="events-storage" 
					onclick="sendEvents('ADD_STORAGE')">
						数据入库
				</button> -->
			</div>
			<div class="_tmpl" data-url="filterCriteria.html"
				data-attr="suspicious.json" data-bind="filterCriteriaOnBind"
				data-param=""></div>
			<div class="clear"></div>
		</div>
		<div class="clear"></div>
		<div class="contentLeft layui-form">
			<div class="_tmpl" data-url="table.html" id="table"
				data-attr="suspicious.json" data-bind="tbOnBind"
				data-param="pindex=0&pcount=10"></div>
		</div>
		<div class="contentRight">
			<div class="_tmpl" data-url="preview.html"
				data-attr="suspicious.json" data-bind="previewOnBind" data-param=""></div>
		</div>
		<div style="clear: both"></div>
		<div class="_tmpl" data-url="pages.html" data-depend="table"
			data-attr="suspicious.json" data-bind="TmplUtils.pagesOnBind"
			data-param=""></div>
	</div>
</body>
<link type="include" href="/common/depjs.html" />
<script>
	$(function() {
		$("#add-data").click(function() {
			layer.open({
				type : 2,
				title : '添加数据',
				shadeClose : true,
				shade : false,
				maxmin : false, //开启最大化最小化按钮
				area : [ '100%', 'auto' ],
				offset : '0px',
				move : false,
				content : 'suspiciousEdit.html' //iframe的url
			});
			parent.startInit(document.getElementsByTagName("iframe")[0], 560);
		});

		var form = layui.form();
		//监听提交
		form.on('submit', function(data) {
			return false;
		});
	});
</script>
<script>
	var form = layui.form(), layer = layui.layer;
	//全选
	form.on('checkbox(allChoose)', function(data) {
		var child = $(data.elem).parents('table').find(
				'tbody input[type="checkbox"]');
		child.each(function(index, item) {
			item.checked = data.elem.checked;
		});
		form.render('checkbox');
	});
</script>
<script>
	
</script>
<script>
	var item;
	var tbTmpl;
	var firstLoad = true;
	var date = Utils.getDate(new Date().getTime() - 86400000);

	var start = View.getQStr('start');
	var ends = View.getQStr('end');
	var state = View.getQStr('state');
	function forbbit(id) {

	}
	Work.onSendEventBefore(function(jobEvent, job) {
		var suspicious = job.getTarget();
		suspicious.job = {};
		suspicious.job.jobId = job._jobId;
		jobEvent.targetJson = JSON.stringify(suspicious);
		return jobEvent;
	});

	Work.onSendEventAfter(function(result, job) {
		View.info("job :{jobId} result：{success} ".format(result));
		if (!!result.data) {
			openReason(result.data);
			return;
		}
		View.fireEvent("TB_DATA_CHANGE", {});
	});
	View.setEvent("TB_DATA_CHANGE", function(arg) {
		tbTmpl.refresh("pindex=" + (TmplUtils.currPage - 1) + "&pcount="
				+ TmplUtils.pageSize + TmplUtils.searchParam);
		previewTmpl.refresh();
		if (!!arg && arg.window) {
			var index = layer.getFrameIndex(arg.window); //获取窗口索引
			layer.close(index);
		}
	});
	Work.onDoAction(function(action, job) {
		var tar = job.getTarget();
		if (action == "EDIT") {
			edit(tar.id, 1);
		} else if (action == "VERIFY") {
			edit(tar.id, 2);
		} else if (action == "SHOW") {
			edit(tar.id, "show");
		} else if (action == "COPY") {
			edit(tar.id, "copy");
		} else if (action == "CHANGE") {
			edit(tar.id, "change");
		} else {
			suspEdit(tar.id);
		}
	});
	function sendEvents(event) {
		TmplUtils.showConfirm('您确定此次批量操作吗？', '确定', '取消', function() {
			var ids = [];
			$("input[name='tdCheckbox']:checked").each(function() {
				ids.push($(this).data("id"));
			});
			if (ids == "") {
				TmplUtils.showMsgFail('请选择一条或多条数据');
				return;
			}
	
			Work.sendEvents(event, ids, function(code, result) {
				if (200 != code) {
					View.info(result);
					if (1301 == code) {
						TmplUtils.showMsgFail('选中的数据错误，不能进行操作');
						return;
					}
				}
				if (result) {
					var count = 0;
					for (var i = 0; i < result.length; i++) {
						if (result[i].data) {
							count++;
						}
					}
					if (count > 0) {
						TmplUtils.showMsgFail(count + '条数据操作失败');
					}else{
						TmplUtils.showMsgSuccess('操作成功');
					}
				}
				View.fireEvent("TB_DATA_CHANGE", {});
			});
		}, function() {
		});
	}
	function tbOnBind(attrs, param) {
		tmpl = this;
		tbTmpl = tmpl;
		var _bind = function(callback) {
			var url = Const.apiUrl + "/suspiciouss/getMore";
			var _this = this;
			var _succ = function(resp) {
				var data = {};
				if (resp) {
					data.data = resp;
					TmplUtils.totalPages = data.data.totalPages;
					TmplUtils.totalCount = data.data.totalElements;
				}

				//是否需要全选checkbox
				data.hasCheckbox = true;
				//是否有操作列
				data.hasOperation = true;
				//操作按钮
				//data.operations=[{value:"修改",onclick:"edit"}]
				//tr的点击事件绑定，该方法会传入id 参数

				data.trClick = "bindPro";

				data.operationWidth = 17;
				//表格显示列数
				data.cellLeftCount = 6;
				data.cellRightCount = 3;
				data.tdLeftWidth = [ 10, 8, 12, 10, 10, 20 ];
				data.tdRightWidth = [ 12, 6, 12 ];

				//如果要修改表格内容 ，无需修改的忽略此项
				data.tdBeforeFill = function(obj) {
					//obj = {item,prop,html,row,col};
					//item 当前行数据
					//prop 当前单元格属性
					//html 当前单元格html内容
					//row 当前行数
					//col 当前列数
					if (obj.row > 1 && obj.col == 2) {//当前工作流状态
						var job = Work.getJob($.extend(true, {}, obj.item));
						var html = job.getActionsHtml();
						return html;
					}
					if (obj.col == 4 && obj.row >= 2) {
						if (obj.item.aptp == "02") {//审核不通过显示红色
							return "<span style='color:red;'>" + obj.html
									+ "</span>";
						}
					}
					return obj.html;
				}
				//操作栏的宽度
				callback.call(_this, data);
				if (TmplUtils.pageTmpl.refresh) {
					TmplUtils.pageTmpl.refresh();
				}
				TmplUtils.tableOnLoad();
			}
			if (firstLoad) {
				if (start != null) {
					var paramData = param;
					paramData.starts = start;
					paramData.ends = ends;
					paramData.queryDate = "pdrt";
					paramData.upState = state;
					$("select[name=queryDate]").val("pdrt");
					TmplUtils.searchParam = "&starts=" + start + "&ends="
							+ ends + "&upState=" + state + "&queryDate=pdrt";
					param = "";
					for ( var key in paramData) {
						param = param + "&" + key + "=" + paramData[key];
					}
					param = param.substr(1, param.length);
					View.get(url, param, _succ, function(code) {
						layer.msg('查询出错', {
							icon : 5
						});
					});
				} else {
					var paramData = param;
					var _url = "/businessDay/get";
					View.get(_url, "date=" + date + "&count=1", function(data) {
						if (data && data.length > 0) {
							var tempdate = Utils.getDate(data[0]);
							$("input[name=starts]").val(tempdate);
							$("input[name=ends]").val(tempdate);
							paramData.starts = tempdate;
							paramData.ends = tempdate;
							paramData.queryDate = "tstm";
							TmplUtils.searchParam = "&starts=" + tempdate
									+ "&ends=" + tempdate + "&queryDate=tstm";
							$("select[name=queryDate]").val("tstm");
							param = "";
							for ( var key in paramData) {
								param = param + "&" + key + "="
										+ paramData[key];
							}
							param = param.substr(1, param.length);
							View.get(url, param, _succ, function(code) {
								layer.msg('查询出错', {
									icon : 5
								});
							});
						}
					}, function() {
						TmplUtils.showMsgFail("时间获取失败");
					})
				}
				firstLoad = false;
			} else {
				View.get(url, param, _succ, function(code) {
					layer.msg('查询出错', {
						icon : 5
					});
				});
			}
		}
		tmpl.bind(_bind);
	}
	//表格单元格点击事件
	function bindPro(item) {
		if (!TmplUtils.isEditing) {
			this.item = item;
			previewTmpl.refresh();
		}
	}

	//预览绑定
	var previewTmpl;
	function previewOnBind(attrs, param) {
		tmpl = this;
		previewTmpl = tmpl;
		if (!item) {
			return;
		}
		tmpl.bind(function(callback) {
					var url = Const.apiUrl + "/suspiciouss/get";
					var data = {};
					//是否可编辑
					data.canEdit = false;
					data.data = item;
					if (data.data.job && data.data.job.curJobState) {
						var confirmStatus = data.data.job.curJobState;
					}
					//绑定点击事件
					data.checkClick = "check";
					data.saveClick = "save";
					callback.call(this, data);
					TmplUtils.previewOnLoad();
				});
	}

	//查询条件绑定
	function filterCriteriaOnBind(attrs, param) {
		tmpl = this;
		var _this = this;
		tmpl.bind(function(callback) {
			var data = {};
			data.searchClick = "search";
			callback.call(_this, data);
			if (start) {
				$("input[name=starts]").val(start);
			}
			if (ends) {
				$("input[name=ends]").val(ends);
				$("select[name=queryDate]").val("tstm");
			}
			layui.form().render();
			TmplUtils.filterCriteriaOnLoad();
		});
	}
	//查询
	function search() {
		TmplUtils.searchParam = Utils.formToStr("filterCriteria");
		if (TmplUtils.searchParam.indexOf('PRE_EXPORTOVER') > 0) {
			$("#edits-data").attr("class",
					"layui-btn layui-btn-normal layui-btn-small modal-full");
		} else {
			$("#edits-data").attr("class",
					"layui-btn layui-btn-disabled layui-btn-small modal-full");
		}
		tbTmpl.refresh("pindex=0" + "&pcount=" + TmplUtils.pageSize
				+ TmplUtils.searchParam);
		TmplUtils.currPage = 1;
		TmplUtils.closePreview();
	}
	//弹出添加iframe
	function edit(id, state) {
		var url = "suspiciousEdit.html?state=" + state + "&id=" + id;
		var title = "数据处理";
		View.openDialog(url, title);
	}

	function suspEdit(id) {
		var url = "suspiciousTransEdit.html?id=" + id;
		var title = "数据处理";
		View.openDialog(url, title);
	}

	function checkC(id) {
		var url = Const.apiUrl + "/suspiciouss/get";
		View.get(url, "id=" + id, function(suspicious) {
			url = Const.apiUrl + "/suspiciouss/check";
			View.post(url, suspicious, function(resp) {
				var data;
				if (resp.reason != null) {
					data = resp.reason.split(",");
				}
				var ht = "";
				if (!data) {
					submit(suspicious);
				} else {
					var count = 0;
					for ( var i in data) {
						count++;
						var need = data[i].split(":")[1];
						ht += "<p>" + count + "、" + need + "</p>"
					}
					tbTmpl.refresh("pindex=" + (TmplUtils.currPage - 1)
							+ "&pcount=" + TmplUtils.pageSize
							+ TmplUtils.searchParam);
					previewTmpl.refresh();
					top.layer.open({
						content : resp.indexOf(":")<0?"状态已经发生改变，操作失败":ht,
						btn : [ '关闭' ],
						yes : function(index, layero) {
							top.layer.closeAll();
						},
						cancel : function() {
						}
					});
				}
			}, function(code) {
				TmplUtils.showMsgFail('操作失败');
			});

		}, function() {
			TmplUtils.showMsgFail('信息获取失败');
		});
	}

	//保存
	function save() {
		var url = Const.apiUrl + "/suspiciouss/addOrUpdate"
		var suspicious = Utils.formToObj("preview");
		View.post(url, suspicious, function(resp) {
			TmplUtils.showMsgSuccess('编辑成功');
			tbTmpl.refresh("pindex=" + (TmplUtils.currPage - 1) + "&pcount="
					+ TmplUtils.pageSize + TmplUtils.searchParam);
			TmplUtils.closePreview();
		}, function() {
			TmplUtils.showMsgSuccess('编辑失败');
		})
	}

	function openReason(resp) {
		var ht = '';
		var data = resp.split(",");
		var count = 0;
		for ( var i in data) {
			var name = data[i].split(":")[0];
			var need = data[i].split(":")[1];
			if(!!need){
				count++;
				ht += "<p>" + count + "、" + need + "</p>";
			}
		}
		if(resp.indexOf("State has changed")>-1){
			TmplUtils.showMsgFail("状态已经发生改变，操作失败");
		}else if(resp.indexOf(":")>-1){
			top.layer.open({
				content : ht,
				btn : [ '关闭' ],
				yes : function(index, layero) {
					top.layer.closeAll();
				},
				cancel : function() {
				}
			});
		}else{
			TmplUtils.showMsgFail(resp);
		}
	}

	//删除
	function del() {
		var arrChk = $("input[name='tdCheckbox']");
		var ids = [];
		$(arrChk).each(function() {
			if ($(this).next('div').hasClass("layui-form-checked")) {
				ids.push($(this).data("id"));
			}
		});
		if (ids == "") {
			TmplUtils.showMsgFail('请选择一条或多条数据');
		} else {
			TmplUtils.showConfirm('您确定删除该数据吗？', '确定', '取消', function() {
				var url = Const.apiUrl + "/suspiciouss/delMore"
				View.post(url, ids, function(resp) {
					if (resp > 0) {
						TmplUtils.showMsgFail(resp + '条记录删除失败');
					} else {
						TmplUtils.showMsgSuccess("删除成功");
					}
					tbTmpl.refresh("pindex=" + (TmplUtils.currPage - 1)+
							"&pcount=" + TmplUtils.pageSize+ TmplUtils.searchParam);
				}, function() {
					TmplUtils.showMsgFail('删除失败', {
						icon : 5
					});
				});
			}, function() {
			});
		}
	}
	function addMore() {
		layer.open({
			type : 2,
			title : '可疑批量导入',
			shadeClose : true,
			shade : false,
			maxmin : false, //开启最大化最小化按钮
			area : [ '100%', 'auto' ],
			offset : '0px',
			move : false,
			content : 'suspiciousAddMore.html'
		});
		parent.startInit(document.getElementsByTagName("iframe")[0], 560);
	}
</script>
</html>