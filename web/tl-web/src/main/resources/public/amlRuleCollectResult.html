<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>数据采集</title>
<link type="include" href="/common/depcss.html" />
</head>

<body>
	<div class="content">
		<div class="layui-elem-field">
			<div class="group-button FL">
				<div class="layui-input-inline dateInput" style="margin-left: 0;">
					<input class="layui-input" placeholder="采集日期" id="LAY_demorange_s">
				</div>
				<button
						class="layui-btn layui-btn-normal layui-btn-small modal-full fun_ bigcollect_"
						id="add-data_big">
					<i class="layui-icon">&#xe608;</i> 大额采集
				</button>
				<button
						class="layui-btn layui-btn-normal layui-btn-small modal-full fun_ suscollect_"
						id="add-data_sus">
					<i class="layui-icon">&#xe608;</i> 可疑采集
				</button>
				<button
					class="layui-btn layui-btn-normal layui-btn-small modal-full fun_ collect_"
					id="add-data">
					<i class="layui-icon">&#xe608;</i> 采集
				</button>
			</div>
			<span class="_tmpl layui-inline last-a-time" id="rateTime"></span>
			<div class="clear"></div>
		</div>
		<div class="clear"></div>
		<div class="contentLeft layui-form">
			<div class="_tmpl" data-url="amlRuleCollect.html"
				data-attr="amlRuleCollectResult.json" data-bind="getLastData"
				data-param=""></div>
		</div>
	</div>
</body>
<link type="include" href="/common/depjs.html" />
<script>
layui.use('laydate', function() {
	var laydate = layui.laydate;
	var start = {
		max : '2099-06-16 23:59:59',
		istoday : true,
	};
	document.getElementById('LAY_demorange_s').onclick = function() {
		start.elem = this;
		laydate(start);
	}
});
//获取时间
function getSysDate(flag){
	var myDate = new Date();
	var month = (myDate.getMonth()+1) < 10 ? "0"+(myDate.getMonth()+1) : (myDate.getMonth()+1);
	var weekday = myDate.getDay() == 0 ? 7 : myDate.getDay();
	var d = myDate.getDate();
	var day = d < 10 ? "0" + d : d;
	var sysDate = myDate.getFullYear()+"-"+month+"-"+day;
	return sysDate;
}

function getBeforeDate(n){
    var n = n;
    var d = new Date();
    var year = d.getFullYear();
    var mon=d.getMonth()+1;
    var day=d.getDate();
    if(day <= n){
            if(mon>1) {
               mon=mon-1;
            }
           else {
             year = year-1;
             mon = 12;
             }
           }
          d.setDate(d.getDate()-n);
          year = d.getFullYear();
          mon=d.getMonth()+1;
          day=d.getDate();
     s = year+"-"+(mon<10?('0'+mon):mon)+"-"+(day<10?('0'+day):day);
     return s;
}
</script>
<script>

$(document).ready(
	function onload(){
		$("#LAY_demorange_s").attr("value",getBeforeDate(0));
	}
);

	var batchId = "";
	$(function() {
		$("#add-data").click(function() {
            if($(this).hasClass("layui-btn-disabled")){
                return;
            }
            collect(3);
		});
        $("#add-data_big").click(function() {
            if($(this).hasClass("layui-btn-disabled")){
                return;
            }
            collect(1);
        });
        $("#add-data_sus").click(function() {
            if($(this).hasClass("layui-btn-disabled")){
                return;
            }
            collect(2);
        });
	});

	function collect(type) {
        $(".layui-btn").addClass("layui-btn-disabled");
        $(".layui-btn").removeClass("layui-btn-normal");
        var url = Const.apiUrl + "/amlRuleCollectResult/collect";
        var start = $("#LAY_demorange_s").val();
        View.get(url, {"start":start,"type":type}, function(resp) {
            batchId = resp.batchId;
            tbTmpl.refresh();
            polling(2000);
        }, function() {
            TmplUtils.showMsgFail("采集失败");
            $(".layui-btn").removeClass("layui-btn-disabled");
            $(".layui-btn").addClass("layui-btn-normal");
        });
    }
	var tbTmpl;
	function getLastData(attrs, param) {
		var tmpl = this;
		tbTmpl = tmpl;
		tmpl.bind(function(callback) {
			var url = Const.apiUrl + "/amlRuleCollectResult/getLast";
			View.get(url, {"batchId":batchId}, function(resp) {
				var data = {};
				data.data = resp;
				if(data.data.dateCreate){
                    $("#rateTime").html('最后一次采集时间:' + Utils.getDatetime(data.data.dateCreate));
				}
				try {
                    data.data.rpdt = JSON.parse(resp.data).date;
				}catch (e){

				}

/*                if (resp.status == 2) {
                    batchId = resp.batchId;
                    $(".layui-btn").addClass("layui-btn-disabled");
                    $(".layui-btn").removeClass("layui-btn-normal");
                    polling(2000);
                }*/
				callback.call(tbTmpl, data);
				TmplUtils.tableOnLoad();
			}, function() {
				TmplUtils.showMsgFail("加载数据失败");
			});
		});
	}

	function polling(t) {
		window.setTimeout(function() {
			var url = Const.apiUrl + "/amlRuleCollectResult/getLast";
			View.get(url, {"batchId":batchId}, function(resp) {
				if (resp.status == 2) {
					polling(t);
                    return;
				}
				tbTmpl.refresh();
                $(".layui-btn").removeClass("layui-btn-disabled");
                $(".layui-btn").addClass("layui-btn-normal");
                TmplUtils.showMsgSuccess("采集成功");
			},function(){
 	    		 TmplUtils.showMsgFail('操作失败');
 	    	 });
		}, t);
	}
</script>
</html>