<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<title>dialog2</title>
	<meta name="renderer" content="webkit">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<link type="include" href="/common/depcss.html" />
</head>
<body class="iframeBody">
<div class="formbox layui-form">
	<div class="content">
		<div class="layui-elem-field">
			<div class="group-button FL">
			</div>
			<div class="_tmpl" data-url="filterCriteria.html"
				 data-attr="zipFile.json" data-bind="filterCriteriaOnBind"
				 data-param=""></div>
			<div class="clear"></div>
		</div>
		<div class="clear"></div>
		<div class="contentLeft layui-form">
			<div class="_tmpl" data-url="table.html" id="table"
				 data-attr="zipFile.json" data-bind="tbOnBind"
				 data-param="pindex=0&pcount=10"></div>
		</div>
		<div style="clear: both"></div>
		<div class="_tmpl" data-url="pages.html" data-depend="table"
			 data-attr="zipFile.json" data-bind="TmplUtils.pagesOnBind"
			 data-param=""></div>
	</div>
</div>
</body>
<link type="include" href="/common/depjs.html" />
<script>
	$(function() {
	    var form = layui.form();
	    //监听提交
	    form.on('submit', function(data) {
	        return false;
	    });
	});
    var form = layui.form(), layer = layui.layer;
    //全选
    form.on('checkbox(allChoose)', function (data) {
        var child = $(data.elem).parents('table').find(
            'tbody input[type="checkbox"]');
        child.each(function (index, item) {
            item.checked = data.elem.checked;
        });
        form.render('checkbox');
    });
</script>
<script>
    var item = {};
    var tbTmpl;
    var date = Utils.getDate(new Date().getTime()-24*60*60*1000);
    function forbbit(id) {

    }
    var firstLoad= true;
	var type = View.getQStr('type');
    function tbOnBind(attrs,param){
        tmpl = this;
        tbTmpl = tmpl;
        tmpl.bind(function(callback) {
            var url = Const.apiUrl+"/dataExport/getZip";
            var _this = this;
            if(firstLoad){
                var url_day = "/businessDay/get";
                View.get(url_day,"date="+date+"&count=1",function (data) {
                    if(data && data.length > 0){
                        $("input[name=creatTime]").val(type==null?Utils.getDate(data[0]):Utils.getDate(new Date()));
                        $("select[name=type]").val(type);
                        param = "&creatTime="+(type==null?Utils.getDate(data[0]):Utils.getDate(new Date()))+"&type="+(type==null?'':type);
                        TmplUtils.searchParam=param;
                        View.get(url,param,function(resp){
                            var data={};
                            if(resp){
                                data.data = resp;
                                TmplUtils.totalPages = data.data.totalPages;
                                TmplUtils.totalCount = data.data.totalElements;
                            }
                            data.hasOperation = true;
                            data.operationWidth = 5;
                            data.tdLeftWidth = [ 35, 20, 20,20];
                            data.operations=[{"value":"下载","onclick":"downLoad(this);","class":"layui-btn layui-btn-mini layui-btn-normal fun_ getzip_"}];
                            data.trClick = "bindPro";
                            TmplUtils.isEditing = true;//禁止打开侧边栏
                            callback.call(_this, data);
                            if(TmplUtils.pageTmpl){
                                TmplUtils.pageTmpl.refresh();
                            }
                            TmplUtils.tableOnLoad();
                        },function(code) {
                            layer.msg('查询出错', {icon: 5});
                        });
                    }
                },function () {
                    TmplUtils.showMsgFail("时间获取失败");
                })
                firstLoad= false;
                return;
            }
            View.get(url,param,function(resp){
                var data={};
                if(resp){
                    data.data = resp;
                    TmplUtils.totalPages = data.data.totalPages;
                    TmplUtils.totalCount = data.data.totalElements;
                }
                data.hasOperation = true;
                data.operationWidth = 5;
                data.tdLeftWidth = [ 35, 20, 20,20];
                data.operations=[{"value":"下载","onclick":"downLoad(this);","class":"layui-btn layui-btn-mini layui-btn-normal fun_ getzip_"}];
                data.trClick = "bindPro";
                TmplUtils.isEditing = true;//禁止打开侧边栏
                callback.call(_this, data);
                if(TmplUtils.pageTmpl){
                	TmplUtils.pageTmpl.refresh();
                }
                TmplUtils.tableOnLoad();
                TmplUtils.isEditing = true;
            },function(code) {
                layer.msg('查询出错', {icon: 5});
            });
        });
    }

    function downLoad(row){
        $(row).parent().parent().click();
        var url = Const.apiUrl + "/dataExport/downLoad";
        var param ="name="+item.name+"&type="+item.type
        window.open(Const.apiUrl + "/dataExport/downLoad"+"?name="+item.name+"&type="+item.type);
    }


    function bindPro(item) {
        this.item = item;
    }

    //查询条件绑定
    function filterCriteriaOnBind(attrs, param) {
        tmpl = this;
        var _this = this;
        tmpl.bind(function(callback) {
            var data = {};
            data.searchClick = "search";
            callback.call(_this, data);
            TmplUtils.filterCriteriaOnLoad();
        });
    }
    //查询
    function search() {
        TmplUtils.searchParam = Utils.formToStr("filterCriteria");
        tbTmpl.refresh("pindex=0" + "&pcount=" + TmplUtils.pageSize
            + TmplUtils.searchParam);
        TmplUtils.currPage = 1;
        TmplUtils.closePreview();
    }

</script>
</html>