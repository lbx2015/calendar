<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>黑白名单批量导入</title>
<meta name="renderer" content="webkit">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport"
	content="width=device-width, initial-scale=1, maximum-scale=1">
<link type="include" href="/common/depcss.html" />
</head>
<body>
	<div class="formbox layui-form " style="padding: 70px 0 20px;">
		<div id="tb2"></div>
		<div class="layui-btn-div">
			<a class="layui-btn bgc1 layui-btn-mini" lay-submit lay-filter="edit"
				href="javascript:importData()">上传</a>
			<a class="layui-btn layui-btn-primary layui-btn-mini"
				onclick="parent.layer.close(parent.layer.getFrameIndex(window.name));">返回</a>
		</div>
	</div>
<script id="lab2" type="text/tmpl">
<form class="layui-input-inline" target="layui-upload-iframe" method="post" key="set-mine" id="addMore" enctype="multipart/form-data"  action="">
<input type = 'hidden' name = "userName" value='{{=  View.getRes().getUser().userName }}' />
{{# for(var key in  d){ }}
    <div class="layui-form-item">
		{{# var name = key=='mdly'?'名单来源':"名单类型" }}
		<label class="layui-form-label">{{=name }}：</label>
		<div class="layui-input-inline" >
			<select name="{{=key}}" lay-filter="{{= key}}">
				{{# for(var i = 0 ;i<d[key].length;i++){ }}
					<option value="{{=d[key][i].ke}}">{{=d[key][i].valu }}</option>
				{{# } }}
			</select>
		</div>
	</div>
{{# } }}
	<div class="layui-form-item">
		<label class="layui-form-label">名单路径：</label>
		<div class="layui-input-inline">
			<input type="text" name="upfile" id="upfile" readonly= "true " autocomplete="off" class="layui-input"/> 
		</div>
		<div class="layui-box layui-upload-button">
			<input type="file" name="bw" id="bw" lay-type="file" class="layui-upload-file" onchange="upfile.value=this.value"/>
			<span class="layui-upload-icon"><i class="layui-icon"></i>上传文件</span>
		</div>
    </div>
	<div class="layui-form-item" style="margin-top:15px;">
		<label class="layui-form-label"></label>
		<div class="layui-input-inline">
			<a href="" class="layui-btn layui-btn-normal" id="downLoad"><i class="layui-icon">&#xe601;</i>下载黑白名单excel表格模板</a>
		</div>
    </div>
</form>
</script>
</body>
<link type="include" href="/common/depjs.html" />
<script type="text/javascript" src="{=ctx}/js/jquery/jquery.form.js"></script>
<script type="text/javascript">
	var tmpl = null;
	$(document).ready(function() {
		var tp = new View.Tmpl({
			"container" : $("#tb2"),
			"tmpl" : $("#lab2").html()
		});
		tp.onload(function() {
			tp.bind(function(callback) {
				var _this = this;
				var url = "/blackWhiteList/getEnumData";
				setTimeout(function(){
				    View.get(url,'',function(resp){
						callback.call(_this, resp);
					},function(code){
						TmplUtils.showMsgFail('查询失败');
					});
				},0);
				
			});
		}, "index=1");
		tp.onFinish(function(){
			$("#downLoad").attr("href",Const.apiUrl + "/excelModel/blackWhiteModel.xlsx");
		});
		//tp.refresh("index=2");
	});
	
	 var form = layui.form()
     form.on('select(mdly)', function(data){
    	 if(data.value==1){
    		 $("#downLoad").attr("href",Const.apiUrl + "/excelModel/1-支持恐怖活动国家.xlsx");
    	 }else if(data.value==2){
    		 $("#downLoad").attr("href",Const.apiUrl + "/excelModel/2-风险国家.xlsx");
    	 }else if(data.value==3){
    		 $("#downLoad").attr("href",Const.apiUrl + "/excelModel/3-贩毒严重地区-国际.xlsx");
    	 }else if(data.value==4){
    		 $("#downLoad").attr("href",Const.apiUrl + "/excelModel/4-天网名单.xlsx");
    	 }else if(data.value==5){
    		 $("#downLoad").attr("href",Const.apiUrl + "/excelModel/5-公安查控.xlsx");
    	 }else{
    		 $("#downLoad").attr("href",Const.apiUrl + "/excelModel/blackWhiteModel.xlsx");
    	 }
    	
	});  
	
	function checkData() {
		var fileDir = $("#bw").val();
		var suffix = fileDir.substr(fileDir.lastIndexOf("."));
		if ("" == fileDir) {
			alert("选择需要导入的Excel文件！");
			return false;
		}
		if (".xls" != suffix && ".xlsx" != suffix) {
			alert("选择Excel格式的文件导入！");
			return false;
		}
		return true;
	}

	function importData() {
		if (!checkData()) {
			return;
		}
		var addMoreUrl =  Const.apiUrl + "/blackWhiteList/addMore";
		$("#addMore").attr("action", addMoreUrl);
	    $('#addMore').ajaxSubmit(
			{
				type : 'post',
				url : addMoreUrl,
				dataType : 'text',
				success : function(resp) {
					if (resp== 0) {
						TmplUtils.showMsgFail("导入失败");
					}else if(resp<0){
						TmplUtils.showMsgFail("导入操作出错，名单来源与模板不一致");
					} else {
						TmplUtils.showMsgSuccess('导入成功');
						parent.tbTmpl.refresh("pindex="
								+ (parent.TmplUtils.currPage - 1)
								+ "&pcount=" + TmplUtils.pageSize
								+ TmplUtils.searchParam);
						parent.previewTmpl.refresh();
						var index = parent.layer
								.getFrameIndex(window.name); //获取窗口索引
						parent.layer.close(index);
					}
				},
				error : function(code) {
					TmplUtils.showMsgFail('导入失败');
				}
			});
	}
</script>
</html>
