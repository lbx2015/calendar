<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>SuspiciousReport</title>
<link type="include" href="/common/depcss.html" />
</head>
<body>
	<div class="content">
		<div class="layui-elem-field">
			<div class="layui-input-inline" style="margin-left: 0;">
				<input class="layui-input" placeholder="查询日期" id="LAY_demorange_s">
			</div>
			<div class="layui-input-inline">
						<input class="layui-input" placeholder="截止日期" id="LAY_demorange_e">
					</div>
			<div class="layui-input-inline">
				<button class="layui-btn" id="echarts_s" onclick="search()">查询</button>
			</div>
			<div class="clear"></div>
		</div>
		<div class="clear"></div>
		<div class="viewBox">
			<div id="suspTransaction1" class="panel rowView"></div>
			<div id="suspTransaction2" class="panel rowView"></div>
			<div id="suspCustomer" class="panel rowView"></div>
			<div id="suspIndustry" class="FL panel"></div>
			<div id="CustomerArea" class="FR panel"></div>
			<div class="clear"></div>
			<div id="tranMethod" class="rowView panel"></div>
			<div id="suspRule" class="FL panel"></div>
			<div id="suspDistribution" class="FR panel"></div>
		</div>
	</div>
</body>
<link type="include" href="/common/depjs.html" />
<script type="text/javascript" src="{=ctx}/echarts/echarts.min.js"></script> 
<!-- <script type="text/javascript" src="{=ctx}/echarts/world.js"></script> -->
<script type="text/javascript" src="{=ctx}/js/util/eChartUtils.js"></script>
<script>
	layui.use('laydate', function() {
		var laydate = layui.laydate;
		var start = {
			max : '2099-06-16 23:59:59',
			istoday : true,
			choose: function(datas){
			      end.min = datas; //开始日选好后，重置结束日的最小日期
			      end.start = datas //将结束日的初始值设定为开始日
			    }
		};
		var end = {
				//min : laydate.now(),
				max : '2099-06-16 23:59:59',
				istoday : true,
				choose : function(datas) {
					start.max = datas; //结束日选好后，重置开始日的最大日期
				}
			};

			document.getElementById('LAY_demorange_s').onclick = function() {
				start.elem = this;
				laydate(start);
			}
			document.getElementById('LAY_demorange_e').onclick = function() {
				end.elem = this
				laydate(end);
			}
	});
    $(function () {
        var url = "/businessDay/get";
        View.get(url,"date="+getSysDate()+"&count=1",function (data) {
            if(data && data.length > 0){
                $("#LAY_demorange_s").val(Utils.getDate(data[0]));
                $("#LAY_demorange_e").val(Utils.getDate(data[data.length-1]));
                search();
            }
        },function () {
            TmplUtils.showMsgFail("时间获取失败");
        })
    });
	//获取时间
	function getSysDate() {
        var myDate = new Date(new Date().getTime()-24*60*60*1000);
        return Utils.getDate(myDate);
	}
</script>
<script type="text/javascript">
    var start;
    var end;
	function search() {
		start = document.getElementById('LAY_demorange_s');
		end = document.getElementById('LAY_demorange_e');
        if (!start.value) {
        	TmplUtils.showMsgFail('请填写开始时间');
            return;
        } if (!end.value) {
        	TmplUtils.showMsgFail('请填写结束时间');
            return;
        }
		tu12Bind();
		tu3Bind();
		tu4Bind();
		tu5Bind();
		tu6Bind();
		tu7Bind();
	}
	//可以交易
	function tu12Bind() {
		var url = Const.apiUrl + "/riskDataReports/getDistCustomer";
		var param = "&start=" + start.value+"&end="+end.value;
		View.get(url, param, function(resp) {
			//收入
			var names = [];
			var seri1 = {};
			var income = [];
			var csnms = [];
			//var seri3 = {};
			var out = [];
			seri1.name = '可疑交易-收入';
			for (var i = 0; i < resp.length; i++) {
				names.push(resp[i].ctid+"-"+resp[i].str);
				income.push(resp[i].num1);
				//csnms.push(resp[i].csnm);
			}
			seri1.data = income;
			//seri2.csnm = csnms;
			//seri1.csnm = csnms;
			var serirs = [ seri1];
			var chart1 = EChartUtils.generateStackedBarChart("suspTransaction1",
					[ '可疑交易-收入'], names, serirs);
			chart1.on('click', otherView);
			//支出
			var names = [];
			var csnms = [];
			var seri2 = {};
			//var seri3 = {};
			var out = [];
			seri2.name = '可疑交易-支出';
			for (var i = 0; i < resp.length; i++) {
				names.push(resp[i].ctid+"-"+resp[i].str);
				out.push(resp[i].num2);
				//csnms.push(resp[i].csnm);
			}
			seri2.data = out;
			var serirs = [ seri2 ];
			var chart1 = EChartUtils.generateStackedBarChart("suspTransaction2",
					[ '可疑交易-支出' ], names, serirs);
			chart1.on('click', otherView);
			//图二 可以交易和客户top10
			var namesT2 = [];
			var serirsT2 = [];
			resp.sort(function(a, b) {
				return b.num1 + b.num2 - a.num1 - a.num2
			});
			var len = resp.length > 10 ? 10 : resp.length;
			for (var i = 0; i < len; i++) {
				var seriT2 = {};
				namesT2.push(resp[i].str);
				seriT2.name = resp[i].str;
				seriT2.value = resp[i].num1 + resp[i].num2;
				seriT2.csnm = resp[i].ctid;
				seriT2.start = start.value;
				seriT2.end = end.value;
				serirsT2.push(seriT2);
			}
			var titleT2 = {
				text : '可疑交易客户Top10',
				subtext : start.value+'-'+end.value,
				x : 'center'
			};
			var serirsDataT2 = {
				name : '客户名称',
				data : serirsT2
			}
			var serirsDatasT2 = [ serirsDataT2 ];
			var chart2 = EChartUtils.pieChart("suspCustomer", titleT2, namesT2,
					serirsDatasT2);
			chart2.on('click', view);
		}, function(code) {
			layer.msg('查询出错', {
				icon : 5
			});
		});
	}
	//可以交易行业
	function tu3Bind() {
		var url = Const.apiUrl + "/riskDataReports/getWork";
		var param = "&start=" + start.value+"&end="+end.value;
		View.get(url, param, function(resp) {
			var namesT3 = [];
			var serirsT3 = [];
			var titleT3 = {
				text : '可疑交易行业/职业Top5',
				subtext : start.value+'-'+end.value,
				x : 'center'
			};
			resp.sort(function(a, b) {
				return b[1] - a[1]
			});
			var len = resp.length > 5 ? 5 : resp.length;
			for (var i = 0; i < len; i++) {
				if(!resp[i].str){
					resp[i].str='未知行业';
				}
				var seriT3 = {};
				namesT3.push(resp[i].str);
				seriT3.name = resp[i].str;
				seriT3.value = resp[i].num1;
				serirsT3.push(seriT3);
			}
			var serirsDataT3 = {
				name : '行业/职业名称',
				data : serirsT3
			}
			var serirsDatasT3 = [ serirsDataT3 ];
			EChartUtils.pieChart("suspIndustry", titleT3, namesT3,
					serirsDatasT3);
		}, function(code) {
			layer.msg('查询出错', {
				icon : 5
			});
		});
	}
	//可疑客户地区分布
	function tu4Bind() {
		var url = Const.apiUrl + "/riskDataReports/getArea";
		var param = "&start=" + start.value+"&end="+end.value;
		View.get(url, param, function(resp) {
			var xAxisData = [];
			var seriesData = [];
			var seriesList = [];
			var series = {};
			var titleT4 = {
				text : '客户地区分布',
				subtext : start.value+'-'+end.value,
				x : 'center'
			};
			for (var i = 0; i < resp.length; i++) {
				if(!resp[i].str){
					resp[i].str='未知地区';
				}
				xAxisData.push(resp[i].str);
				seriesData.push(resp[i].num1);
			}
			series.name = "交易数量";
			series.data = seriesData;
			seriesList.push(series);
			EChartUtils.juxingChart("CustomerArea", titleT4, xAxisData,
					seriesList);
		}, function(code) {
			layer.msg('查询出错', {
				icon : 5
			});
		});
	}
	//可疑交易方式
	function tu5Bind() {
		var url = Const.apiUrl + "/riskDataReports/getWay";
		var param = "&start=" + start.value+"&end="+end.value;
		View.get(url, param, function(resp) {
			var titleT5 = {
				text : '交易方式分布圈',
				subtext : start.value+'-'+end.value,
				x : 'center'
			};
			var names = [];
			var seriesData = [];
			for (var i = 0; i < resp.length; i++) {
				if(!resp[i].str){
				resp[i].str='无交易方式';
			}
				names.push(resp[i].str);
				var data = {};
				data.name = resp[i].str;
				data.value = resp[i].num1;
				seriesData.push(data);
			}
			var series = {};
			series.data = seriesData;
			series.radius = [ '40%', "60%" ];
			series.center= ['70%', '50%'];
			var seriesList = [];
			seriesList.push(series);
			EChartUtils.pieChart("tranMethod", titleT5, names, seriesList);
		}, function(code) {
			layer.msg('查询出错', {
				icon : 5
			});
		});
	}

	//图六 资金流向
	function tu6Bind() {
		var url = Const.apiUrl + "/riskDataReports/getFlow";
		var param = "&start=" + start.value+"&end="+end.value;
		View.get(url, param, function(resp) {
			var titleT6 = {
				text : '资金流向分布',
				subtext : start.value+'-'+end.value,
				x : 'center'
			};
			var names = [];
			var seriesData = [];
			for (var i = 0; i < resp.length; i++) {
				if(!resp[i].str){
					resp[i].str='未填写资金流向';
				}
				names.push(resp[i].str);
				var data = {};
				data.name = resp[i].str;
				data.value = resp[i].num1;
				seriesData.push(data);
			}
			var series = {};
			series.data = seriesData;
			series.radius = [ '20%', "50%" ];
			var seriesList = [];
			seriesList.push(series);
			EChartUtils
					.pieChart("suspDistribution", titleT6, names, seriesList);
		}, function(code) {
			layer.msg('查询出错', {
				icon : 5
			});
		});
	}

	//图七可疑规则分布
	function tu7Bind() {
		var url = Const.apiUrl + "/riskDataReports/getRule";
		var param = "&start=" + start.value+"&end="+end.value;
		View.get(url, param, function(resp) {
			var titleT6 = {
				text : '可疑规则分布',
				subtext : start.value+'-'+end.value,
				x : 'center'
			};
			var names = [];
			var seriesData = [];
			for (var i = 0; i < resp.length; i++) {
				names.push(resp[i].ctid);
				var data = {};
				data.name = resp[i].ctid;
				data.value = resp[i].num1;
				seriesData.push(data);
			}
			var series = {};
			series.data = seriesData;
			series.radius = [ '30%', "60%" ];
			var seriesList = [];
			seriesList.push(series);
			var chart = EChartUtils.pieChart("suspRule", titleT6, names,
					seriesList);
		}, function(code) {
			layer.msg('查询出错', {
				icon : 5
			});
		});
	}

	function view(param) {
		var csnm = param.data.csnm;
		window.location.href = "customerDataReport.html?tcid=" + csnm
				+ "&start=" + start.value+"&end="+end.value;
	}
	
	function otherView(param){
		var csnm = param.name.split("-")[0];
		window.location.href = "customerDataReport.html?tcid=" + csnm
				+ "&start=" + start.value+"&end="+end.value;
	}
</script>




</html>