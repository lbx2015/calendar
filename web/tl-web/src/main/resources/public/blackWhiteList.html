<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>黑白名单list页面 </title>
<link type="include" href="/common/depcss.html" />
</head>

<body class="iframeBody">
	<div class="content">
		<div class="layui-elem-field">
			<div class="group-button FL">
				<button
					class="layui-btn layui-btn-normal layui-btn-small modal-full  fun_ addmore_"
					id="addMore-data" onclick="addMore()">
					<i class="layui-icon">&#xe608;</i>批量导入
				</button>
				<button
					class="layui-btn layui-btn-normal layui-btn-small modal-full fun_ add_"
					id="add-data">
					<i class="layui-icon">&#xe608;</i> 添加
				</button>
				<button
						class="layui-btn layui-btn-normal layui-btn-small modal-full fun_ flashback_" id="flash-back">
					<i class="layui-icon">&#xe608;</i><span id="flashbackSpan"> 回溯</span>
				</button>
			</div>
			<div class="_tmpl" data-url="filterCriteria.html"
				data-attr="blackWhiteList.json" data-bind="filterCriteriaOnBind"
				data-param=""></div>
			<div class="clear"></div>
		</div>
		<div class="clear"></div>
		<div class="contentLeft layui-form">
			<div class="_tmpl" data-url="table.html" id="table"
				data-attr="blackWhiteList.json" data-bind="tbOnBind"
				data-param="pindex=0&pcount=10"></div>
		</div>
		<div class="contentRight">
			<div class="_tmpl" data-url="preview.html"
				data-attr="blackWhiteList.json" data-bind="previewOnBind"
				data-param=""></div>
		</div>
		<div style="clear: both"></div>
		<div class="_tmpl" data-url="pages.html"
			data-attr="blackWhiteList.json" data-depend="table" data-bind="TmplUtils.pagesOnBind" data-param=""></div>
	</div>
</body>
<link type="include" href="/common/depjs.html" />
<script>
	$(function() {
		$("#add-data").click(function() {
			layer.open({
				type : 2,
				title : '添加数据',
                shadeClose: true,
                shade: false,
                maxmin: false, //开启最大化最小化按钮
                area: ['100%', 'auto'],
                offset: '0px',
                move: false,
				content : 'blackWhiteEdit.html' //iframe的url
			});
			 parent.startInit(document.getElementsByTagName("iframe")[0], 560);
		});

		var form = layui.form();
		//监听提交
		form.on('submit', function(data) {
			return false;
		});
	});
	//批量导入
	function addMore() {
		layer.open({
			type : 2,
			title : '批量导入名单',
            shadeClose: true,
            shade: false,
            maxmin: false, //开启最大化最小化按钮
            area: ['100%', 'auto'],
            offset: '0px',
            move: false,
			content : 'blackWhiteListAddMore.html',
		});
        parent.startInit(document.getElementsByTagName("iframe")[0], 560);
	}
</script>
<script>
	var form = layui.form(), layer = layui.layer;
	//全选
	form.on('checkbox(allChoose)', function(data) {
		var child = $(data.elem).parents('table').find(
				'tbody input[type="checkbox"]');
		child.each(function(index, item) {
			item.checked = data.elem.checked;
		});
		form.render('checkbox');
	});
</script>
<script>
	function closePreview() {
		$(".contentLeft").removeClass("w1");
		$(".contentRight").removeClass("w2");
		$(".lay-tab-right").removeClass("w3");
	}
</script>
<script>

	var tbTmpl;
	function forbbit(id) {

	}
	function tbOnBind(attrs, param) {
		tmpl = this;
		tbTmpl = tmpl;
		var data = {};
		if (param.listType == '2') {
			if (attrs.attrs.length >= 3) {
				attrs.attrs.splice(1, 1);
			}
			data.attrs = attrs.attrs;
		}
		tmpl.bind(function(callback) {
			var url = Const.apiUrl + "/blackWhiteList/getMore";
			var _this = this;

			View.get(url, param, function(resp) {
				if (resp) {
					data.data = resp;
					TmplUtils.totalPages = data.data.totalPages;
					if(data.data.totalElements){
                        TmplUtils.totalCount = data.data.totalElements;
					}else{
                        TmplUtils.totalCount = 0;
					}
				}
				//是否需要全选checkbox
				data.hasCheckbox = true;
				data.hasOperation = true;
				//操作按钮
    			data.cellLeftCount=5
    			data.cellRightCount=2
    			data.operationWidth = 10;
				data.tdLeftWidth = [ 18, 18, 8,13,16];
				data.tdRightWidth = [15,15];
				data.operations = [ {
					value : "修改",
					onclick : "edit",
					'class':"layui-btn layui-btn-mini layui-btn-normal fun_ update_"
				}, {
					value : "删除",
					onclick : "del",
					'class':"layui-btn layui-btn-mini layui-btn-danger fun_ del_"
				} ];
				//tr的点击事件绑定，该方法会传入id 参数
				data.trClick = "bindPro";
				callback.call(_this, data);
				if(TmplUtils.pageTmpl.refresh){
                	TmplUtils.pageTmpl.refresh();
				}
				TmplUtils.tableOnLoad();
			}, function(code) {
				TmplUtils.showMsgFail('查询出错');
			});
		});
	}
	//表格单元格点击事件
	var item;
	function bindPro(item) {
		if (!TmplUtils.isEditing) {
			this.item = item;
			previewTmpl.refresh();
		}
	}

	var previewTmpl;
	function previewOnBind(attrs, param) {
		tmpl = this;
		previewTmpl = tmpl;
		if (!item) {
			return;
		}
		tmpl.bind(function(callback) {
			var data = {};
			//是否可编辑
			data.canEdit = true;
			data.data = item;
			//绑定点击事件
			data.checkClick = "check";
			data.saveClick = "save";
			if(item.id){
				var url = Const.apiUrl + "/blackWhiteList/get";
				View.get(url, "id=" + item.id, function(resp) {
					for (var i = 0; i < resp.length; i++) {
						data.enums[attrs.table].push(resp[i]);
					}
					data.saveClick = "edit";
				}, function(code) {
					TmplUtils.showMsgFail('查询出错');
				});
			}

			callback.call(this, data);
			TmplUtils.previewOnLoad();
		});
	}

	//查询条件绑定
	//查询条件绑定
	function filterCriteriaOnBind(attrs, param) {
		tmpl = this;
		var _this = this;
		tmpl.bind(function(callback) {
			var data = {};
			data.searchClick = "search";
			callback.call(_this, data);
			TmplUtils.filterCriteriaOnLoad();
		});
	}

	//查询
	var searchParam = "";
	function search() {
		TmplUtils.searchParam = Utils.formToStr("filterCriteria");
		tbTmpl.refresh("pindex=0" + "&pcount=" + TmplUtils.pageSize
				+ TmplUtils.searchParam);
		TmplUtils.closePreview();
	}

	//弹出添加iframe
	function edit(id) {
		layer.open({
			type : 2,
			title : '添加数据',
            shadeClose: true,
            shade: false,
            maxmin: false, //开启最大化最小化按钮
            area: ['100%', 'auto'],
            offset: '0px',
            move: false,
			content : 'blackWhiteEdit.html#' + id //iframe的url
		});
        parent.startInit(document.getElementsByTagName("iframe")[0], 560);
	}
	//保存
	function save() {
		var url = Const.apiUrl + "/blackWhiteList/addOrUpdate"
		var blackWhiteList = Utils.formToObj("preview");
		View.post(url, blackWhiteList, function(resp) {
			TmplUtils.showMsgSuccess('编辑成功');
			tbTmpl.refresh("pindex=" + (TmplUtils.currPage - 1) + "&pcount="
					+ TmplUtils.pageSize + TmplUtils.searchParam);
			TmplUtils.closePreview();
		}, function() {
			TmplUtils.showMsgFail('编辑失败');
		})
	}

	//删除
	function del(id) {
		var index = layer.confirm('您确定删除该数据吗？', {
			btn : [ '确定', '取消' ]
		}, function() {
			var url = Const.apiUrl + "/blackWhiteList/del"
			View.get(url, "id=" + id, function(resp) {
				TmplUtils.showMsgSuccess('删除成功');
				tbTmpl.refresh("pindex=" + (TmplUtils.currPage - 1)
						+ "&pcount=" + TmplUtils.pageSize
						+ TmplUtils.searchParam);
				layer.close(index);
			}, function() {
				TmplUtils.showMsgFail('删除失败');
			});
		}, function() {
		});
	}

	form.on('select(listType)', function(data) {
		if (data.value == 2) {
			$(data.elem).parent("div").next("div").hide();
		} else {
			$(data.elem).parent("div").next("div").show();
		}
		search();
	});

    form.on('select(liskGroup)', function(data) {
        if (data.value == 2) {
            $(data.elem).parent("div").next("div").hide();
        } else {
            $(data.elem).parent("div").next("div").show();
        }
        search();
    });
    var batchId;
    $().ready(function () {
        $("#flash-back").click(function() {
            if($(this).hasClass("layui-btn-disabled")){
                return;
            }
            var url = "/blackWhiteList/flashBack";
            $(this).addClass("layui-btn-disabled");
            $(this).removeClass("layui-btn-normal");
            var _this = this;
            View.get(url, {}, function(resp) {
                batchId = resp.batchId;
                polling(2000);
                $("#flashbackSpan").html("回溯中");
            }, function() {
                TmplUtils.showMsgFail("回溯失败");
                $(_this).addClass("layui-btn-normal");
                $(_this).removeClass("layui-btn-disabled");
            });
        });
    });
    function polling(t) {
        window.setTimeout(function() {
            var url = Const.apiUrl + "/amlRuleCollectResult/getLast";
            View.get(url, {"batchId":batchId}, function(resp) {
                if (resp.status == 2) {
                    polling(t);
                    return;
                }
                TmplUtils.showMsgSuccess("回溯成功，"+resp.result);
                $("#flashbackSpan").html("回溯");
                $("#flash-back").addClass("layui-btn-normal");
                $("#flash-back").removeClass("layui-btn-disabled");
            },function(){
                TmplUtils.showMsgFail('回溯失败');
                $("#flashbackSpan").html("回溯");
                $("#flash-back").addClass("layui-btn-normal");
                $("#flash-back").removeClass("layui-btn-disabled");
            });
        }, t);
    }
</script>
</html>