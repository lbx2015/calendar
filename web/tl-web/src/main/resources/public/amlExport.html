<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>dialog2</title>
<meta name="renderer" content="webkit">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<link type="include" href="/common/depcss.html" />
</head>
<body class="iframeBody">
<div class="formbox layui-form">
	  <div style="margin:10px 0 20px;">
	    <div class="layui-inline">
	    	<label class="layui-form-label" data-desc="">采集日期：</label>
			<div class="layui-input-inline">
				<input type="text" name="exportDate" id="exportDate"  autocomplete="off" placeholder="" class="layui-input _query" style="height: 38px;line-height: 38px;" onclick="layui.laydate({elem: this,choose:choosed})">
			</div>
			<button class="layui-btn layui-btn-normal fun_ export_"  id="export"  onclick="exportData()" >导出</button>
		</div>
	</div>
	<div id="tb2"></div>
</div>
</body>
<link type="include" href="/common/depjs.html" />
<script id="lab2" type="text/tmpl">
<table class="layui-table lay-even lay-tab-left" style="min-height: 450px; width: 100%;text-align:center;">
	<thead>
		<tr class="table_title">
			<td width="2%"><input type="checkbox" name="" lay-skin="primary" lay-filter="allChoose"></td>	
			<td width="20%"><b>交易名称</b></td> 
			<td width="20%"><b>文件类型</b></td>
			<td width="20%"><b>文件名称</b></td>
			<td width="20%"><b>交易条数</b></td>
		</tr>
	</thead>	
	<tr>
		<td rowspan="7"><input type='checkbox' value="Big" name='tdCheckbox' lay-skin='primary' /></td>
		<td rowspan="7">大额交易</td>
	</tr>
	<tr>
		<td>N</td>
		<td {{# if(d.dn>0){ }}style="color:blue;" {{# } }}>新增报文</td>
		<td>{{ d.dn }}</td>
	</tr>
	<tr>
		<td>C</td>
		<td {{# if(d.dc>0){ }}style="color:blue;" {{# } }}>修改报文</td>
		<td>{{ d.dc }}</td>
	</tr>
	<tr>
		<td>D</td>
		<td {{# if(d.dd>0){ }}style="color:blue;" {{# } }}>删除报文</td>
		<td>{{ d.dd }}</td>
	</tr>
	<tr>
		<td>A</td>
		<td {{# if(d.da>0){ }}style="color:blue;" {{# } }}>更正报文</td>
		<td>{{ d.da }}</td>
	</tr>
	<tr>
		<td>S</td>
		<td {{# if(d.ds>0){ }}style="color:blue;" {{# } }}>补充报文</td>
		<td>{{ d.ds }}</td>
	</tr>
	<tr>
		<td>&nbsp;</td>
		<td {{# if(d.ap>0){ }}style="color:red;" {{# } }}>未审核</td>
		<td>{{ d.ap }}</td>
	</tr>
	<tr>
		<td rowspan="5"><input type='checkbox' value="Susp" name='tdCheckbox' lay-skin='primary' /></td>
		<td rowspan="5">可疑额交易</td>
	</tr> 
	<tr>
		<td>N</td>
		<td {{# if(d.sn>0){ }}style="color:blue;" {{# } }}>新增报文</td>
		<td>{{ d.sn }}</td>
	<tr>
		<td>C</td>
		<td {{# if(d.sc>0){ }}style="color:blue;" {{# } }}>修改报文</td>
		<td>{{ d.sc }}</td>
	</tr>
	<tr>
		<td>A</td>
		<td {{# if(d.sa>0){ }}style="color:blue;" {{# } }}>更正报文</td>
		<td>{{ d.sa }}</td>
	</tr>
	<tr>
		<td>S</td>
		<td {{# if(d.ss>0){ }}style="color:blue;" {{# } }}>补充报文</td>
		<td>{{ d.ss }}</td>
	</tr>
</table>
</script>
<script>
	var form = layui.form(), layer = layui.layer;
	//全选
	form.on('checkbox(allChoose)', function (data) {
		var child = $(data.elem).parents('table').find(
			'tbody input[type="checkbox"]');
		child.each(function (index, item) {
			item.checked = data.elem.checked;
		});
		form.render('checkbox');
	});
</script>
<script>
var date = Utils.getDate(new Date().getTime()-24*60*60*1000);
var tp ;
var firstLoad = true;
$(document).ready(function (){
	tp = new View.Tmpl({
		"container" : $("#tb2"),
		"tmpl" : $("#lab2").html() //注意, json文件中不能有任何注解之类的，否则加载失败
	});
	tp.onload(function(attrs, param) {
		View.info(attrs); //blackWhiteList.json 中的属性对象
		View.info(param); //param 参数转的json对象
		tp.bind(function(callback) {
			var data = {
				"dn" : "0",
				"dc" : "0",
				"dd" : "0",
				"da" : "0",
				"ds" : "0",
				"ap" : "0",
				"sn" : "0",
				"sc" : "0",
				"sa" : "0",
				"ss" : "0"
			};
			var this_ = this;
			var _url = "/businessDay/get";
            var param1;
			if(firstLoad){
                View.get(_url,"date="+date+"&count=1",function (respdata) {
                    if(respdata && respdata.length > 0){
                        $("#exportDate").val(Utils.getDate(respdata[0]));
                        param1 = "exportDate="+Utils.getDate(respdata[0]);
                        View.get(Const.apiUrl + "/dataExport/getData",param1,function(resp){
                            if(resp.sn){
                                data.sn=resp.sn;
                            }
                            if(resp.sc){
                                data.sc=resp.sc;
                            }
                            if(resp.sa){
                                data.sa=resp.sa;
                            }
                            if(resp.ss){
                                data.ss=resp.ss;
                            }
                            if(resp.dn){
                                data.dn = resp.dn;
                            }
                            if(resp.dc){
                                data.dc = resp.dc;
                            }
                            if(resp.dd){
                                data.dd = resp.dd;
                            }
                            if(resp.da){
                                data.da = resp.da;
                            }
                            if(resp.ds){
                                data.di = resp.ds;
                            }
                            if(resp.ap){
                                data.ap = resp.ap;
                            }
                            callback.call(this_, data);
                            layui.form().render();
                        },function(){
                            TmplUtils.showMsgFail('操作失败');
                        });
                    }
                },function () {
                    TmplUtils.showMsgFail("时间获取失败");
                })
                firstLoad = false;
			}else{
                param1 = "exportDate="+$('#exportDate').val();
                View.get(Const.apiUrl + "/dataExport/getData",param1,function(resp){
                    if(resp.sn){
                        data.sn=resp.sn;
                    }
                    if(resp.sc){
                        data.sc=resp.sc;
                    }
                    if(resp.sa){
                        data.sa=resp.sa;
                    }
                    if(resp.ss){
                        data.ss=resp.ss;
                    }
                    if(resp.dn){
                        data.dn = resp.dn;
                    }
                    if(resp.dc){
                        data.dc = resp.dc;
                    }
                    if(resp.dd){
                        data.dd = resp.dd;
                    }
                    if(resp.da){
                        data.da = resp.da;
                    }
                    if(resp.ds){
                        data.ds = resp.ds;
                    }
                    if(resp.ap){
                        data.ap = resp.ap;
                    }
                    callback.call(this_, data);
                    layui.form().render();
                },function(){
                    TmplUtils.showMsgFail('操作失败');
                });
			}
		});
	}, "index=1");
});
var type='';
function exportData(){
	if($("#export").hasClass("layui-btn-disabled")){
		TmplUtils.showMsgFail('正在导出，请等待');
		return;
	}
	var eDate = $('#exportDate').val().replace(/(^\s*)|(\s*$)/g, "");
	if(!eDate){
		TmplUtils.showMsgFail('请选择交易日期');
   	 	return;
	}
	 var arrChk=$("input[name='tdCheckbox']");
	 var flag=false;
	 var url="/dataExport/export";
	 var param = "exportDate="+$('#exportDate').val();
     $(arrChk).each(function(){
         if($(this).next('div').hasClass("layui-form-checked")){
            url+=$(this).val();
            type += $(this).val();
            flag=true;
         }
     });
     if(!flag){
    	 TmplUtils.showMsgFail('请选择导出的模块');
    	 return;
     }
     $("#export").addClass("layui-btn-disabled");
     $("#export").html("导出中");
     $("#export").removeClass("layui-btn-normal");
     View.get(Const.apiUrl +url,param,function(resp){
    	 batchId = resp.batchId;
         polling(1000);
     },function(){
    	 TmplUtils.showMsgFail('导出失败');
    	 $("#export").removeClass("layui-btn-disabled");
	     $("#export").addClass("layui-btn-normal");
	     $("#export").html("导出");
     });
     
}

    function polling(t) {
        window.setTimeout(function() {
        var url="/dataExport/getLast";
		 View.get(Const.apiUrl +url,{"batchId":batchId},function(resp){
			 if (resp.status == 2) {
	             polling(t);
	             return;
	         }
			tp.refresh("index=2");
			$("#export").removeClass("layui-btn-disabled");
		    $("#export").addClass("layui-btn-normal");
		    $("#export").html("导出");
			 if(resp.status==3){
				 TmplUtils.showMsgSuccess("导出成功");
				 $(parent.document.getElementById("layui-tab")).find('.layui-this').html("报文下载");
				 var url = "/zipFileManage.html?type="+type;
				 View.open(url);
				 return;
			 }else if(resp.status==1){
				 TmplUtils.showMsgFail('大额当天记录未审核完全，导出失败');
			 }else if(resp.status==4){
				 TmplUtils.showMsgFail('导出失败');
			 }else{
				 TmplUtils.showMsgFail('导出错误，请联系管理员');
			 }
		},function(code){
			TmplUtils.showMsgFail('导出失败');
			 $("#export").removeClass("layui-btn-disabled");
		     $("#export").addClass("layui-btn-normal");
		     $("#export").html("导出");
		});
       }, t);
 	}


function choosed(){
	tp.refresh();
};
</script>
</html>
