<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<title>规则引擎</title>
	<link type="include" href="/common/depcss.html" />
	<style>
		.layui-layer.layui-layer-iframe{
			overflow: hidden;
		}
		.layui-layer-iframe .layui-layer-title{
			border:0px;
			border-bottom:1px solid #e2e2e2;
		}
		.layui-layer-iframe .layui-layer-content{
			border:0px;
			border-bottom:1px solid #e2e2e2;
			margin:0px;
		}
	</style>
</head>

<body class="iframeBody">
	<div class="content" style="padding:0;margin:0;">
		<div class="layui-elem-field">
			<div class="group-button FL">
				<button class="layui-btn layui-btn-normal layui-btn-small modal-full fun_ ruleadd_" id="add">
			<i class="layui-icon">&#xe608;</i>风险规则录入
			</button>
				<button class="layui-btn layui-btn-small layui-btn-danger ajax-all fun_ ruledel_" id="del" onclick="del()">
					<i class="layui-icon">&#xe640;</i>删除
				</button>
			</div>
			<div class="_tmpl" data-url="filterCriteria.html" data-attr="amlRuleEngine.json"  data-bind="filterCriteriaOnBind" data-param=""></div>
			<div class="clear">
			</div>
		</div>
		<div class="clear">
		</div>
		<div class="contentLeft layui-form">
			<div class="_tmpl" data-url="table.html" id="table" data-attr="amlRuleEngine.json"  data-bind="tbOnBind" data-param="pindex=0&pcount=10"></div>
		</div>
		<div class="contentRight">
			<div class="_tmpl" data-url="preview.html" data-attr="amlRuleEngine.json"  data-bind="previewOnBind" data-param=""></div>
		</div>
		<div style="clear: both">
		</div>
		<div class="_tmpl" data-url="pages.html" data-depend="table" data-attr="amlRuleEngine.json" data-bind="TmplUtils.pagesOnBind" data-param=""></div>
	</div>
</body>
<link type="include" href="/common/depjs.html" />
<script>
$(function () {
    $("#add-data").click(function () {
        layer.open({
            type: 2,
            title: '添加数据',
            shadeClose: true,
            shade: 0.8,
            area: ['100%', '100%'],
            content: 'editBlackWhite.html' //iframe的url
        });
    });
    var form = layui.form();
    //监听提交
    form.on('submit', function (data) {
        return false;
    });
});
</script>
<script>
    //var crimeTypeId = Tool.getQStr("id");
	var form = layui.form(), layer = layui.layer;
	//全选
	form.on('checkbox(allChoose)', function (data) {
		var child = $(data.elem).parents('table').find(
			'tbody input[type="checkbox"]');
		child.each(function (index, item) {
			item.checked = data.elem.checked;
		});
		form.render('checkbox');
	});
</script>
<script>
    var item = {};
    var tbTmpl;
    function forbbit(id) {
    }
    function tbOnBind(attrs,param){
        tmpl = this;
        tbTmpl = tmpl;
        tmpl.bind(function(callback) {
            var url = Const.apiUrl+"/amlRuleEngine/getMore";
            var _this = this;
            /* if(crimeTypeId){
                param.crimeTypeId = crimeTypeId;
			} */
            View.get(url,param,function(resp){
                var data={};
                if(resp){
                    data.data = resp;
                    TmplUtils.totalPages = data.data.totalPages;
                }
                //是否需要全选checkbox
                data.hasCheckbox = true;
                data.hasOperation = true;
                data.tdBeforeFill = function(obj) {
					if (obj.row > 1 && obj.col == 2) {
						 if(!obj.item.approved || obj.item.approved != 1){
						     var html = '<a href="javascript:;" class="layui-btn layui-btn-mini layui-btn-normal fun_ ruleedit_" onclick="edit('+obj.item.id+',0)">修改</a>';
						     html += '<a href="javascript:;" class="layui-btn layui-btn-mini layui-btn-danger fun_ ruleapprove_" onclick="approve('+obj.item.id+')">审核</a>';
                             return obj.html+html;
						 }else{
                             var html = '<a href="javascript:;" class="layui-btn layui-btn-mini layui-btn-normal fun_ ruleedit_" onclick="edit('+obj.item.id+',1)">查看</a>';
                             html += '<a href="javascript:;" class="layui-btn layui-btn-mini layui-btn-danger fun_ rulecancelapprove_" onclick="cancelApprove('+obj.item.id+')">取消审核</a>';
                             return obj.html+html;
						 }
					}
                    return obj.html;
                }
                data.operationWidth = 15;
                callback.call(_this, data);
                if(TmplUtils.pageTmpl.refresh){
                    TmplUtils.pageTmpl.refresh();
				}
                TmplUtils.tableOnLoad();
			},function(code) {
				TmplUtils.showMsgFail('查询出错');
            });
        });
    }
    //表格单元格点击事件
    function bindPro(item){
        this.item = item;
        previewTmpl.refresh();
    }

    //审核
    function approve(id) {
        TmplUtils.showConfirm('您确定审核吗？','确定','取消',function(){
            var url = Const.apiUrl + "/amlRuleEngine/approveMore";
            var ids = [];
            ids.push(id)
            View.post(url,ids,function(resp){
                TmplUtils.showMsgSuccess('审核成功');
                tbTmpl.refresh("pindex=" + (TmplUtils.currPage - 1) + "&pcount=" + TmplUtils.pageSize + TmplUtils.searchParam);
            },function () {
                TmplUtils.showMsgFail('审核失败');
            });
        },function () {
        });
    }

    //审核
    function cancelApprove(id) {
        TmplUtils.showConfirm('您确定取消审核吗？','确定','取消',function(){
            var url = Const.apiUrl + "/amlRuleEngine/cancelApproveMore";
            var ids = [];
            ids.push(id)
            View.post(url,ids,function(resp){
        	if(!resp){
        	    TmplUtils.showMsgSuccess('取消审核成功');
        	}else{
        	    TmplUtils.showMsgFail('取消审核失败');
        	}
                tbTmpl.refresh("pindex=" + (TmplUtils.currPage - 1) + "&pcount=" + TmplUtils.pageSize + TmplUtils.searchParam);
            },function () {
                TmplUtils.showMsgFail('审核失败');
            });
        },function () {
        });
    }

    //预览绑定
    var previewTmpl;
    function previewOnBind(attrs,param) {
        tmpl = this;
        previewTmpl = tmpl;
        if(!item){
            return;
        }
        tmpl.bind(function(callback) {
            var url = Const.apiUrl+"/amlRuleEngine/get";
			var data={};
			data.data = item;
			data.canEdit = true;
			//绑定点击事件
			data.checkClick = "check";
			data.saveClick = "save";
			callback.call(this, data);
			TmplUtils.previewOnLoad();
        });
    }
    //预览校验
	function check() {
    }

    //查询条件绑定
    function filterCriteriaOnBind(attrs,param){
        tmpl = this;
        var _this = this;
        tmpl.bind(function (callback) {
            var data={};
            data.attrs = attrs.attrs;
            data.searchClick = "search";
            callback.call(_this, data);
            TmplUtils.filterCriteriaOnLoad();
        });
    }
    //查询
    function search(){
    	TmplUtils.searchParam = Utils.formToStr("filterCriteria");
        tbTmpl.refresh("pindex=0"+"&pcount="+ TmplUtils.pageSize +TmplUtils.searchParam);
        TmplUtils.closePreview();
    }

	//弹出添加iframe
    function edit(id,isShow){
        var yesFunction;
        if(isShow && isShow=="1"){
            btnList = ['取消'];
		}else{
            btnList = ['保存', '取消'];
            yesFunction = function(){
                document.getElementsByTagName("iframe")[0].contentWindow.save();
            };
		}
        layer.open({
            type: 2,
            title: '风险规则录入',
             closeBtn: 0,
      		 area: ['100%', '600px']
             ,shadeClose: true
             ,shade: false
            ,maxmin: false
            ,resize  :false
            ,btn: btnList
			,offset: '0px'
			,move: false
            ,content:'ruleEngineEdit.html#'+id+"_"+isShow
            ,yes: yesFunction
        });
        //parent.startInit(document.getElementsByTagName("iframe")[0], 500);
    }
	//保存
    function save() {
        var url = Const.apiUrl + "/amlRuleEngine/addOrUpdate";
        var ruleEngine = Utils.formToObj("preview");
        View.post(url,ruleEngine,function(resp){
            TmplUtils.showMsgSuccess('编辑成功')
            tbTmpl.refresh("pindex=" + (TmplUtils.currPage - 1) + "&pcount=" + TmplUtils.pageSize + TmplUtils.searchParam);
            TmplUtils.closePreview();
        },function (){
            TmplUtils.showMsgSuccess('编辑失败')
        })
    }

    //删除
   	function del(){
        TmplUtils.showConfirm('您确定删除该数据吗？','确定','取消',function(){
            var arrChk=$("input[name='tdCheckbox']");
            var ids = [];
            $(arrChk).each(function(){
                if($(this).next('div').hasClass("layui-form-checked")){
                    ids.push($(this).data("id"));
                }
            });
            var url = Const.apiUrl + "/amlRuleEngine/delMore";
            View.post(url,ids,function(resp){
        		if(!resp){
        		    TmplUtils.showMsgSuccess('删除成功');
        		}else{
        		    TmplUtils.showMsgFail(resp+'条记录删除失败');
        		}
                
                tbTmpl.refresh("pindex=" + (TmplUtils.currPage - 1) + "&pcount=" + TmplUtils.pageSize + TmplUtils.searchParam);
            },function () {
                TmplUtils.showMsgFail('删除失败');
            });
		},function(){

		});
    }

    $("#add").click(function () {
        layer.open({
            type: 2,
            title: '风险规则录入',
            closeBtn: 0,
            area: ['100%', '600px']
            ,shadeClose: true
            ,shade: false
            ,maxmin: false
            ,resize  :false
            ,btn: ['保存', '取消']
            ,offset: '0px'
            ,move: false
            ,content: 'ruleEngineEdit.html'
            ,yes: function(){
            	document.getElementsByTagName("iframe")[0].contentWindow.save(); //此处只是为了演示，实际使用可以剔除
        	}
        });
      //parent.startInit(document.getElementsByTagName("iframe")[0], 500);
    });
</script>
</html>