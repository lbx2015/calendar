<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<title>附件上传</title>
	<meta name="renderer" content="webkit">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport"
		  content="width=device-width, initial-scale=1, maximum-scale=1">
	<link type="include" href="/common/depcss.html" />
</head>
<body>
<div class="formbox layui-form add-formbox">
	<div class="layui-btn-div" id="layui-btn-fixed" style="padding-bottom:10px;">
		<div class="ystep4" id="flowsheet"></div>
		<div class="txt-c">
			附件路径：
			<div class="layui-input-inline">
				<input type="text" name="upfile" id="upfile" readonly= "true " autocomplete="off"
					   class="layui-input"  style="height:38px; lin-height:38px;">
				<div class="layui-box layui-upload-button">
					<form target="layui-upload-iframe" method="post" key="set-mine"
						  enctype="multipart/form-data" action="" id="uploadFrom">
						<input type="hidden" name="susId" id="susId"> 
						<input type="hidden" name="username" id="username">
						<input type="file" name="file" id="file" lay-type="file"
							class="layui-upload-file" onchange="upfile.value=this.value">
					</form>
					<span class="layui-upload-icon"><i class="layui-icon"></i>选择文件</span>
				</div>
				<div class="layui-input-inline">
					<button class="layui-btn" onclick="upload()">确定</button>
				</div>
			</div>
		</div>
	</div>
	<div style="clear: both"></div>
	<div class="contentLeft layui-form">
		<div class="_tmpl" data-url="table.html" id="table"
			 data-attr="susAttachment.json" data-bind="tbOnBind"
			 data-param="pindex=0&pcount=10&sort=id_desc"></div>
		<div style="clear: both"></div>
		<div class="_tmpl" data-depend="table" data-url="pages.html"
			 data-attr="susAttachment.json" data-bind="TmplUtils.pagesOnBind"
			 data-param=""></div>
	</div>
</div>
</body>
<link type="include" href="/common/depjs.html" />
<script type="text/javascript" src="{=ctx}/js/jquery/jquery.form.js"></script>
<script type="text/javascript">
    var uploadUrl = Const.apiUrl + "/suspiciouss/fileUpload";
    var id = window.location.hash.replace("#","");
    function upload() {
        if (id) {
            $("#susId").val(id);
        }
        $("#username").val(View.getRes().getUser().userName);
        $("#uploadFrom").attr("action", uploadUrl);
        $('#uploadFrom').ajaxSubmit({
            type : 'post',
            url : uploadUrl,
            dataType : 'text',
            headers:{
                "Auth":View.TOKEN
            },
            success : function(resp) {
	        	if(resp>0){
	        	    TmplUtils.showMsgSuccess('上传成功');
	                tableTmpl.refresh("sort=id_desc");
	        	}else{
	        	    TmplUtils.showMsgFail('上传失败');
	        	}
            },
            error : function(code) {
                TmplUtils.showMsgFail('上传失败');
            }
        });
    }

    $(function() {
        var form = layui.form();
        //监听提交，设置为不刷新页面
        form.on('submit', function(data) {
            return false;
        });
    });

    var tableTmpl;
    function tbOnBind(attrs, param) {
        param.id = id;
        tmpl = this;
        tbTmpl = tmpl;
        tableTmpl = tmpl;
        var data = {};

        tmpl.onFinish(function(){
            if (TmplUtils.pageTmpl) {
                TmplUtils.pageTmpl.refresh();
                TmplUtils.searchParam = "&sort=id_desc";
            }
            TmplUtils.tableOnLoad();
        });

        tmpl.bind(function(callback) {
            var url = Const.apiUrl + "/suspiciouss/getAttasBySusId";
            var _this = this;

            View.get(url, param, function(resp) {
                if (resp) {
                    data.data = resp;
                    TmplUtils.totalPages = data.data.totalPages;
                }
                data.hasOperation = true;
                //操作按钮
                data.operations = [ {
                    value : "下载",
                    onclick : "fileDownload",
                    'class' : "layui-btn layui-btn-mini layui-btn-normal"
                },
                {
                	value:"删除",
                	onclick : "delFile",
                	"class" : "layui-btn layui-btn-mini layui-btn-danger"
                }];
                callback.call(_this, data);
            }, function(code) {
                TmplUtils.showMsgFail('查询出错');
            });
        });
    }
    
    function fileDownload(id) {
        location.href = Const.apiUrl + "/suspiciouss/download?attaId=" + id;
    }
    
    function delFile(id){
    	var url = Const.apiUrl + "/suspiciouss/delFile";
    	View.get(url,"id="+id,function(resp){
    		TmplUtils.showMsgSuccess('操作成功');
    		tableTmpl.refresh();
    	},function(code){ 
    		TmplUtils.showMsgFail('操作出错');
    	});
    }
</script>
</html>