<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <title>评论详情</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link type="include" href="/common/depcss.html" />
</head>

<body class="iframeBody">
    <div class="formbox layui-form add-formbox">
        <div class="_tmpl" data-url="edit.html" data-attr="qaComment.json" data-bind="editOnBind" data-param=""></div>
        <div class="layui-btn-div" id="layui-btn-fixed">
            <button class="layui-btn bgc1 layui-btn-small" lay-submit lay-filter="edit" id="submit">确定</button>
            <button class="layui-btn layui-btn-primary layui-btn-small" onclick="parent.layer.close(parent.layer.getFrameIndex(window.name));">取消</button>
        </div>
    </div>
   		<div class="tableBar">
					<div class="contentLeft layui-form">
			<div class="_tmpl" id="table" data-url="table.html"
				data-attr="qaCReply.json" data-bind="tbOnBind"
				data-param="pindex=0&pcount=10&id=''"></div>
		</div>
		<div style="clear: both"></div>
		<div class="_tmpl" data-url="pages.html" data-depend="table"
			data-attr="" data-bind="TmplUtils.pagesOnBind" data-param=""></div>
		</div>
</body>
<link type="include" href="/common/depjs.html" />
<script type="text/javascript" src="{=ctx}/js/util/ystep.js"></script>
<script>
    $(document).ready(function() {
        $("#submit").click(function() {
            if (TmplUtils.check('edit')) {
                edit();
            }
        });
    });

    //var id = window.location.hash.replace("#", "");
    var id = View.getQStr('id');
    var flag= View.getQStr('flag');
	var topicContent;
    function editOnBind(attrs, param) {
        tmpl = this;
        tmpl.bind(function(callback) {
            var _this = this;
            if (id) {
                var url = Const.apiUrl + "/qaCommentController/get";
                var _this = this;
                View.get(url, "id=" + id, function(resp) {
                    var data = {};
                    if (resp) {
                        data.data = resp;
                    }
                    //默认展开分组 ，不配置默认展开第一个分组
                    data.showGroup = "base";
                    if(flag=="view"){
                    	data.editable = 2;
                    	$("#submit").hide();
                    };
                    
                    callback.call(_this, data);
                    TmplUtils.editOnLoad();
                }, function() {
                    TmplUtils.showMsgFail('信息获取失败');
                });
            } else {
                var data = {};
                data.showGroup = "base,submit";
                callback.call(_this, data);
                TmplUtils.editOnLoad();
                loadRichText();
            }
        });
    }
    
    function tbOnBind(attrs, param) {
    	tmpl = this;
    	tbTmpl = tmpl;

    	tmpl.bind(function(callback) {
    		var url = Const.apiUrl + "/qaCommentController/getReply";
    		var _this = this;
    		param.id = id;
    		View.get(url, param, function(resp) {
    			var data = {};
    			if (resp) {
    				data.data = resp;
    				TmplUtils.totalPages = data.data.totalPages;
    				TmplUtils.totalCount = data.data.totalElements;
    			}
    			//是否需要全选checkbox
    			data.hasCheckbox = false;
    			//是否有操作列
    			data.hasOperation = false;
    			//操作按钮
    			data.operationWidth = 6;
    		

    			//如果要修改表格内容 ，无需修改的忽略此项
    			data.tdBeforeFill = function(obj) {
    				//obj = {item,prop,html,row,col};
    				//item 当前行数据
    				//prop 当前单元格属性
    				//html 当前单元格html内容
    				//row 当前行数
    				//col 当前列数
    				
    				
    				return obj.html;
    			}
    			callback.call(_this, data);
    			TmplUtils.pageTmpl.refresh();
    			TmplUtils.tableOnLoad();
    			
    		}, function(code) {
    			layer.msg('查询出错', {
    				icon : 5
    			});
    		});
    	});
    }
    
    //编辑保存
    function edit() {
        layui.use('layedit', function(){
     	  	var layedit = layui.layedit;
     	});
        var reportList = Utils.formToObj("edit");
        if(id){
			reportList.qaId=id;
		}
        var url = Const.apiUrl + "/qaCommentController/save";
        View.post(url, reportList, function(resp) {
            TmplUtils.showMsgSuccess('编辑成功');
            parent.tbTmpl.refresh("pindex=" + (parent.TmplUtils.currPage - 1) 
        	    + "&pcount=" + parent.TmplUtils.pageSize 
                + parent.TmplUtils.searchParam);
            
            var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
            parent.layer.close(index);
        }, function(code) {
            TmplUtils.showMsgFail('编辑失败');
        });
    }
</script>

</html>