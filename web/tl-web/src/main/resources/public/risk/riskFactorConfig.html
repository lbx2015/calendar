<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<title>三级风险因子</title>
	<link type="include" href="/common/depcss.html" />
</head>
<body>
	<div class="content">
		<div class="layui-elem-field">
			<div class="group-button FL">
				<button class="layui-btn layui-btn-small layui-btn-danger ajax-all" id="deleteBtn" onclick="del()">
			<i class="layui-icon">&#xe640;</i> 删除
			</button>
			<button
					class="layui-btn layui-btn-normal layui-btn-small modal-full"
					id="add-data" onclick="add()">
					<i class="layui-icon">&#xe608;</i> 添加
				</button>
			</div>
			<div class="_tmpl" data-url="filterCriteria.html" data-attr="riskFactorConfig.json"  data-bind="filterCriteriaOnBind" data-param=""></div>
			<div class="clear">
			</div>
		</div>
		<div class="clear">
		</div>
		<div class="contentLeft layui-form">
			<div class="_tmpl" data-url="table.html" id="table" data-attr="riskFactorConfig.json"  data-bind="tbOnBind" data-param="pindex=0&pcount=10"></div>
		</div>
		<div class="contentRight">
			<div class="_tmpl" data-url="preview.html" data-attr="riskFactorConfig.json"  data-bind="previewOnBind" data-param=""></div>
		</div>
		<div style="clear: both">
		</div>
		<div class="_tmpl" data-url="pages.html" data-depend="table" data-attr="riskFactorConfig.json" data-bind="TmplUtils.pagesOnBind" data-param=""></div>
	</div>
</body>
<link type="include" href="/common/depjs.html" />
<script>
 $(function () {
    var form = layui.form();
    //监听提交
    form.on('submit', function (data) {
        return false;
    });
});

</script>
<script>
//alert(codeid);
	var form = layui.form(), layer = layui.layer;
	//全选
	form.on('checkbox(allChoose)', function (data) {
		var child = $(data.elem).parents('table').find(
			'tbody input[type="checkbox"]');
		child.each(function (index, item) {
			item.checked = data.elem.checked;
		});
		form.render('checkbox');
	});
</script>
<script>
</script>
<script>
    var pageSize = 10;
    $("#page_count").change(function () {
        pageSize = $("#page_count").val()
    })
var codeid = window.location.hash.replace("#", "");
  	var item = {};
    var tbTmpl;
    function tbOnBind(attrs,param){
        tmpl = this;
        tbTmpl = tmpl;
        tmpl.bind(function(callback) {
            var url = Const.apiUrl+"/riskFactor/getMorees";
            //alert(url);
            var _this = this;
            param.id=codeid;
            View.get(url,param,function(resp){
            	//alert(param);
                var data={};
                data.table = attrs.table;
                data.enums = attrs.enums;
                data.attrs = attrs.attrs;
				data.operationWidth = 6;
                if(resp){
                    data.data = resp;
                    TmplUtils.totalPages = data.data.totalPages;
                }
                //是否需要全选checkbox
                data.hasCheckbox = true;
                data.hasOperation = true;
                data.operations=[{value:"修改",onclick:"edit",'class' : "layui-btn layui-btn-mini layui-btn-normal"}];
                data.trClick = "bindPro";
                //操作按钮
                /*  data.tdBeforeFill = function(obj){
                	if(obj.row==2){
                		ids=obj.item.id;
                		return obj.html;
                	}
                	return obj.html;
                } */
                callback.call(_this, data);
                if(TmplUtils.pageTmpl){
                	TmplUtils.pageTmpl.refresh();
    			}
                TmplUtils.tableOnLoad();
			},function(code) {
				//alert("查询出错");
               TmplUtils.showMsgFail('查询出错');
            });
        });
    }
    //表格单元格点击事件
    function bindPro(item){
        if(!TmplUtils.isEditing){
            this.item = item;
            previewTmpl.refresh();
        }
    }

    //预览绑定
   var previewTmpl;
    function previewOnBind(attrs,param) {
        tmpl = this;
        previewTmpl = tmpl;
        if(!item){
            return;
        }
        tmpl.bind(function(callback) {
            var url = Const.apiUrl+"/riskFactor/getes";
            var data={};
			//是否可编辑
			data.canEdit = true;
			data.data = item;
			//绑定点击事件
			data.checkClick = "check";
			data.saveClick = "save";
			callback.call(this, data);
			TmplUtils.previewOnLoad();
        });
    }

    //查询条件绑定
    function filterCriteriaOnBind(attrs,param){
        tmpl = this;
        var _this = this;
        tmpl.bind(function (callback) {
            var data={};
            data.table = attrs.table;
            data.enums = attrs.enums;
            data.attrs = attrs.attrs;
            data.searchClick = "search";
            callback.call(_this, data);
            TmplUtils.filterCriteriaOnLoad();
        });
    }
  //查询
    function search(){
        TmplUtils.searchParam = Utils.formToStr("filterCriteria");
        tbTmpl.refresh("pindex=0"+"&pcount="+ TmplUtils.pageSize +TmplUtils.searchParam);
        TmplUtils.currPage = 1;
        TmplUtils.closePreview();
    }
    var riskFactorConfig = {};
	function check() {
		//var riskFactorConfig = Utils.Utils.formToObj("filterCriteria");
		$.extend(riskFactorConfig, Utils.formToObj("filterCriteria"))
		if (!riskFactorConfig.factorCodeName.replace(" ", "")) {
			TmplUtils.showMsgFail('风险因素不能为空');
			return false;
		} else if(!riskFactorConfig.score.replace(" ", "")){
			TmplUtils.showMsgFail('风险状态分数不能为空');
			return false;
		} else {
			 TmplUtils.showMsgSuccess('校验成功');
			return true;
		}
	}
	//弹出添加iframe
    function edit(id){
        layer.open({
        	type : 2,
			title : '编辑因素',
            shadeClose: true,
            shade: false,
            maxmin: false, //开启最大化最小化按钮
            area: ['100%', '100%'],
            offset: '0px',
            move: false,
            content: 'riskFactorConfigView.html#'+id //iframe的url
        });
	}
	//保存
    function save() {
        var url = Const.apiUrl + "/riskFactor/updatees";
        var riskFactorConfig = Utils.formToObj("preview");
        View.post(url,riskFactorConfig,function(resp){
            TmplUtils.showMsgSuccess('编辑成功');
            tbTmpl.refresh("pindex=" + (TmplUtils.currPage - 1) + "&pcount=" +  TmplUtils.pageSize + TmplUtils.searchParam);
            TmplUtils.closePreview();
        },function (){
        	TmplUtils.showMsgFail('编辑失败');
        })
    }
  //新增
	  function add() {
		  layer.open({
	        	type : 2,
				title : '添加因素',
	            shadeClose: true,
	            shade: false,
	            maxmin: false, //开启最大化最小化按钮
	            area: ['100%', '100%'],
	            offset: '0px',
	            move: false,
	            content: 'riskFactorConfigView.html#ss'+codeid //iframe的url
	        });
	    }
	//删除
	  function del(){
			 var arrChk=$("input[name='tdCheckbox']");
		     var ids = [];
		     $(arrChk).each(function(){
		         if($(this).next('div').hasClass("layui-form-checked")){
		             ids.push($(this).data("id"));
		         }
		     });
		     if (ids == "") {
				TmplUtils.showMsgFail('请选择一条或多条数据');
				return;
			 }
			TmplUtils.showConfirm('您确定删除该数据吗？','确定','取消',function () {
	            var url = Const.apiUrl + "/riskFactor/delMorees"
	            View.post(url,ids,function(resp){
	            	TmplUtils.showMsgSuccess('删除成功');
	                tbTmpl.refresh("pindex=" + (TmplUtils.currPage - 1) + "&pcount=" + TmplUtils.pageSize + TmplUtils.searchParam);
	            },function () {
	            	TmplUtils.showMsgFail('删除失败');
	            });
	        }, function () {
	        });
	    }
</script>
</html>