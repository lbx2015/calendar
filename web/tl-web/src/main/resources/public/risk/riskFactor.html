<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>风险因子管理</title>
<link type="include" href="/common/depcss.html" />
</head>

<body>
	<div class="content">
		<div class="layui-elem-field">
			<div class="group-button FL">
				<button class="layui-btn layui-btn-small layui-btn-danger ajax-all fun_ del_"
					id="deleteBtn" onclick="del()">
					<i class="layui-icon">&#xe640;</i> 删除
				</button>
				<button
					class="layui-btn layui-btn-normal layui-btn-small modal-full fun_ add_"
					id="add-data">
					<i class="layui-icon">&#xe608;</i> 添加
				</button>
			</div>
			<div class="_tmpl" data-url="filterCriteria.html" data-attr="riskFactor.json"  data-bind="filterCriteriaOnBind" data-param=""></div>
			<div class="clear">
			</div>
		</div>
		<div class="clear"></div>
		<div class="contentLeft layui-form">
			<div class="_tmpl" data-url="table.html"
				data-attr="riskFactor.json" data-bind="tbOnBind"
				data-param="pindex=0&pcount=500"></div>
		</div>
		<div class="contentRight"></div>
		<div style="clear: both"></div>
	</div>
</body>
<link type="include" href="/common/depjs.html" />
<script>
	$(function() {
		$("#add-data").click(function() {
			layer.open({
				type : 2,
				title : '添加数据',
                shadeClose: true,
                shade: false,
                maxmin: false, //开启最大化最小化按钮
                area: ['100%', '100%'],
                offset: '0px',
                move: false,
				content : 'riskFactorView.html' //iframe的url
			});
		});

		var form = layui.form();
		//监听提交
		form.on('submit', function(data) {
			return false;
		});
	});
</script>
<script>
	var form = layui.form(), layer = layui.layer;
	//全选
	form.on('checkbox(allChoose)', function(data) {
		var child = $(data.elem).parents('table').find(
				'tbody input[type="checkbox"]');
		child.each(function(index, item) {
			item.checked = data.elem.checked;
		});
		form.render('checkbox');
	});
</script>
<script>
	function closePreview() {
        $(".contentLeft").removeClass("w1");
        $(".contentRight").removeClass("w2");
        $(".lay-tab-right").removeClass("w3");
    }
</script>
<script>
	var pageSize = 500;
	$("#page_count").change(function() {
		pageSize = $("#page_count").val()
	})
	function viewRiskFactorConfig(id) {
		layer.open({
			type : 2,
			title : '查看因素',
			shadeClose : true,
			shade : 0.8,
			area : [ '100%', '100%' ],
			content : 'riskFactorConfig.html#' + id //iframe的url
		});
	}
</script>
<script>
    $("#page_count").change(function () {
        pageSize = $("#page_count").val()
    })
    var id = 0;
    var tbTmpl;
    var totalPages;
    function viewRiskFactorConfig(id){
    	 layer.open({
    		 type : 2,
			 title : '风险因素',
             shadeClose: true,
             shade: false,
             maxmin: false, //开启最大化最小化按钮
             area: ['100%', '100%'],
             offset: '0px',
             move: false,
             content: 'riskFactorConfig.html#'+id //iframe的url
         });
    }
    //表格单元格点击事件
    function bindPro(id){
        this.id = id;
        previewTmpl.refresh();
    }

    //预览绑定
    var previewTmpl;
    function previewOnBind(attrs,param) {
        tmpl = this;
        previewTmpl = tmpl;
        if(!id){
            return;
        }
        tmpl.bind(function(callback) {
            var url = Const.apiUrl+"/riskFactor/get";
            var _this = this;
            View.get(url,"id="+id,function(resp){
                var data={};
                data.table = attrs.table;
                data.enums = attrs.enums;
                data.attrs = attrs.attrs;
                if(resp){
                    data.data = resp;
                }
                url_1 = Const.apiUrl+"/riskFactor/getParentFactorCode";
                View.get(url_1,"",function(resp){
                	for(var i=0; i< resp.length; i++){
                		data.enums[data.table].push(resp[i]);
                	}       	
                	 //绑定点击事件
                    data.checkClick = "check";
                    data.saveClick = "save";
                	callback.call(_this, data);
                    TmplUtils.previewOnLoad();
                },function(code){
                	TmplUtils.showMsgFail('查询出错');
                });     
			},function () {
				TmplUtils.showMsgFail('预览获取失败');
            });
        });
    }
    //预览校验
	function check() {
        var riskFactor = Utils.formToObj("preview");
        if(!riskFactor.factorName.replace(" ","")){
        	TmplUtils.showMsgFail('名称不能为空');
            return false;
		}else{
			TmplUtils.showMsgSuccess('校验成功');
            return true;
		}
    }

    //查询条件绑定
    function filterCriteriaOnBind(attrs,param){
        tmpl = this;
        var _this = this;
        tmpl.bind(function (callback) {
            var data={};
            data.table = attrs.table;
            data.enums = attrs.enums;
            data.attrs = attrs.attrs;
            url_1 = Const.apiUrl+"/riskFactor/getParentFactorCode";
            View.get(url_1,"",function(resp){
            	for(var i=0; i< resp.length; i++){
            		data.enums[data.table].push(resp[i]);
            	}       	
            	data.searchClick = "search";
                callback.call(_this, data);
                TmplUtils.filterCriteriaOnLoad();
            },function(code){
            	TmplUtils.showMsgFail('查询出错');
            });           
        });
    }
    //查询
    var searchParam="";
    function search(){
        var searchParam = Utils.formToStr("filterCriteria");
        tbTmpl.refresh("pindex=0"+"&pcount="+pageSize +searchParam);
        closePreview();
    }

    //翻页绑定
    var pageTmpl;
    var currPage = 1;
    function pagesOnBind(attrs,param) {
        tmpl = this;
        pageTmpl = tmpl;
        var _this = this;
        if(!totalPages){
            return;
        }
        tmpl.bind(function (callback) {
            callback.call(_this, {});
            var laypage = layui.laypage;
            laypage({
                cont: 'laypage',
                pages: totalPages,
                skip: true,
                curr:currPage,
                jump:function (obj,first){
                    if(!first){
                        currPage = obj.curr;
                        tbTmpl.refresh("pindex="+(obj.curr-1)+"&pcount="+pageSize+searchParam);
                        closePreview();
                    }
                }
            });
        })
    }
	//弹出添加iframe
    function edit(id){
        layer.open({
        	type : 2,
			title : '添加数据',
            shadeClose: true,
            shade: false,
            maxmin: false, //开启最大化最小化按钮
            area: ['100%', '100%'],
            offset: '0px',
            move: false,
            content: 'riskFactorView.html#'+id //iframe的url
        });
	}

	function tbOnBind(attrs, param) {
		tmpl = this;
		tbTmpl = tmpl;
		var data = {};
		attrs.attrs.splice(3,3);
		data.attrs = attrs.attrs;
		tmpl.bind(function(callback) {
			var url = Const.apiUrl + "/riskFactor/getMore";
			var _this = this;
			View.get(url, param, function(resp) {
				data.table = attrs.table;
				data.enums = attrs.enums;
				if (resp) {
					data.data = resp;
					//totalPages = data.data.totalPages;
				}
				//是否需要全选checkbox
				data.hasCheckbox = true;
				data.hasOperation = true;
				data.tdBeforeFill = function(obj) {
					if (obj.prop == "factorName") {
						if (obj.item.parentFactorCode != "0") {
							var flag = true;
							for(var i in resp.content){
								//alert(resp.content[i].corptrnProp == obj.item.corptrnProp)
								if(resp.content[i].id != obj.item.id && resp.content[i].corptrnProp == obj.item.corptrnProp){
									flag = false;
								}
							}
							if(flag){
							return "<a href='javascript:void(0)' onclick=viewRiskFactorConfig("
									+ obj.item.id + ")><u>"
									+ obj.item.factorName + "</u></a>";
							}else{
								TmplUtils.showMsgFail('客户属性不唯一!')
							return "<a href='javascript:void(0)' onclick=viewRiskFactorConfig("
								+ obj.item.id + ")><u><span style='color:red;'>"
								+ obj.item.factorName + "</span></u></a>";
							}
						}else{
							return "<span></span>";
						}
					}
					if(obj.prop == "parentFactorCode"){
						if (obj.item.parentFactorCode == "0") {
							return "<span>" + obj.item.factorName + "<span>"
						}
					}
					var weights = 0;
					if (obj.row == 1 && obj.col == 5) {
						for (var i = 0; i < resp.content.length; i++) {
							var item = resp.content[i];
							if (item.parentFactorCode != "0") {
								weights += item.weights;
							}
						}
						if (weights == '100') {
							return "<span>权重(汇总:100%)</span>";
						} else {
							TmplUtils.showMsgFail("权重汇总值有误");
							return "<span style='color:red;'>权重(汇总:" + weights
									+ "%)</span>";
						}
					}
					if(obj.prop == 'corptrnProp'){
						var i = obj.item;
						for(var it in resp){
							if(i.corptrnProp == it.corptrnProp){
								return "<span style='color:red;'>" + i.corptrnProp + "</span>"
							}
						}
					}
					return obj.html;
				}
				//操作按钮
				data.operationWidth = 6;
				data.operations = [ {
					value : "修改",
					onclick : "edit",
					'class' : "layui-btn layui-btn-mini layui-btn-normal fun_ update_"
				} ]
				var url_1 = Const.apiUrl + "/riskFactor/getParentFactorCode";
				View.get(url_1, "", function(resp) {
					for (var i = 0; i < resp.length; i++) {
						data.enums[data.table].push(resp[i]);
					}
					callback.call(_this, data);
					//tbTmpl.refresh("pindex=0" + "&pcount=" + pageSize + searchParam);
					TmplUtils.tableOnLoad();
				}, function(code) {
					TmplUtils.showMsgFail("查询出错");
				});
			}, function(code) {
				TmplUtils.showMsgFail("查询出错");
			});
		});
	}

	//查询条件绑定
	function filterCriteriaOnBind(attrs, param) {
		tmpl = this;
		var _this = this;
		tmpl.bind(function(callback) {
			var data = {};
			data.table = attrs.table;
			data.enums = attrs.enums;
			data.attrs = attrs.attrs;
			url_1 = Const.apiUrl + "/riskFactor/getParentFactorCode";
			View.get(url_1, "", function(resp) {
				for (var i = 0; i < resp.length; i++) {
					data.enums[data.table].push(resp[i]);
				}
				data.searchClick = "search";
				callback.call(_this, data);
				TmplUtils.filterCriteriaOnLoad();
			}, function(code) {
				TmplUtils.showMsgFail("查询失败");
			});
		});
	}
	//查询
	var searchParam = "";
	function search() {
		var searchParam = Utils.formToStr("filterCriteria");
		tbTmpl.refresh("pindex=0" + "&pcount=" + pageSize + searchParam);
		closePreview();
	}

	//保存
	function save() {
		var url = Const.apiUrl + "/riskFactor/addOrUpdate"
		var riskFactor = Utils.formToObj("preview");
		View.post(url, riskFactor, function(resp) {
			TmplUtils.showMsgSuccess("编辑成功");
			tbTmpl.refresh("pindex=" + (currPage - 1) + "&pcount=" + 500
					+ searchParam);
			closePreview();
		}, function() {
			TmplUtils.showMsgFail("编辑失败");
		})
	}

	//删除
	function del() {
		 var arrChk=$("input[name='tdCheckbox']");
	     var ids = [];
	     $(arrChk).each(function(){
	         if($(this).next('div').hasClass("layui-form-checked")){
	             ids.push($(this).data("id"));
	         }
	     });
	     if (ids == "") {
			TmplUtils.showMsgFail('请选择一条或多条数据');
			return;
		 }
		TmplUtils.showConfirm('您确定删除该数据吗？', '确定', '取消', function() {
			var url = Const.apiUrl + "/riskFactor/delMore"
			View.post(url, ids, function(resp) {
				TmplUtils.showMsgSuccess("删除成功");
				tbTmpl.refresh("pindex=" + (currPage - 1) + "&pcount="
						+ 500 + searchParam);
			}, function() {
				TmplUtils.showMsgFail("删除失败");
			});
		}, function() {
		});
	}
</script>
</html>