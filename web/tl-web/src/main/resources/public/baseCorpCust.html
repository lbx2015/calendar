<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<title>BaseCorpCust</title>
	<link type="include" href="/common/depcss.html" />
</head>

<body class="iframeBody">
	<div class="content">
		<div class="layui-elem-field">
			<div class="group-button FL">
				<button class="layui-btn layui-btn-small layui-btn-danger ajax-all fun_ del_" id="deleteBtn" onclick="del()">
			<i class="layui-icon">&#xe640;</i> 删除
			</button>
				<button class="layui-btn layui-btn-normal layui-btn-small modal-full fun_ add_" id="add-data">
			<i class="layui-icon">&#xe608;</i> 新增
			</button>	
			<button class="layui-btn layui-btn-normal layui-btn-small ajax-all fun_ riskrate_"
					id="rate" onclick="riskRate()">开始评级</button>
			<button class="layui-btn layui-btn-normal layui-btn-small modal-full rateall fun_ riskrateall_"
					id="rateall" onclick="riskRateAll()">全部评级</button>
			</div>
			<div class="_tmpl" data-url="filterCriteria.html" data-attr="baseCorpCust.json"  data-bind="filterCriteriaOnBind" data-param=""></div>
			<div class="clear">
			</div>
		</div>
		<div class="clear">
		</div>
		<div class="contentLeft layui-form">
			<div class="_tmpl" data-url="table.html" id="table" data-attr="baseCorpCust.json"  data-bind="tbOnBind" data-param="pindex=0&pcount=10"></div>
		</div>
		<div class="contentRight">
			<div class="_tmpl" data-url="preview.html" data-attr="baseCorpCust.json"  data-bind="previewOnBind" data-param=""></div>
		</div>
		<div style="clear: both">
		</div>
		<div class="_tmpl" data-url="pages.html" data-depend="table" data-attr="" data-bind="TmplUtils.pagesOnBind" data-param=""></div>
	</div>
</body>
<link type="include" href="/common/depjs.html" />
<script>
$(function () {
    $("#add-data").click(function () {
        layer.open({
            type: 2,
            title: '新增数据',
            shadeClose: true,
            shade: false,
            maxmin: false, //开启最大化最小化按钮
            area: ['100%', 'auto'],
            offset: '0px',
            move: false,
            content: 'baseCorpCustEdit.html' //iframe的url
        });
        parent.startInit(document.getElementsByTagName("iframe")[0], 560);
    });

    var form = layui.form();
    //监听提交
    form.on('submit', function (data) {
        return false;
    });
});

</script>
<script>
	var form = layui.form(), layer = layui.layer;
	//全选
	form.on('checkbox(allChoose)', function (data) {
		var child = $(data.elem).parents('table').find(
			'tbody input[type="checkbox"]');
		child.each(function (index, item) {
			item.checked = data.elem.checked;
		});
		form.render('checkbox');
	});
</script>
<script>
//开始评级按钮
function riskRate() {
	if ($("#rate").hasClass("layui-btn-disabled")) {
		return;
	}
	 var arrChk=$("input[name='tdCheckbox']");
     var ids = [];
     $(arrChk).each(function(){
         if($(this).next('div').hasClass("layui-form-checked")){
             ids.push($(this).data("id"));
         }
     });
     if (ids == "") {
		TmplUtils.showMsgFail('请选择一条或多条数据');
		return;
	 }
	var url = Const.apiUrl + "/baseCorpCusts/riskRate";
	View.post(url, ids, function(resp) {
		if(resp>0){
			TmplUtils.showMsgSuccess('评级成功'+resp+'条数据');
		}else{
			TmplUtils.showMsgFail('评级失败');
		}
		tbTmpl.refresh("pindex=" + (TmplUtils.currPage - 1) + "&pcount="
				+ TmplUtils.pageSize + TmplUtils.searchParam);
	}, function(code) {
		TmplUtils.showMsgFail('评级失败');
	});
}

//全部评级按钮
function riskRateAll() {
	if ($("#rateall").hasClass("layui-btn-disabled")) {
		return;
	}
	TmplUtils.showConfirm('您确定要对所有客户进行评级操作吗？', '确定', '取消', function() {
		$("#rateall").addClass("layui-btn-disabled");
		$("#rate").addClass("layui-btn-disabled");
		$("#rateall").removeClass("layui-btn-normal");
		$("#rate").removeClass("layui-btn-normal");
		var url = Const.apiUrl + "/baseCorpCusts/riskRateAll";
		View.post(url, "", function(resp) {
			$("#rateStatus").html("评级中");
			polling(1000);
			//doRefresh(0, resp);
			TmplUtils.showMsgSuccess("开始全部评级")
		}, function(code) {
			$("#rateall").romoveClass("layui-btn-disabled");
			$("#rateall").addClass("layui-btn-normal");
			TmplUtils.showMsgFail('评级失败');
		});
	},function(){});
}
var batchId = "";
function polling(t) {
	window.setTimeout(function() {
		var url = Const.apiUrl + "/baseCorpCusts/getLast";
		View.get(url, {"batchId":batchId}, function(resp) {
			if (resp.status == 2) {
				polling(t);
			} else {
				var sta = resp.status;
				if (sta == 1) {
					sta = "未开始";
				} else if (sta == 3) {
					sta = "评级成功";
				} else if (sta == 4) {
					sta = "评级失败";
				} else if (sta == 5) {
					sta = "评级异常，已中止";
				}
				$("#rateStatus").html(sta);
				$("#rateall").removeClass("layui-btn-disabled");
				$("#rateall").addClass("layui-btn-normal");
				$("#rate").removeClass("layui-btn-disabled");
				$("#rate").addClass("layui-btn-normal");
				TmplUtils.showMsgSuccess("全部评级完毕");
				tbTmpl.refresh("pindex=" + (TmplUtils.currPage - 1) + "&pcount="
						+ TmplUtils.pageSize + TmplUtils.searchParam);
				TmplUtils.tableOnLoad();
			}
		}, function() {
		});
	}, t)
}
</script>
<script>

	Work.onSendEventBefore(function(jobEvent, job) {
		jobEvent.nextStateOwner = "某某1";
		jobEvent.comments = "xxxxx";
		return jobEvent;
	});
	
	Work.onSendEventAfter(function(result, job) {
		View.info("job :{jobId} result：{success} ".format(result));
		View.info(result.data);
		View.fireEvent("TB_DATA_CHANGE", {});
	});
	
	Work.onDoAction(function(action, job) {
		var tar = job.getTarget();
		if("EDIT"==action){
			edit(tar.id,1);
		}else if("UPDATE"==action){
			var url = Const.apiUrl + "/baseCorpCusts/getOther";
			View.get(url,"id=" + tar.id,function(resp) {
				if(resp){
					update(tar.id);
				}else{
					TmplUtils.showMsgFail('操作失败,该数据已变更');
				}
			}, function(code) {
				TmplUtils.showMsgFail('操作失败');
			});
		}else if("APPROVE"==action){
			edit(tar.id,2);
		}
		
	});
	/**
	 * 对外提供事件监听
	 */
	View.setEvent("TB_DATA_CHANGE", function(arg) {
		tbTmpl.refresh("pindex=" + (TmplUtils.currPage - 1) + "&pcount="
				+ TmplUtils.pageSize + TmplUtils.searchParam);
		previewTmpl.refresh();
		if (!!arg && arg.window) {
			var index = layer.getFrameIndex(arg.window); //获取窗口索引
			layer.close(index);
		}
        TmplUtils.closePreview();
	});

    var item;
    var tbTmpl;
    function tbOnBind(attrs,param){
    	tmpl = this;
    	tbTmpl = tmpl;
    	var data = {};
    	if (param.listType == '2') {
    		if (attrs.attrs.length >= 3) {
    			attrs.attrs.splice(1, 1);
    		}
    		data.attrs = attrs.attrs;
    	}
    	tmpl.bind(function(callback) {
    		var url = Const.apiUrl + "/baseCorpCusts/getMore";
    		var _this = this;
    		
    		if( typeof(param)=='object'){
    			for(var key in param){
    				param[key] = encodeURI(param[key]);
    			}
    		}else{
    			param = encodeURIComponent(param)
    		}

    		View.get(url,param, function(resp) {
    			if (resp) {
    				data.data = resp;
    				TmplUtils.totalPages = data.data.totalPages;
    				if(data.data.totalElements){
                        TmplUtils.totalCount = data.data.totalElements;
    				}else{
                        TmplUtils.totalCount = 0;
    				}
    			}
    			//是否需要全选checkbox
    			data.hasCheckbox = true;
    			data.hasOperation = true;
    			data.cellLeftCount=5
    			data.cellRightCount=2
    			data.operationWidth = 6;
				data.tdLeftWidth = [ 8, 7, 8,20,26];
				data.tdRightWidth = [20,12];
    			//tr的点击事件绑定，该方法会传入id 参数
    			data.trClick = "bindPro";
    			data.tdBeforeFill = function(obj) {
					
					if (obj.row > 1 && obj.col == 2) {
						var job = Work.getJob(obj.item);
						var html = job.getActionsHtml();
						return html;
					}
					return obj.html;
				}
    			callback.call(_this, data);
    			if(TmplUtils.pageTmpl){
                	TmplUtils.pageTmpl.refresh();
    			}
    			TmplUtils.tableOnLoad();
    		}, function(code) {
    			TmplUtils.showMsgFail('查询出错');
    		});
    	});
    }
    //表格单元格点击事件
    function bindPro(item){
        if(!TmplUtils.isEditing){
            this.item = item;
            previewTmpl.refresh();
        }
    }

    //预览绑定
    var previewTmpl;
    function previewOnBind(attrs,param) {
        tmpl = this;
        previewTmpl = tmpl;
        if(!item){
            return;
        }
        tmpl.bind(function(callback) {
            var url = Const.apiUrl+"/baseCorpCusts/get";
			var data={};
			//是否可编辑
			data.canEdit = true;
			data.data = item;
			if (data.data.job && data.data.job.curJobState) {
				var confirmStatus = data.data.job.curJobState;
			}
			if (confirmStatus == 'PRE_RECROD') {
				data.canEdit = true;
			} else {
				data.canEdit = false;
			}
			//绑定点击事件
			data.checkClick = "check";
			data.saveClick = "save";
			callback.call(this, data);
			TmplUtils.previewOnLoad();
        });
    }

    //查询条件绑定
    function filterCriteriaOnBind(attrs,param){
        tmpl = this;
        var _this = this;
        tmpl.bind(function (callback) {
            var data={};
            data.searchClick = "search";
            callback.call(_this, data);
            TmplUtils.filterCriteriaOnLoad();
        });
    }
    //查询
    function search(){
        TmplUtils.searchParam = Utils.formToStr("filterCriteria");
        tbTmpl.refresh("pindex=0"+"&pcount="+ TmplUtils.pageSize +TmplUtils.searchParam);
        TmplUtils.currPage = 1;
        TmplUtils.closePreview();
    }
	//弹出添加iframe
     function edit(id,state){
		var url = "baseCorpCustEdit.html?state="+ state + "&id="+ id ;
    	 var title =  "数据处理";
    	 View.openDialog(url, title);
       /*  layer.open({
            type: 2,
            title: '数据处理',
            shadeClose: true,
            shade: false,
            maxmin: false, //开启最大化最小化按钮
            area: ['100%', 'auto'],
            offset: '0px',
            move: false,
            content: 'baseCorpCustEdit.html?state='+ state + "#"
				+ id //iframe的url
        });
        parent.startInit(document.getElementsByTagName("iframe")[0], 560); */
    }
     //弹出添加iframe
     function update(id){
        layer.open({
            type: 2,
            title: '数据处理',
            shadeClose: true,
            shade: false,
            maxmin: false, //开启最大化最小化按钮
            area: ['100%', 'auto'],
            offset: '0px',
            move: false,
            content: 'baseCorpCustUpdate.html#'+id //iframe的url
        });
        parent.startInit(document.getElementsByTagName("iframe")[0], 560);
    }
    function save() {
        var url = Const.apiUrl + "/baseCorpCusts/addOrUpdate";
        var baseCorpCust = Utils.formToObj("preview");
        View.post(url,baseCorpCust,function(resp){
            TmplUtils.showMsgSuccess('编辑成功');
            tbTmpl.refresh("pindex=" + (TmplUtils.currPage - 1) + "&pcount=" +  TmplUtils.pageSize + TmplUtils.searchParam);
            TmplUtils.closePreview();
        },function (){
        	TmplUtils.showMsgFail('编辑失败');
        })
        
    }

    //删除
   	function del(){
   	 var arrChk=$("input[name='tdCheckbox']");
     var ids = [];
     $(arrChk).each(function(){
         if($(this).next('div').hasClass("layui-form-checked")){
             ids.push($(this).data("id"));
         }
     });
     if (ids == "") {
		TmplUtils.showMsgFail('请选择一条或多条数据');
		return;
	 }
        TmplUtils.showConfirm('您确定删除该数据吗？','确定','取消',function () {
            var url = Const.apiUrl + "/baseCorpCusts/delMore"
            View.post(url,ids,function(resp){
            	if(resp>0){
            		TmplUtils.showMsgSuccess("有"+resp+"条数据已审核不能删除");
            	}else{
            		TmplUtils.showMsgSuccess("删除成功");
            		}
                tbTmpl.refresh("pindex=" + (TmplUtils.currPage - 1) + "&pcount=" +  TmplUtils.pageSize + TmplUtils.searchParam);
            },function () {
                TmplUtils.showMsgFail('删除失败');
            });
        },function(){

		});
    }
</script>
</html>