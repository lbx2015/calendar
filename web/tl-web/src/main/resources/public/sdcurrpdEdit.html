<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>汇率编辑</title>
<meta name="renderer" content="webkit">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport"
	content="width=device-width, initial-scale=1, maximum-scale=1">
<link type="include" href="/common/depcss.html" />
<link rel="stylesheet" type="text/css" href="/css/ystep.css" />
</head>
<body class="iframeBody">
	<div class="formbox layui-form add-formbox">
		<div class="_tmpl" data-url="edit.html" data-attr="sdcurrpd.json"
			data-bind="editOnBind" data-param=""></div>
		<div class="layui-btn-div" id="layui-btn-fixed">
			<div class="ystep4"></div>
			<button class="layui-btn bgc1 layui-btn-mini" lay-submit lay-filter="edit"
				id="editButton">确定</button>
			<!-- <button class="layui-btn layui-btn-mini layui-btn-normal"
				onclick="check()">校验</button> -->
			<button class="layui-btn layui-btn-primary layui-btn-mini"
				onclick="parent.layer.close(parent.layer.getFrameIndex(window.name));">取消</button>
		</div>
	</div>
</body>
<link type="include" href="/common/depjs.html" />
<script type="text/javascript" src="/js/util/ystep.js"></script>
<script>
$(document).ready(function() {
	
	$("#editButton").click(function(){
		check();
	})
});
	var id = window.location.hash.replace("#", "");
	function editOnBind(attrs, param) {
		tmpl = this;
		tmpl.bind(function(callback) {
			var _this = this;
			if (id) {
				var url = Const.apiUrl + "/sdcurrpdList/get";
				var _this = this;
				View.get(url, "id=" + id, function(resp) {
					var data = {};
					if (resp) {
						data.data = resp;
					}
					//默认展开分组 ，不配置默认展开第一个分组
					data.showGroup = "base";
					callback.call(_this, data);
					TmplUtils.editOnLoad();
				}, function() {
					TmplUtils.showMsgFail('汇率信息获取失败');
				});
			} else {
				var data = {};
				data.showGroup = "base";
				callback.call(_this, data);
				TmplUtils.editOnLoad();
			}
		})
	}

	//自定义前段校验规则，可以多个
	TmplUtils.verify.desc = function(value) {
		if (value.length < 5) {
			return '描述至少得5个字符啊';
		}
	}

	function check() {
		var sdcurrpd = Utils.formToObj("edit");
		var editForms = $("form[name=edit]");
		var url = Const.apiUrl + "/sdcurrpdList/check";
		View.post(url, sdcurrpd, function(resp) {
			var data;
			if (!!resp) {
				data = resp.split(",");
			}
			var ht = "";
			if (!data) {
				edit(sdcurrpd);
				editForms.find("input").removeClass("yzts");
			} else {
				editForms.find("input").removeClass("yzts");
				var count = 0;
				for ( var i in data) {
					if(!data[i]){
						continue;
					}
					count++;
					var need = data[i].split(":")[1];
					var name = data[i].split(":")[0];
					ht += "<p>" + count + "、" + need + "</p>"
					var obj = document.getElementsByName(name);
					if(obj.length<=0){
						obj = $("input[name^='"+name+"']").parent();
						if(obj.length<=0){
							obj = $("select[name^='"+name+"']").parent();
						}
					}
					//group展开
					if($(obj)){
						$(obj).closest(".layui-colla-content").addClass("layui-show");
					}else{
						obj.closest(".layui-colla-content").addClass("layui-show");
					}
		            //错误tips
					yzTips(name,obj[0],need);
				}
				top.layer.open({
					content : ht,
					btn : [ '关闭' ],
					yes : function(index, layero) {
						top.layer.closeAll();
					},
					cancel : function() {
					}
				});
			}
		}, function(code) {
			TmplUtils.showMsgFail('编辑失败');
		});
	}
	//编辑保存
	function edit(sdcurrpd) {
		var url = Const.apiUrl + "/sdcurrpdList/addOrUpdate";
		View.post(url, sdcurrpd, function(resp) {
			
			TmplUtils.showMsgSuccess('编辑成功');
			
			parent.tbTmpl.refresh("pindex=" + (parent.TmplUtils.currPage - 1)
					+ "&pcount=" + parent.TmplUtils.pageSize
					+ parent.TmplUtils.searchParam);
			parent.previewTmpl.refresh();
			setTimeout(function(){
				var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
				parent.layer.close(index);
			},1000);
		}, function(code) {
			TmplUtils.showMsgFail('编辑失败');
		});
	}
 
	function showTips(obj,need){
		obj.focus(function(){
			$(".layui-layer-tips").hide();
			layer.tips(need, this,{
				tips: [2, '#f00'],
				  time: 1000000
			});
		});
		obj.blur(function(){
			$(".layui-layer-tips").hide();
			$(".layui-layer-tips").attr("showtime",3000);
		});
	}
	function yzTips(name,obj,need){
		if(obj.tagName=="SELECT"){
			$(obj).parent().find("input").addClass('yzts');
			showTips($(obj).parent().find("input"),need);
		}else if(obj.tagName == "INPUT"){
			$(obj).addClass('yzts');
			showTips($(obj), need);
		}else{
			$(obj).addClass('yzts');
			showTips($(obj).find('input'), need);
		}
	}	
 
</script>
</html>